if _G._FlowKill then pcall(_G._FlowKill) end

--[[
    FLOW ‚Ä¢ R·ªíNG VI·ªÜT v5.1 - FULLY WORKING VERSION
    Fixed: ESP, Hitbox, Wall Check, Weapon Detection
]]

-- SERVICES
local Players = game:GetService("Players")
local RS = game:GetService("RunService")
local TS = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Teams = game:GetService("Teams")
local UIS = game:GetService("UserInputService")
local CS = game:GetService("CollectionService")
local LP = Players.LocalPlayer
local Cam = workspace.CurrentCamera

-- CLEANUP
for _, n in ipairs({"Flow_Loading", "Flow_VN_v5", "Flow_VN_v51", "Elysium_VR"}) do
    local f = CoreGui:FindFirstChild(n)
    if f then f:Destroy() end
end

-- MATH
local V3, CF, C3, UD2 = Vector3.new, CFrame.new, Color3.fromRGB, UDim2.new
local sin, cos, abs, min, max, floor, clamp = math.sin, math.cos, math.abs, math.min, math.max, math.floor, math.clamp
local rad = math.rad

-- TWEEN
local function TI(t, s, d) return TweenInfo.new(t or 0.25, s or Enum.EasingStyle.Quint, d or Enum.EasingDirection.Out) end
local function Tw(o, p, t) pcall(function() TS:Create(o, TI(t), p):Play() end) end
local function TwBack(o, p, t) pcall(function() TS:Create(o, TweenInfo.new(t or 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), p):Play() end) end

-- LOADING SCREEN
do
    local L = Instance.new("ScreenGui", CoreGui)
    L.Name = "Flow_Loading"
    L.IgnoreGuiInset = true
    L.DisplayOrder = 9999

    local BG = Instance.new("Frame", L)
    BG.Size = UD2(1, 0, 1, 0)
    BG.BackgroundColor3 = C3(8, 3, 3)
    BG.BorderSizePixel = 0

    local Card = Instance.new("Frame", BG)
    Card.Size = UD2(0, 420, 0, 280)
    Card.Position = UD2(0.5, -210, 0.5, -140)
    Card.BackgroundColor3 = C3(18, 8, 8)
    Card.BorderSizePixel = 0
    Instance.new("UICorner", Card).CornerRadius = UDim.new(0, 20)
    Instance.new("UIStroke", Card).Color = C3(220, 40, 30)

    local Title = Instance.new("TextLabel", Card)
    Title.Size = UD2(1, 0, 0, 50)
    Title.Position = UD2(0, 0, 0, 20)
    Title.BackgroundTransparency = 1
    Title.Text = "‚òÖ FLOW ‚Ä¢ R·ªíNG VI·ªÜT v5.1 ‚òÖ"
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 24
    Title.TextColor3 = C3(255, 210, 0)

    local Sub = Instance.new("TextLabel", Card)
    Sub.Size = UD2(1, 0, 0, 25)
    Sub.Position = UD2(0, 0, 0, 70)
    Sub.BackgroundTransparency = 1
    Sub.Text = "WORKING VERSION - ESP + HITBOX + WALL"
    Sub.Font = Enum.Font.GothamBold
    Sub.TextSize = 12
    Sub.TextColor3 = C3(255, 180, 150)

    local BarBG = Instance.new("Frame", Card)
    BarBG.Size = UD2(0.8, 0, 0, 20)
    BarBG.Position = UD2(0.1, 0, 0, 120)
    BarBG.BackgroundColor3 = C3(30, 12, 12)
    BarBG.BorderSizePixel = 0
    Instance.new("UICorner", BarBG).CornerRadius = UDim.new(0, 10)

    local BarFill = Instance.new("Frame", BarBG)
    BarFill.Size = UD2(0, 0, 1, 0)
    BarFill.BackgroundColor3 = C3(220, 45, 35)
    BarFill.BorderSizePixel = 0
    Instance.new("UICorner", BarFill).CornerRadius = UDim.new(0, 10)
    Instance.new("UIGradient", BarFill).Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, C3(220, 50, 40)),
        ColorSequenceKeypoint.new(0.5, C3(255, 150, 50)),
        ColorSequenceKeypoint.new(1, C3(255, 210, 0))
    }

    local Status = Instance.new("TextLabel", Card)
    Status.Size = UD2(1, 0, 0, 20)
    Status.Position = UD2(0, 0, 0, 155)
    Status.BackgroundTransparency = 1
    Status.Font = Enum.Font.Gotham
    Status.TextSize = 12
    Status.TextColor3 = C3(200, 200, 200)
    Status.Text = "ƒêang kh·ªüi ƒë·ªông..."

    local Pct = Instance.new("TextLabel", Card)
    Pct.Size = UD2(1, 0, 0, 30)
    Pct.Position = UD2(0, 0, 0, 180)
    Pct.BackgroundTransparency = 1
    Pct.Font = Enum.Font.GothamBlack
    Pct.TextSize = 18
    Pct.TextColor3 = C3(255, 210, 0)
    Pct.Text = "0%"

    local Footer = Instance.new("TextLabel", Card)
    Footer.Size = UD2(1, 0, 0, 20)
    Footer.Position = UD2(0, 0, 1, -35)
    Footer.BackgroundTransparency = 1
    Footer.Text = "üáªüá≥ Vinh quang Vi·ªát Nam üáªüá≥"
    Footer.Font = Enum.Font.GothamMedium
    Footer.TextSize = 11
    Footer.TextColor3 = C3(180, 150, 130)

    local steps = {
        {p = 0, t = "Kh·ªüi ƒë·ªông h·ªá th·ªëng..."},
        {p = 20, t = "N·∫°p Weapon Classifier..."},
        {p = 40, t = "Kh·ªüi t·∫°o Zone Detection..."},
        {p = 60, t = "Build ESP Engine..."},
        {p = 80, t = "Setup Hitbox System..."},
        {p = 100, t = "‚úÖ Ho√†n t·∫•t!"},
    }

    task.spawn(function()
        for _, step in ipairs(steps) do
            Status.Text = step.t
            Pct.Text = step.p .. "%"
            Tw(BarFill, {Size = UD2(step.p / 100, 0, 1, 0)}, 0.3)
            task.wait(0.5)
        end
        task.wait(0.5)
        Tw(BG, {BackgroundTransparency = 1}, 0.4)
        Tw(Card, {BackgroundTransparency = 1}, 0.4)
        task.wait(0.5)
        L:Destroy()
    end)
end

task.wait(3.5)

-- THEME
local T = {
    R = C3(218, 37, 29),
    Y = C3(255, 203, 5),
    O = C3(255, 140, 0),
    OK = C3(34, 197, 94),
    D = C3(239, 68, 68),
    Tx = C3(252, 248, 244),
    Tm = C3(148, 118, 112),
    Purple = C3(180, 100, 255),
}

-- CONFIG - DEFAULT: T·∫§T C·∫¢ B·∫¨T
local Cfg = {
    TargetAll = true,  -- M·∫∂C ƒê·ªäNH B·∫¨T
    Team = {},
    HB = {On = true, Size = 15, Trans = 0.5, Wall = false, MaxD = 400},  -- M·∫∂C ƒê·ªäNH B·∫¨T
    ESP = {On = true, Fade = true, NearD = 50, FarD = 800, MaxD = 2000, HL = true, Name = true, Dist = true, HP = true, Wpn = true},  -- M·∫∂C ƒê·ªäNH B·∫¨T
}

-- STORAGE
local HeadBak = {}
local Shadows = {}
local HBViz = {}
local ESPViz = {}
local PData = {}
local HBState = {}
local Conns = {}
local VR = Instance.new("Folder", CoreGui)
VR.Name = "Elysium_VR"

-- WEAPON KEYWORDS
local WPN_NAMES = {"gun","pistol","rifle","shotgun","sniper","smg","ak","m4","m16","mp5","glock","deagle","sword","knife","blade","katana","axe","hammer","grenade","bomb","bow","crossbow","weapon","rpg","launcher"}
local WPN_PARTS = {"muzzle","barrel","trigger","magazine","scope","silencer"}
local WPN_SOUNDS = {"shoot","fire","gun","reload","shot","bang","blast"}
local WPN_EVENTS = {"fire","shoot","reload","aim","damage"}
local WPN_CACHE = {}

local function FastFind(tbl, str)
    str = str:lower()
    for _, k in ipairs(tbl) do
        if str:find(k, 1, true) then return true end
    end
    return false
end

local function AnalyzeTool(tool)
    if not tool or not tool:IsA("Tool") then return false, 0 end
    
    local cached = WPN_CACHE[tool]
    if cached and (tick() - cached.t) < 10 then
        return cached.isW, cached.sc
    end

    local name = tool.Name:lower()
    local score = 0

    -- Name check
    if FastFind(WPN_NAMES, name) then score = score + 40 end

    -- Descendants check
    local ok, descs = pcall(function() return tool:GetDescendants() end)
    if ok then
        for _, d in ipairs(descs) do
            local dn = d.Name:lower()
            if d:IsA("BasePart") or d:IsA("Attachment") then
                if FastFind(WPN_PARTS, dn) then score = score + 15 end
            elseif d:IsA("Sound") then
                if FastFind(WPN_SOUNDS, dn) then score = score + 15 end
            elseif d:IsA("RemoteEvent") or d:IsA("BindableEvent") then
                if FastFind(WPN_EVENTS, dn) then score = score + 10 end
            end
        end
    end

    -- Handle geometry
    local handle = tool:FindFirstChild("Handle")
    if handle and handle:IsA("BasePart") then
        local s = handle.Size
        local ratio = max(s.X, s.Y, s.Z) / max(min(s.X, s.Y, s.Z), 0.1)
        if ratio > 3 then score = score + 10 end
    end

    local isW = score >= 30
    WPN_CACHE[tool] = {isW = isW, sc = score, t = tick()}
    return isW, score
end

-- UTILITIES
local function MyRoot()
    local c = LP.Character
    return c and c:FindFirstChild("HumanoidRootPart")
end

local function GetDist(root)
    local mr = MyRoot()
    if not mr or not root then return 9999 end
    return (mr.Position - root.Position).Magnitude
end

local function HpColor(r)
    r = clamp(r, 0, 1)
    if r > 0.6 then return C3(34, 200, 80)
    elseif r > 0.3 then return C3(255, 165, 0)
    else return C3(220, 50, 50) end
end

-- VISIBILITY CHECK - SIMPLIFIED
local function CanSeeTarget(char)
    if not Cfg.HB.Wall then return true end
    
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return true end
    
    local myChar = LP.Character
    local camPos = Cam.CFrame.Position
    
    local filterList = {char, VR}
    if myChar then table.insert(filterList, myChar) end
    
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = filterList
    params.IgnoreWater = true
    
    local targetPos = root.Position
    local head = char:FindFirstChild("Head")
    
    -- Check multiple points
    local points = {targetPos, targetPos + V3(0, 2, 0), targetPos + V3(0, -1, 0)}
    if head then table.insert(points, head.Position) end
    
    for _, pt in ipairs(points) do
        local dir = pt - camPos
        local dist = dir.Magnitude
        if dist > 0 and dist < 1200 then
            local res = workspace:Raycast(camPos, dir.Unit * dist, params)
            if not res then return true end
            if res.Instance and res.Instance:IsDescendantOf(char) then return true end
            if res.Instance and res.Instance.Transparency >= 0.5 then return true end
        end
    end
    
    return false
end

-- SHOULD TARGET - SIMPLIFIED
local function ShouldTarget(player)
    if player == LP then return false end
    if Cfg.TargetAll then return true end
    
    local key = player.Team and player.Team.Name or "__N__"
    local d = Cfg.Team[key] or Cfg.Team["__N__"]
    if not d then return true end  -- Default target if no config
    if d.Mode == 0 then return false end
    return true
end

-- PLAYER DATA
local function GetPD(uid)
    if not PData[uid] then
        PData[uid] = {
            t = 0, alive = false, target = false,
            hbOn = false, espOn = false, inside = false,
            dist = 9999, canSee = true, lastSeen = tick()
        }
    end
    return PData[uid]
end

local function UpdatePD(player, now)
    local uid = player.UserId
    local pd = GetPD(uid)
    
    -- Rate limit
    local dt = pd.dist < 50 and 0.05 or pd.dist < 150 and 0.08 or 0.12
    if (now - pd.t) < dt then return pd, false end
    pd.t = now
    
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    pd.alive = char ~= nil and hum ~= nil and hum.Health > 0
    
    if not pd.alive then
        pd.target = false
        pd.hbOn = false
        pd.espOn = false
        return pd, true
    end
    
    local root = char:FindFirstChild("HumanoidRootPart")
    pd.dist = GetDist(root)
    pd.target = ShouldTarget(player)
    
    -- Visibility check
    if Cfg.HB.Wall then
        local canSee = CanSeeTarget(char)
        if canSee then
            pd.canSee = true
            pd.lastSeen = now
        else
            pd.canSee = (now - pd.lastSeen) < 1.0
        end
    else
        pd.canSee = true
    end
    
    pd.inside = root and pd.dist < (Cfg.HB.Size / 2 + 1)
    pd.hbOn = Cfg.HB.On and pd.target and pd.canSee and pd.dist <= Cfg.HB.MaxD
    pd.espOn = Cfg.ESP.On and pd.target and pd.dist <= Cfg.ESP.MaxD
    
    return pd, true
end

-- HITBOX FUNCTIONS
local function SaveHead(uid, head)
    if not HeadBak[uid] then
        HeadBak[uid] = {
            Size = head.Size,
            Trans = head.Transparency,
            CanCollide = head.CanCollide,
            CanQuery = head.CanQuery,
            Massless = head.Massless
        }
    end
end

local function RestoreHead(uid, head)
    local b = HeadBak[uid]
    if not b then return end
    pcall(function()
        head.Size = b.Size
        head.Transparency = b.Trans
        head.CanCollide = b.CanCollide
        head.CanQuery = b.CanQuery
        head.Massless = b.Massless
    end)
end

local function KillShadow(uid)
    if Shadows[uid] then
        pcall(function() Shadows[uid]:Destroy() end)
        Shadows[uid] = nil
    end
end

local function CreateShadow(player)
    local char = player.Character
    if not char then return end
    
    local uid = player.UserId
    if Shadows[uid] and Shadows[uid].Parent == char then return end
    
    KillShadow(uid)
    
    local shadow = Instance.new("Part")
    shadow.Name = "FlowShadow"
    shadow.Size = V3(Cfg.HB.Size, Cfg.HB.Size, Cfg.HB.Size)
    shadow.Transparency = 1
    shadow.CanCollide = false
    shadow.CanQuery = true
    shadow.CanTouch = false
    shadow.Anchored = false
    shadow.Massless = true
    shadow.CastShadow = false
    shadow.Parent = char
    
    Shadows[uid] = shadow
end

local function ApplyHitbox(player, pd)
    local char = player.Character
    if not char then return end
    
    local uid = player.UserId
    local head = char:FindFirstChild("Head")
    if not head then return end
    
    local wantState = "off"
    if pd.hbOn and pd.canSee then
        wantState = pd.inside and "shadow" or "expand"
    end
    
    if HBState[uid] == wantState then return end
    HBState[uid] = wantState
    
    if wantState == "expand" then
        KillShadow(uid)
        SaveHead(uid, head)
        pcall(function()
            head.Size = V3(Cfg.HB.Size, Cfg.HB.Size, Cfg.HB.Size)
            head.Transparency = 1
            head.CanCollide = false
            head.CanQuery = true
            head.Massless = true
        end)
    elseif wantState == "shadow" then
        local b = HeadBak[uid] or {}
        pcall(function()
            head.Size = b.Size or V3(2, 1, 1)
            head.Transparency = b.Trans or 0
        end)
        CreateShadow(player)
    else
        KillShadow(uid)
        RestoreHead(uid, head)
        HeadBak[uid] = nil
    end
end

local function UpdateShadows()
    local cf = Cam.CFrame
    local pos = cf.Position + cf.LookVector * 5
    
    for uid, shadow in pairs(Shadows) do
        if shadow and shadow.Parent then
            pcall(function()
                shadow.CFrame = CF(pos)
                shadow.Size = V3(Cfg.HB.Size, Cfg.HB.Size, Cfg.HB.Size)
                shadow.CanQuery = true
            end)
        end
    end
end

-- HITBOX VISUAL
local function EnsureHBVisual(uid)
    if HBViz[uid] and HBViz[uid].Parent then return HBViz[uid] end
    
    local folder = Instance.new("Folder", VR)
    folder.Name = "HB_" .. uid
    
    local box = Instance.new("SelectionBox", folder)
    box.Name = "Box"
    box.LineThickness = 0.04
    
    HBViz[uid] = folder
    return folder
end

local function UpdateHBVisual(player, pd)
    local uid = player.UserId
    
    if not pd.hbOn or not pd.alive then
        local folder = HBViz[uid]
        if folder then
            local box = folder:FindFirstChild("Box")
            if box then box.Adornee = nil end
        end
        return
    end
    
    local folder = EnsureHBVisual(uid)
    local box = folder:FindFirstChild("Box")
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local head = char and char:FindFirstChild("Head")
    
    if not box or not root then return end
    
    local color = pd.inside and T.OK or T.Y
    box.Adornee = pd.inside and root or head
    box.Color3 = color
    box.SurfaceColor3 = color
    box.SurfaceTransparency = Cfg.HB.Trans
end

-- ESP VISUAL
local function EnsureESPVisual(uid)
    if ESPViz[uid] and ESPViz[uid].Parent then return ESPViz[uid] end
    
    local folder = Instance.new("Folder", VR)
    folder.Name = "ESP_" .. uid
    
    local hl = Instance.new("Highlight", folder)
    hl.Name = "HL"
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Enabled = false
    
    local bg = Instance.new("BillboardGui", folder)
    bg.Name = "BG"
    bg.AlwaysOnTop = true
    bg.Size = UD2(0, 200, 0, 120)
    bg.StudsOffset = V3(0, 3, 0)
    bg.MaxDistance = 2500
    bg.Enabled = false
    
    local container = Instance.new("Frame", bg)
    container.Name = "Container"
    container.Size = UD2(1, 0, 1, 0)
    container.BackgroundTransparency = 1
    
    local layout = Instance.new("UIListLayout", container)
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Padding = UDim.new(0, 2)
    
    -- Name label
    local nameLabel = Instance.new("TextLabel", container)
    nameLabel.Name = "NameLabel"
    nameLabel.LayoutOrder = 1
    nameLabel.Size = UD2(1, 0, 0, 16)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextSize = 13
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = C3(0, 0, 0)
    nameLabel.RichText = true
    
    -- Weapon label
    local wpnLabel = Instance.new("TextLabel", container)
    wpnLabel.Name = "WpnLabel"
    wpnLabel.LayoutOrder = 2
    wpnLabel.Size = UD2(1, 0, 0, 14)
    wpnLabel.BackgroundTransparency = 1
    wpnLabel.Font = Enum.Font.GothamBold
    wpnLabel.TextSize = 11
    wpnLabel.TextStrokeTransparency = 0
    wpnLabel.TextStrokeColor3 = C3(0, 0, 0)
    wpnLabel.RichText = true
    
    -- Distance label
    local distLabel = Instance.new("TextLabel", container)
    distLabel.Name = "DistLabel"
    distLabel.LayoutOrder = 3
    distLabel.Size = UD2(1, 0, 0, 14)
    distLabel.BackgroundTransparency = 1
    distLabel.Font = Enum.Font.GothamBold
    distLabel.TextSize = 12
    distLabel.TextStrokeTransparency = 0
    distLabel.TextStrokeColor3 = C3(0, 0, 0)
    
    -- HP label
    local hpLabel = Instance.new("TextLabel", container)
    hpLabel.Name = "HPLabel"
    hpLabel.LayoutOrder = 4
    hpLabel.Size = UD2(1, 0, 0, 12)
    hpLabel.BackgroundTransparency = 1
    hpLabel.Font = Enum.Font.GothamBold
    hpLabel.TextSize = 11
    hpLabel.TextStrokeTransparency = 0
    hpLabel.TextStrokeColor3 = C3(0, 0, 0)
    hpLabel.RichText = true
    
    -- HP Bar
    local hpBarBg = Instance.new("Frame", container)
    hpBarBg.Name = "HPBarBg"
    hpBarBg.LayoutOrder = 5
    hpBarBg.Size = UD2(0.8, 0, 0, 6)
    hpBarBg.BackgroundColor3 = C3(30, 10, 10)
    hpBarBg.BorderSizePixel = 0
    Instance.new("UICorner", hpBarBg).CornerRadius = UDim.new(1, 0)
    
    local hpBarFill = Instance.new("Frame", hpBarBg)
    hpBarFill.Name = "HPBarFill"
    hpBarFill.Size = UD2(1, 0, 1, 0)
    hpBarFill.BackgroundColor3 = T.OK
    hpBarFill.BorderSizePixel = 0
    Instance.new("UICorner", hpBarFill).CornerRadius = UDim.new(1, 0)
    
    ESPViz[uid] = folder
    return folder
end

local function UpdateESPVisual(player, pd)
    local uid = player.UserId
    
    if not pd.espOn or not pd.alive then
        local folder = ESPViz[uid]
        if folder then
            local hl = folder:FindFirstChild("HL")
            local bg = folder:FindFirstChild("BG")
            if hl then hl.Enabled = false end
            if bg then bg.Enabled = false end
        end
        return
    end
    
    local folder = EnsureESPVisual(uid)
    local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    
    if not root or not hum then return end
    
    local dist = pd.dist
    local fade = Cfg.ESP.Fade and clamp((dist - Cfg.ESP.NearD) / max(Cfg.ESP.FarD - Cfg.ESP.NearD, 1), 0, 1) or 0
    
    local hp = hum.Health
    local maxHP = max(hum.MaxHealth, 1)
    local hpRatio = clamp(hp / maxHP, 0, 1)
    local hpCol = HpColor(hpRatio)
    
    local baseColor = T.Y
    
    -- Highlight
    local hl = folder:FindFirstChild("HL")
    if hl and Cfg.ESP.HL then
        hl.Enabled = true
        hl.Adornee = char
        hl.FillColor = pd.inside and T.OK or baseColor
        hl.OutlineColor = T.Y
        hl.FillTransparency = max(0.15, fade * 0.7)
        hl.OutlineTransparency = fade * 0.5
    elseif hl then
        hl.Enabled = false
    end
    
    -- Billboard
    local bg = folder:FindFirstChild("BG")
    if bg then
        bg.Adornee = root
        bg.Enabled = true
    end
    
    local container = bg and bg:FindFirstChild("Container")
    if not container then return end
    
    local tf = max(fade * 0.5, 0.1)
    
    -- Name
    local nameLabel = container:FindFirstChild("NameLabel")
    if nameLabel and Cfg.ESP.Name then
        nameLabel.Text = "<b>" .. player.Name .. "</b>"
        nameLabel.TextColor3 = baseColor
        nameLabel.TextTransparency = tf
        nameLabel.Visible = true
    elseif nameLabel then
        nameLabel.Visible = false
    end
    
    -- Weapon
    local wpnLabel = container:FindFirstChild("WpnLabel")
    if wpnLabel and Cfg.ESP.Wpn then
        local tool = char:FindFirstChildOfClass("Tool")
        if tool then
            local isW, wsc = AnalyzeTool(tool)
            if isW then
                wpnLabel.Text = "üî´ " .. tool.Name .. " [" .. wsc .. "]"
                wpnLabel.TextColor3 = T.O
            else
                wpnLabel.Text = "üéí " .. tool.Name
                wpnLabel.TextColor3 = T.Tm
            end
            wpnLabel.TextTransparency = tf
            wpnLabel.Visible = true
        else
            wpnLabel.Visible = false
        end
    elseif wpnLabel then
        wpnLabel.Visible = false
    end
    
    -- Distance
    local distLabel = container:FindFirstChild("DistLabel")
    if distLabel and Cfg.ESP.Dist then
        local distColor = T.OK:Lerp(T.D, clamp(dist / Cfg.ESP.MaxD, 0, 1))
        distLabel.Text = string.format("%.0f m", dist)
        distLabel.TextColor3 = distColor
        distLabel.TextTransparency = tf
        distLabel.Visible = true
    elseif distLabel then
        distLabel.Visible = false
    end
    
    -- HP
    local hpLabel = container:FindFirstChild("HPLabel")
    if hpLabel and Cfg.ESP.HP then
        hpLabel.Text = string.format('<font color="#%02X%02X%02X">%.0f / %.0f HP</font>',
            floor(hpCol.R * 255), floor(hpCol.G * 255), floor(hpCol.B * 255), hp, maxHP)
        hpLabel.TextTransparency = tf
        hpLabel.Visible = true
    elseif hpLabel then
        hpLabel.Visible = false
    end
    
    -- HP Bar
    local hpBarBg = container:FindFirstChild("HPBarBg")
    local hpBarFill = hpBarBg and hpBarBg:FindFirstChild("HPBarFill")
    if hpBarBg and Cfg.ESP.HP then
        hpBarBg.Visible = true
        if hpBarFill then
            hpBarFill.Size = UD2(hpRatio, 0, 1, 0)
            hpBarFill.BackgroundColor3 = hpCol
        end
    elseif hpBarBg then
        hpBarBg.Visible = false
    end
end

-- CLEANUP
local function FullCleanup(player)
    local uid = player.UserId
    KillShadow(uid)
    HBState[uid] = nil
    
    local char = player.Character
    if char then
        local head = char:FindFirstChild("Head")
        if head then RestoreHead(uid, head) end
    end
    
    HeadBak[uid] = nil
    PData[uid] = nil
end

local function HideVisuals(uid)
    local hbFolder = HBViz[uid]
    if hbFolder then
        local box = hbFolder:FindFirstChild("Box")
        if box then box.Adornee = nil end
    end
    
    local espFolder = ESPViz[uid]
    if espFolder then
        local hl = espFolder:FindFirstChild("HL")
        local bg = espFolder:FindFirstChild("BG")
        if hl then hl.Enabled = false end
        if bg then bg.Enabled = false end
    end
end

-- HOOKS
local function HookPlayer(player)
    table.insert(Conns, player.CharacterAdded:Connect(function()
        local uid = player.UserId
        HeadBak[uid] = nil
        HBState[uid] = nil
        KillShadow(uid)
        HideVisuals(uid)
        WPN_CACHE = {}
        local pd = GetPD(uid)
        pd.t = 0
        pd.lastSeen = tick()
        pd.canSee = true
    end))
    
    table.insert(Conns, player.CharacterRemoving:Connect(function()
        FullCleanup(player)
    end))
end

local function SyncTeams()
    for _, team in ipairs(Teams:GetChildren()) do
        if team:IsA("Team") and not Cfg.Team[team.Name] then
            Cfg.Team[team.Name] = {Mode = 1, Color = team.TeamColor.Color}
        end
    end
    Cfg.Team["__N__"] = Cfg.Team["__N__"] or {Mode = 1, Color = Color3.new(1, 1, 1)}
end

SyncTeams()
table.insert(Conns, Teams.ChildAdded:Connect(SyncTeams))

for _, player in ipairs(Players:GetPlayers()) do
    HookPlayer(player)
end

table.insert(Conns, Players.PlayerAdded:Connect(HookPlayer))
table.insert(Conns, Players.PlayerRemoving:Connect(function(player)
    FullCleanup(player)
    local uid = player.UserId
    if HBViz[uid] then
        pcall(function() HBViz[uid]:Destroy() end)
        HBViz[uid] = nil
    end
    if ESPViz[uid] then
        pcall(function() ESPViz[uid]:Destroy() end)
        ESPViz[uid] = nil
    end
end))

-- FORCE RECALC
local function ForceRecalc()
    local now = tick()
    for uid, pd in pairs(PData) do
        pd.t = 0
        pd.lastSeen = now
        pd.canSee = true
        HBState[uid] = nil
    end
    WPN_CACHE = {}
end

-- UI
local function BuildUI()
    local Gui = Instance.new("ScreenGui", CoreGui)
    Gui.Name = "Flow_VN_v51"
    Gui.ResetOnSpawn = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.DisplayOrder = 100

    local Main = Instance.new("Frame", Gui)
    Main.Name = "Main"
    Main.Size = UD2(0, 320, 0, 450)
    Main.Position = UD2(0.5, -160, 0.5, -225)
    Main.BackgroundColor3 = C3(12, 6, 6)
    Main.BorderSizePixel = 0
    Main.Active = true
    Main.Draggable = true
    Main.ClipsDescendants = true
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 14)
    Instance.new("UIStroke", Main).Color = T.R

    -- Header
    local Header = Instance.new("Frame", Main)
    Header.Size = UD2(1, 0, 0, 45)
    Header.BackgroundColor3 = T.R
    Header.BorderSizePixel = 0
    Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 14)
    
    local HeaderFix = Instance.new("Frame", Header)
    HeaderFix.Size = UD2(1, 0, 0, 15)
    HeaderFix.Position = UD2(0, 0, 1, -15)
    HeaderFix.BackgroundColor3 = T.R
    HeaderFix.BorderSizePixel = 0

    local Title = Instance.new("TextLabel", Header)
    Title.Size = UD2(1, -50, 1, 0)
    Title.Position = UD2(0, 12, 0, 0)
    Title.BackgroundTransparency = 1
    Title.Text = "‚òÖ FLOW v5.1"
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 16
    Title.TextColor3 = T.Y
    Title.TextXAlignment = Enum.TextXAlignment.Left

    local CloseBtn = Instance.new("TextButton", Header)
    CloseBtn.Size = UD2(0, 28, 0, 28)
    CloseBtn.Position = UD2(1, -36, 0.5, -14)
    CloseBtn.Text = "‚úï"
    CloseBtn.TextColor3 = T.Y
    CloseBtn.Font = Enum.Font.GothamBold
    CloseBtn.TextSize = 14
    CloseBtn.BackgroundColor3 = C3(150, 30, 25)
    CloseBtn.BorderSizePixel = 0
    CloseBtn.AutoButtonColor = false
    Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 8)
    CloseBtn.MouseButton1Click:Connect(function()
        Main.Visible = false
    end)

    -- Scroll
    local Scroll = Instance.new("ScrollingFrame", Main)
    Scroll.Size = UD2(1, -12, 1, -90)
    Scroll.Position = UD2(0, 6, 0, 52)
    Scroll.BackgroundTransparency = 1
    Scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Scroll.ScrollBarThickness = 4
    Scroll.ScrollBarImageColor3 = T.R
    Scroll.BorderSizePixel = 0
    Scroll.CanvasSize = UD2(0, 0, 0, 0)

    local Layout = Instance.new("UIListLayout", Scroll)
    Layout.Padding = UDim.new(0, 5)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder

    Instance.new("UIPadding", Scroll).PaddingTop = UDim.new(0, 4)

    -- Component builders
    local function Card(h)
        local f = Instance.new("Frame", Scroll)
        f.Size = UD2(1, -6, 0, h or 38)
        f.BackgroundColor3 = C3(22, 10, 10)
        f.BackgroundTransparency = 0.15
        f.BorderSizePixel = 0
        Instance.new("UICorner", f).CornerRadius = UDim.new(0, 10)
        return f
    end

    local function Section(txt)
        local f = Card(26)
        f.BackgroundColor3 = C3(60, 20, 18)
        local l = Instance.new("TextLabel", f)
        l.Size = UD2(1, -16, 1, 0)
        l.Position = UD2(0, 8, 0, 0)
        l.BackgroundTransparency = 1
        l.Text = txt
        l.Font = Enum.Font.GothamBold
        l.TextSize = 11
        l.TextColor3 = T.Y
        l.TextXAlignment = Enum.TextXAlignment.Left
    end

    local function Toggle(label, value, callback, color)
        color = color or T.R
        local f = Card(40)
        
        local txt = Instance.new("TextLabel", f)
        txt.Size = UD2(1, -65, 1, 0)
        txt.Position = UD2(0, 10, 0, 0)
        txt.BackgroundTransparency = 1
        txt.Text = label
        txt.Font = Enum.Font.Gotham
        txt.TextSize = 12
        txt.TextColor3 = value and T.Tx or T.Tm
        txt.TextXAlignment = Enum.TextXAlignment.Left

        local track = Instance.new("Frame", f)
        track.Size = UD2(0, 44, 0, 22)
        track.Position = UD2(1, -52, 0.5, -11)
        track.BackgroundColor3 = value and color or C3(50, 35, 35)
        track.BorderSizePixel = 0
        Instance.new("UICorner", track).CornerRadius = UDim.new(1, 0)

        local thumb = Instance.new("Frame", track)
        thumb.Size = UD2(0, 16, 0, 16)
        thumb.Position = value and UD2(1, -19, 0.5, -8) or UD2(0, 3, 0.5, -8)
        thumb.BackgroundColor3 = value and Color3.new(1, 1, 1) or C3(150, 130, 130)
        thumb.BorderSizePixel = 0
        Instance.new("UICorner", thumb).CornerRadius = UDim.new(1, 0)

        local on = value
        local btn = Instance.new("TextButton", f)
        btn.Size = UD2(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text = ""
        btn.ZIndex = 5

        btn.MouseButton1Click:Connect(function()
            on = not on
            TwBack(track, {BackgroundColor3 = on and color or C3(50, 35, 35)}, 0.2)
            TwBack(thumb, {
                Position = on and UD2(1, -19, 0.5, -8) or UD2(0, 3, 0.5, -8),
                BackgroundColor3 = on and Color3.new(1, 1, 1) or C3(150, 130, 130)
            }, 0.2)
            Tw(txt, {TextColor3 = on and T.Tx or T.Tm}, 0.15)
            callback(on)
        end)
    end

    local function Slider(label, minVal, maxVal, defaultVal, decimals, callback)
        local f = Card(52)
        
        local txt = Instance.new("TextLabel", f)
        txt.Size = UD2(0.65, 0, 0, 20)
        txt.Position = UD2(0, 10, 0, 4)
        txt.BackgroundTransparency = 1
        txt.Text = label
        txt.Font = Enum.Font.Gotham
        txt.TextSize = 11
        txt.TextColor3 = T.Tm
        txt.TextXAlignment = Enum.TextXAlignment.Left

        local valTxt = Instance.new("TextLabel", f)
        valTxt.Size = UD2(0.3, 0, 0, 20)
        valTxt.Position = UD2(0.68, 0, 0, 4)
        valTxt.BackgroundTransparency = 1
        valTxt.Text = tostring(defaultVal)
        valTxt.Font = Enum.Font.GothamBold
        valTxt.TextSize = 12
        valTxt.TextColor3 = T.Y
        valTxt.TextXAlignment = Enum.TextXAlignment.Right

        local trackBg = Instance.new("Frame", f)
        trackBg.Size = UD2(1, -20, 0, 8)
        trackBg.Position = UD2(0, 10, 0, 32)
        trackBg.BackgroundColor3 = C3(40, 18, 18)
        trackBg.BorderSizePixel = 0
        Instance.new("UICorner", trackBg).CornerRadius = UDim.new(1, 0)

        local fill = Instance.new("Frame", trackBg)
        fill.Size = UD2((defaultVal - minVal) / max(maxVal - minVal, 1), 0, 1, 0)
        fill.BackgroundColor3 = T.R
        fill.BorderSizePixel = 0
        Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
        Instance.new("UIGradient", fill).Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, T.R),
            ColorSequenceKeypoint.new(0.6, T.O),
            ColorSequenceKeypoint.new(1, T.Y)
        }

        local thumbBtn = Instance.new("TextButton", trackBg)
        thumbBtn.Size = UD2(0, 16, 0, 16)
        thumbBtn.Position = UD2((defaultVal - minVal) / max(maxVal - minVal, 1), -8, 0.5, -8)
        thumbBtn.BackgroundColor3 = T.Y
        thumbBtn.Text = ""
        thumbBtn.BorderSizePixel = 0
        thumbBtn.ZIndex = 5
        Instance.new("UICorner", thumbBtn).CornerRadius = UDim.new(1, 0)

        local precision = 10 ^ decimals
        local dragging = false

        local function update(inputX)
            local trackWidth = trackBg.AbsoluteSize.X
            if trackWidth <= 0 then return end
            local rel = clamp((inputX - trackBg.AbsolutePosition.X) / trackWidth, 0, 1)
            local val = floor((minVal + (maxVal - minVal) * rel) * precision + 0.5) / precision
            Tw(fill, {Size = UD2(rel, 0, 1, 0)}, 0.08)
            Tw(thumbBtn, {Position = UD2(rel, -8, 0.5, -8)}, 0.08)
            valTxt.Text = tostring(val)
            callback(val)
        end

        thumbBtn.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
            end
        end)

        trackBg.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                update(input.Position.X)
            end
        end)

        UIS.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                update(input.Position.X)
            end
        end)

        UIS.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = false
            end
        end)
    end

    -- BUILD UI
    Section("üéØ M·ª§C TI√äU")
    Toggle("Nh·∫Øm t·∫•t c·∫£ ng∆∞·ªùi ch∆°i", Cfg.TargetAll, function(v)
        Cfg.TargetAll = v
        ForceRecalc()
    end, T.D)

    Section("üì¶ HITBOX")
    Toggle("B·∫≠t Hitbox Expander", Cfg.HB.On, function(v)
        Cfg.HB.On = v
        ForceRecalc()
    end)
    Toggle("Ki·ªÉm tra t∆∞·ªùng (Wall Check)", Cfg.HB.Wall, function(v)
        Cfg.HB.Wall = v
        ForceRecalc()
    end)
    Slider("K√≠ch th∆∞·ªõc (Studs)", 1, 50, Cfg.HB.Size, 0, function(v)
        Cfg.HB.Size = v
    end)
    Slider("ƒê·ªô trong su·ªët", 0, 1, Cfg.HB.Trans, 2, function(v)
        Cfg.HB.Trans = v
    end)
    Slider("Kho·∫£ng c√°ch t·ªëi ƒëa", 50, 600, Cfg.HB.MaxD, 0, function(v)
        Cfg.HB.MaxD = v
        ForceRecalc()
    end)

    Section("üëÅ ESP")
    Toggle("B·∫≠t ESP xuy√™n t∆∞·ªùng", Cfg.ESP.On, function(v)
        Cfg.ESP.On = v
        ForceRecalc()
    end)
    Toggle("M·ªù d·∫ßn theo kho·∫£ng c√°ch", Cfg.ESP.Fade, function(v)
        Cfg.ESP.Fade = v
    end)
    Toggle("Highlight vi·ªÅn ng∆∞·ªùi", Cfg.ESP.HL, function(v)
        Cfg.ESP.HL = v
    end, T.Y)
    Toggle("Hi·ªán t√™n ng∆∞·ªùi ch∆°i", Cfg.ESP.Name, function(v)
        Cfg.ESP.Name = v
    end, T.OK)
    Toggle("Hi·ªán v≈© kh√≠ ƒëang c·∫ßm", Cfg.ESP.Wpn, function(v)
        Cfg.ESP.Wpn = v
    end, T.O)
    Toggle("Hi·ªán kho·∫£ng c√°ch", Cfg.ESP.Dist, function(v)
        Cfg.ESP.Dist = v
    end)
    Toggle("Hi·ªán HP + thanh m√°u", Cfg.ESP.HP, function(v)
        Cfg.ESP.HP = v
    end, T.D)
    Slider("KC t·ªëi ƒëa ESP", 100, 3000, Cfg.ESP.MaxD, 0, function(v)
        Cfg.ESP.MaxD = v
        ForceRecalc()
    end)

    -- Team controls
    Section("‚öô TEAM CONTROLS")
    local modeLabels = {[0] = "T·∫ÆT", [1] = "B·∫¨T", [2] = "T·∫§T C·∫¢"}
    local modeColors = {[0] = C3(60, 45, 45), [1] = T.OK, [2] = T.O}
    
    for teamName, teamData in pairs(Cfg.Team) do
        local displayName = teamName == "__N__" and "Kh√¥ng Team" or teamName
        local f = Card(36)
        
        local nl = Instance.new("TextLabel", f)
        nl.Size = UD2(0.55, 0, 1, 0)
        nl.Position = UD2(0, 10, 0, 0)
        nl.BackgroundTransparency = 1
        nl.Text = displayName
        nl.Font = Enum.Font.Gotham
        nl.TextSize = 11
        nl.TextColor3 = T.Tx
        nl.TextXAlignment = Enum.TextXAlignment.Left

        local modeBtn = Instance.new("TextButton", f)
        modeBtn.Size = UD2(0, 70, 0, 24)
        modeBtn.Position = UD2(1, -78, 0.5, -12)
        modeBtn.Text = modeLabels[teamData.Mode]
        modeBtn.TextColor3 = Color3.new(1, 1, 1)
        modeBtn.Font = Enum.Font.GothamBold
        modeBtn.TextSize = 10
        modeBtn.BackgroundColor3 = modeColors[teamData.Mode]
        modeBtn.BorderSizePixel = 0
        modeBtn.AutoButtonColor = false
        Instance.new("UICorner", modeBtn).CornerRadius = UDim.new(0, 7)

        modeBtn.MouseButton1Click:Connect(function()
            teamData.Mode = (teamData.Mode + 1) % 3
            modeBtn.Text = modeLabels[teamData.Mode]
            TwBack(modeBtn, {BackgroundColor3 = modeColors[teamData.Mode]}, 0.2)
            ForceRecalc()
        end)
    end

    -- Status bar
    local StatusBar = Instance.new("Frame", Main)
    StatusBar.Size = UD2(1, -12, 0, 26)
    StatusBar.Position = UD2(0, 6, 1, -32)
    StatusBar.BackgroundColor3 = C3(18, 8, 8)
    StatusBar.BorderSizePixel = 0
    Instance.new("UICorner", StatusBar).CornerRadius = UDim.new(0, 8)

    local StatusLabel = Instance.new("TextLabel", StatusBar)
    StatusLabel.Size = UD2(1, -12, 1, 0)
    StatusLabel.Position = UD2(0, 6, 0, 0)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "üáªüá≥ FLOW v5.1 Working"
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.TextSize = 10
    StatusLabel.TextColor3 = T.Tm
    StatusLabel.TextXAlignment = Enum.TextXAlignment.Left

    -- Float button
    local FloatBtn = Instance.new("TextButton", Gui)
    FloatBtn.Size = UD2(0, 50, 0, 50)
    FloatBtn.Position = UD2(0, 10, 0.4, 0)
    FloatBtn.BackgroundColor3 = T.R
    FloatBtn.Text = "‚òÖ"
    FloatBtn.TextColor3 = T.Y
    FloatBtn.Font = Enum.Font.GothamBlack
    FloatBtn.TextSize = 24
    FloatBtn.BorderSizePixel = 0
    FloatBtn.ZIndex = 50
    FloatBtn.AutoButtonColor = false
    Instance.new("UICorner", FloatBtn).CornerRadius = UDim.new(1, 0)
    local floatStroke = Instance.new("UIStroke", FloatBtn)
    floatStroke.Color = T.Y
    floatStroke.Thickness = 2

    -- Float button drag + click
    local dragging = false
    local dragStart, startPos

    FloatBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = FloatBtn.Position
        end
    end)

    FloatBtn.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            FloatBtn.Position = UD2(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    FloatBtn.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if dragStart then
                local delta = input.Position - dragStart
                if abs(delta.X) < 8 and abs(delta.Y) < 8 then
                    Main.Visible = not Main.Visible
                end
            end
            dragging = false
        end
    end)

    -- Keyboard shortcut
    table.insert(Conns, UIS.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Enum.KeyCode.RightControl or input.KeyCode == Enum.KeyCode.F6 then
            Main.Visible = not Main.Visible
        end
    end))

    -- Float button animation
    task.spawn(function()
        local big = true
        while FloatBtn.Parent do
            if big then
                TwBack(FloatBtn, {TextSize = 28}, 0.8)
                TwBack(floatStroke, {Thickness = 3}, 0.8)
            else
                TwBack(FloatBtn, {TextSize = 24}, 0.8)
                TwBack(floatStroke, {Thickness = 2}, 0.8)
            end
            big = not big
            task.wait(1)
        end
    end)

    return StatusLabel
end

local StatusLabel = BuildUI()

-- MAIN LOOP
local frameCount = 0
local fpsSmooth = 60
local lastFrameTime = tick()

local heartbeatConnection = RS.Heartbeat:Connect(function()
    local now = tick()
    local dt = now - lastFrameTime
    lastFrameTime = now
    fpsSmooth = fpsSmooth * 0.9 + (1 / max(dt, 0.001)) * 0.1

    frameCount = frameCount + 1
    UpdateShadows()

    -- Skip frames for performance
    if frameCount % 2 ~= 0 then return end

    local allPlayers = Players:GetPlayers()
    local targetPlayers = {}
    
    for _, player in ipairs(allPlayers) do
        if player ~= LP then
            table.insert(targetPlayers, player)
        end
    end

    -- Sort by distance every 10 frames
    if frameCount % 10 == 0 then
        table.sort(targetPlayers, function(a, b)
            local pdA = PData[a.UserId]
            local pdB = PData[b.UserId]
            return (pdA and pdA.dist or 9999) < (pdB and pdB.dist or 9999)
        end)
    end

    -- Process players
    local budget = min(#targetPlayers, fpsSmooth > 45 and 10 or fpsSmooth > 30 and 6 or 4)
    local targetCount = 0

    for i = 1, budget do
        local player = targetPlayers[i]
        if not player then continue end
        
        local pd, updated = UpdatePD(player, now)
        
        if not pd.alive then
            HideVisuals(player.UserId)
            continue
        end

        if updated then
            ApplyHitbox(player, pd)
            UpdateHBVisual(player, pd)
            UpdateESPVisual(player, pd)
        end

        if pd.target then
            targetCount = targetCount + 1
        end
    end

    -- Update status every 30 frames
    if frameCount % 30 == 0 and StatusLabel and StatusLabel.Parent then
        local features = {}
        if Cfg.HB.On then table.insert(features, "HB") end
        if Cfg.ESP.On then table.insert(features, "ESP") end
        if Cfg.HB.Wall then table.insert(features, "WALL") end
        
        local featureStr = #features > 0 and table.concat(features, "¬∑") or "OFF"
        StatusLabel.Text = string.format("üáªüá≥ %s | Targets: %d | FPS: %.0f", featureStr, targetCount, fpsSmooth)
        StatusLabel.TextColor3 = targetCount > 0 and T.Y or T.Tm
    end
end)

table.insert(Conns, heartbeatConnection)

-- KILL SWITCH
_G._FlowKill = function()
    for _, conn in ipairs(Conns) do
        pcall(function() conn:Disconnect() end)
    end
    Conns = {}

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LP then
            FullCleanup(player)
        end
    end

    if VR and VR.Parent then VR:Destroy() end
    
    local gui = CoreGui:FindFirstChild("Flow_VN_v51")
    if gui then gui:Destroy() end
    
    WPN_CACHE = {}
    
    print("[FLOW v5.1] ‚úÖ Cleanup ho√†n t·∫•t. Vinh quang Vi·ªát Nam! üáªüá≥")
end

print("[FLOW v5.1] ‚úÖ WORKING! ESP + Hitbox ƒëang ho·∫°t ƒë·ªông! üáªüá≥")
print("[FLOW v5.1] üìå M·∫∑c ƒë·ªãnh: ESP + Hitbox + Target All = B·∫¨T")
print("[FLOW v5.1] üìå Ph√≠m t·∫Øt: RCtrl ho·∫∑c F6 ƒë·ªÉ ·∫©n/hi·ªán menu")
