if _G._FlowKill then pcall(_G._FlowKill) end

--[[
    â˜… FLOW v6.5 â€” REWRITE HOÃ€N TOÃ€N â˜…
    â˜… FIX: Hitbox Resize Tháº­t + Zone Spatial + Weapon â˜…
    â˜… ğŸ‡»ğŸ‡³ Há»’NG LONG VIá»†T NAM ğŸ‰ â˜…

    CHANGELOG v6.5:
    [FIX] Hitbox: Resize TRá»°C TIáº¾P parts cá»§a enemy (HRP, Torso, Head...)
          â†’ KhÃ´ng cÃ²n táº¡o Part fake bÃªn ngoÃ i character
          â†’ Weapon/raycast cá»§a game sáº½ hit Ä‘Ãºng
    [FIX] Hitbox: Restore size gá»‘c khi táº¯t, khi player cháº¿t, khi rá»i game
    [FIX] Zone: ThÃªm Region3 spatial check (detect zone báº±ng Part váº­t lÃ½)
    [FIX] Zone: TÄƒng cache time â†’ giáº£m lag
    [REMOVE] RenderStepped loop cáº­p nháº­t Part fake â†’ khÃ´ng cáº§n ná»¯a
    [REMOVE] HitboxParts (Part fake) â†’ thay báº±ng OrigSizes (lÆ°u size gá»‘c)
    [CLEAN] ToÃ n bá»™ code Ä‘Æ°á»£c dá»n dáº¹p, tá»‘i Æ°u hÆ¡n
]]

local Players   = game:GetService("Players")
local RS        = game:GetService("RunService")
local TS        = game:GetService("TweenService")
local CoreGui   = game:GetService("CoreGui")
local Teams     = game:GetService("Teams")
local UIS       = game:GetService("UserInputService")
local CS        = game:GetService("CollectionService")
local LP        = Players.LocalPlayer
local Cam       = workspace.CurrentCamera

-- XÃ³a GUI cÅ© cá»§a cÃ¡c phiÃªn báº£n trÆ°á»›c
for _, n in ipairs({
    "Flow_Loading","Flow_VN_v5","Flow_VN_v51","Flow_VN_v52","Flow_VN_v53",
    "Flow_VN_v54","Flow_VN_v6","Flow_VN_v61","Flow_VN_v62","Flow_VN_v63",
    "Flow_VN_v64","Flow_VN_v65","Elysium_VR","HongLong_VR"
}) do
    pcall(function() CoreGui:FindFirstChild(n):Destroy() end)
end

local V3, CF, C3, UD2 = Vector3.new, CFrame.new, Color3.fromRGB, UDim2.new
local abs, min, max, floor, clamp = math.abs, math.min, math.max, math.floor, math.clamp

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ‡»ğŸ‡³ THEME
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local VN = {
    Do       = C3(218,37,29),  DoSang   = C3(255,60,50),   DoTham  = C3(150,20,15),
    Vang     = C3(255,203,5),  VangSang = C3(255,235,100), VangKim = C3(255,215,0),
    Nen      = C3(12,6,6),     NenNhat  = C3(25,12,12),    Vien    = C3(80,30,25),
    AnToan   = C3(34,197,94),  NguyHiem = C3(239,68,68),
    CanhBao  = C3(251,191,36), DacBiet  = C3(180,100,255),
    Chu      = C3(252,248,244),ChuMo    = C3(148,118,112), ChuToi  = C3(100,78,75),
}

local function Tw(o,p,t)
    if not o or not o.Parent then return end
    pcall(function() TS:Create(o,TweenInfo.new(t or 0.25,Enum.EasingStyle.Quint,Enum.EasingDirection.Out),p):Play() end)
end
local function TwSpring(o,p,t)
    if not o or not o.Parent then return end
    pcall(function() TS:Create(o,TweenInfo.new(t or 0.35,Enum.EasingStyle.Back,Enum.EasingDirection.Out),p):Play() end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ‡»ğŸ‡³ LOADING SCREEN
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
do
    local L   = Instance.new("ScreenGui",CoreGui)
    L.Name    = "Flow_Loading"
    L.IgnoreGuiInset = true
    L.DisplayOrder = 9999

    local BG  = Instance.new("Frame",L)
    BG.Size   = UD2(1,0,1,0)
    BG.BackgroundColor3 = VN.DoTham
    BG.BorderSizePixel  = 0

    local Card = Instance.new("Frame",BG)
    Card.Size  = UD2(0,300,0,185)
    Card.Position = UD2(0.5,-150,0.5,-92)
    Card.BackgroundColor3 = VN.Nen
    Card.BorderSizePixel  = 0
    Instance.new("UICorner",Card).CornerRadius = UDim.new(0,14)
    Instance.new("UIStroke",Card).Color = VN.Do

    local Flag = Instance.new("Frame",Card)
    Flag.Size  = UD2(0,50,0,32)
    Flag.Position = UD2(0.5,-25,0,12)
    Flag.BackgroundColor3 = VN.Do
    Flag.BorderSizePixel  = 0
    Instance.new("UICorner",Flag).CornerRadius = UDim.new(0,4)

    local Star = Instance.new("TextLabel",Flag)
    Star.Size  = UD2(1,0,1,0)
    Star.BackgroundTransparency = 1
    Star.Text  = "â˜…"
    Star.TextColor3 = VN.Vang
    Star.TextSize = 20
    Star.Font  = Enum.Font.GothamBlack

    local Title = Instance.new("TextLabel",Card)
    Title.Size  = UD2(1,0,0,24)
    Title.Position = UD2(0,0,0,48)
    Title.BackgroundTransparency = 1
    Title.Text  = "âš¡ FLOW v6.5"
    Title.Font  = Enum.Font.GothamBlack
    Title.TextSize = 18
    Title.TextColor3 = VN.Vang

    local Sub = Instance.new("TextLabel",Card)
    Sub.Size   = UD2(1,0,0,14)
    Sub.Position = UD2(0,0,0,72)
    Sub.BackgroundTransparency = 1
    Sub.Text   = "ğŸ‰ REWRITE HOÃ€N TOÃ€N ğŸ‰"
    Sub.Font   = Enum.Font.GothamBold
    Sub.TextSize = 9
    Sub.TextColor3 = VN.VangSang

    local PBCont = Instance.new("Frame",Card)
    PBCont.Size = UD2(0.7,0,0,10)
    PBCont.Position = UD2(0.15,0,0,100)
    PBCont.BackgroundColor3 = C3(30,12,12)
    PBCont.BorderSizePixel  = 0
    Instance.new("UICorner",PBCont).CornerRadius = UDim.new(0,5)

    local PBFill = Instance.new("Frame",PBCont)
    PBFill.Size  = UD2(0,0,1,0)
    PBFill.BackgroundColor3 = VN.Do
    PBFill.BorderSizePixel  = 0
    Instance.new("UICorner",PBFill).CornerRadius = UDim.new(0,5)

    local Status = Instance.new("TextLabel",Card)
    Status.Size  = UD2(1,0,0,12)
    Status.Position = UD2(0,0,0,120)
    Status.BackgroundTransparency = 1
    Status.Font  = Enum.Font.GothamMedium
    Status.TextSize = 9
    Status.TextColor3 = VN.ChuMo

    local Footer = Instance.new("TextLabel",Card)
    Footer.Size  = UD2(1,0,0,12)
    Footer.Position = UD2(0,0,1,-16)
    Footer.BackgroundTransparency = 1
    Footer.Text  = "ğŸ‡»ğŸ‡³ Viá»‡t Nam â€” v6.5 FIX"
    Footer.Font  = Enum.Font.GothamMedium
    Footer.TextSize = 8
    Footer.TextColor3 = VN.ChuMo

    task.spawn(function()
        for i = 0, 100, 25 do
            Status.Text = (i == 100) and "âœ… XONG!" or "Loading..."
            Tw(PBFill, {Size = UD2(i/100, 0, 1, 0)}, 0.1)
            task.wait(0.12)
        end
        task.wait(0.15)
        Tw(BG,   {BackgroundTransparency=1}, 0.2)
        Tw(Card, {BackgroundTransparency=1}, 0.2)
        task.wait(0.25)
        L:Destroy()
    end)
end
task.wait(0.9)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CONFIG
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local Cfg = {
    NhamTatCa = false,
    Team = {},
    HB  = {On=false, Size=18, Trans=0.8, MaxD=300},
    ESP = {On=false, Fade=true, MaxD=1000, HL=true, Name=true, Dist=true, HP=true, Wpn=true, Zone=true},
}

-- â˜… OrigSizes: lÆ°u size gá»‘c cá»§a parts trÆ°á»›c khi expand
-- â˜… KHÃ”NG cÃ²n HitboxParts (Part fake) ná»¯a
local OrigSizes = {}   -- [uid][partName] = Vector3 size gá»‘c
local HBViz     = {}   -- SelectionBox viz
local ESPViz    = {}   -- Billboard/Highlight viz
local PData     = {}   -- player data cache
local Conns     = {}

local VR = Instance.new("Folder", CoreGui)
VR.Name  = "HongLong_VR"

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ§  WEAPON DETECTION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local WPN_CACHE = {}

local WPN_NAMES = {
    "gun","pistol","rifle","shotgun","sniper","smg","lmg","rpg","launcher","weapon","firearm",
    "ak","glock","deagle","m4","m16","mp5","mp7","mp9","uzi","vector","scar","famas","aug","awp","awm",
    "knife","sword","blade","katana","machete","axe","dagger","karambit","bowie","bayonet",
    "revolver","magnum","desert","eagle","beretta","colt","usp","p90","mac","tec","five","seven",
    "minigun","gatling","turret","cannon","laser","plasma","ray","blaster","phaser",
    "bow","crossbow","arrow","grenade","explosive","bomb","mine","c4","dynamite",
    "kar","mosin","springfield","dragunov","intervention","barrett","m24","l96","scout",
    "spas","benelli","mossberg","remington","saiga","aa12","pump","double",
    "thompson","sten","ppsh","grease","m3","p250","cz","negev","m249","pkm","rpk",
    "combat","tactical","military","assault","auto","semi","burst","silenced","suppressed",
    "ar","sr","dmr","br","hg","sg","mg","rl","gl",
    "sung","sungtruong","sungngan","sungluc","dao","kiem","bom","vukhi","luudan",
    "peacekeeper","wingman","flatline","havoc","devotion","spitfire","mastiff","mozambique",
    "r99","car","alternator","prowler","hemlock","bocek","sentinel","longbow","kraber",
    "vandal","phantom","operator","sheriff","spectre","stinger","bulldog","guardian","odin",
    "shoot","fire","kill","attack","damage","hit","bang","boom","slash","stab","cut",
}

local WPN_SAFE = {
    "shovel","hoe","rake","seed","water","fish","rod","pole","bucket","pail",
    "wrench","screwdriver","paint","brush","key","keycard","flashlight","torch","lantern",
    "camera","binocular","phone","radio","tablet","medkit","bandage","medicine","health",
    "food","drink","snack","money","cash","coin","book","map","compass","note","paper",
    "flower","plant","furniture","decoration","instrument","guitar","piano","drum","flute",
    "toy","ball","frisbee","pet","leash",
}

local function FastMatch(str, list)
    for i = 1, #list do
        if str:find(list[i], 1, true) then return true end
    end
    return false
end

local function AnalyzeWeapon(tool)
    if not tool or not tool:IsA("Tool") then return false, 0 end

    local cached = WPN_CACHE[tool]
    if cached and (tick()-cached.t) < 20 then return cached.w, cached.s end

    local name = tool.Name:lower():gsub("[%-%_%.%s%d]","")
    if FastMatch(name, WPN_SAFE) then
        WPN_CACHE[tool] = {w=false, s=0, t=tick()}
        return false, 0
    end

    local score = 0
    if FastMatch(name, WPN_NAMES) then score = score + 50 end

    local ok, descs = pcall(function() return tool:GetDescendants() end)
    if ok then
        local count = 0
        for _, d in ipairs(descs) do
            if count > 20 then break end
            count += 1
            local dn = d.Name:lower()
            if d:IsA("BasePart") or d:IsA("Attachment") then
                if dn:find("muzzle") or dn:find("barrel") or dn:find("trigger") or dn:find("mag") or
                   dn:find("scope")  or dn:find("sight")  or dn:find("grip")    or dn:find("stock") or
                   dn:find("blade")  or dn:find("handle") or dn:find("bolt")    or dn:find("chamber") then
                    score += 12
                end
            end
            if d:IsA("Sound") then
                if dn:find("shoot") or dn:find("fire")  or dn:find("gun")    or dn:find("reload") or
                   dn:find("shot")  or dn:find("bang")  or dn:find("slash")  or dn:find("swing")  or
                   dn:find("attack") or dn:find("hit") then
                    score += 15
                end
            end
            if d:IsA("RemoteEvent") or d:IsA("RemoteFunction") or d:IsA("BindableEvent") then
                if dn:find("fire") or dn:find("shoot") or dn:find("attack") or dn:find("damage") or
                   dn:find("hit")  or dn:find("reload") or dn:find("equip") then
                    score += 12
                end
            end
        end
    end

    local handle = tool:FindFirstChild("Handle")
    if handle and handle:IsA("BasePart") then
        local s     = handle.Size
        local ratio = max(s.X, s.Y, s.Z) / max(min(s.X, s.Y, s.Z), 0.1)
        if ratio > 2.5 then score += 8 end
    end

    local isWeapon = score >= 8
    WPN_CACHE[tool] = {w=isWeapon, s=score, t=tick()}
    return isWeapon, score
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ—ºï¸ ZONE DETECTION (Simple + Spatial)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local ZoneCache = {}
local SAFE_KW   = {
    "safe","insafe","safezone","lobby","spawn","protected","nopvp",
    "immune","invulnerable","peaceful","godmode","base","hub","town",
}

local function CheckSafeZone(player)
    local char = player.Character
    if not char then return false end

    local uid    = player.UserId
    local cached = ZoneCache[uid]
    if cached and (tick()-cached.t) < 0.5 then return cached.r end

    local function Cache(val)
        ZoneCache[uid] = {r=val, t=tick()}
        return val
    end

    -- â‘  ForceField = 100% safe
    if char:FindFirstChildOfClass("ForceField") then return Cache(true) end

    -- â‘¡ Attribute / Value object / Tag check
    local checkTargets = {player, char}
    for _, target in ipairs(checkTargets) do

        local ok1, attrs = pcall(function() return target:GetAttributes() end)
        if ok1 then
            for attrName, attrVal in pairs(attrs) do
                local nl = attrName:lower()
                for _, kw in ipairs(SAFE_KW) do
                    if nl:find(kw, 1, true) then
                        if attrVal == true or (type(attrVal) == "number" and attrVal > 0) then
                            return Cache(true)
                        end
                    end
                end
            end
        end

        local ok2, children = pcall(function() return target:GetChildren() end)
        if ok2 then
            for _, obj in ipairs(children) do
                if obj:IsA("BoolValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") or obj:IsA("StringValue") then
                    local nl = obj.Name:lower()
                    for _, kw in ipairs(SAFE_KW) do
                        if nl:find(kw, 1, true) then
                            local vok, val = pcall(function() return obj.Value end)
                            if vok then
                                if (obj:IsA("BoolValue") and val == true)
                                or ((obj:IsA("IntValue") or obj:IsA("NumberValue")) and val > 0)
                                or (obj:IsA("StringValue") and (val == "true" or val == "1" or val:lower() == "yes")) then
                                    return Cache(true)
                                end
                            end
                        end
                    end
                end
            end
        end

        local ok3, tags = pcall(function() return CS:GetTags(target) end)
        if ok3 then
            for _, tag in ipairs(tags) do
                local tl = tag:lower()
                for _, kw in ipairs(SAFE_KW) do
                    if tl:find(kw, 1, true) then return Cache(true) end
                end
            end
        end
    end

    -- â‘¢ Spatial check: detect zone dá»±a trÃªn Part váº­t lÃ½ xung quanh player
    local root = char:FindFirstChild("HumanoidRootPart")
    if root then
        local r   = 3
        local reg = Region3.new(root.Position - V3(r,r,r), root.Position + V3(r,r,r))
        local ok4, parts = pcall(function()
            return workspace:FindPartsInRegion3WithIgnoreList(reg, {char, workspace.CurrentCamera}, 30)
        end)
        if ok4 then
            for _, part in ipairs(parts) do
                local pn = part.Name:lower()
                for _, kw in ipairs(SAFE_KW) do
                    if pn:find(kw, 1, true) then return Cache(true) end
                end
                local par = part.Parent
                if par then
                    local prn = par.Name:lower()
                    for _, kw in ipairs(SAFE_KW) do
                        if prn:find(kw, 1, true) then return Cache(true) end
                    end
                end
            end
        end
    end

    return Cache(false)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- UTILITIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function MyRoot()
    local c = LP.Character
    return c and c:FindFirstChild("HumanoidRootPart")
end

local function GetDist(part)
    local mr = MyRoot()
    if not mr or not part then return 9999 end
    return (mr.Position - part.Position).Magnitude
end

local function HPColor(r)
    r = clamp(r, 0, 1)
    if r > 0.6 then return VN.AnToan
    elseif r > 0.3 then return VN.CanhBao
    else return VN.NguyHiem end
end

local function ShouldTarget(player, inSafe)
    if player == LP then return false end
    if inSafe then return false end
    if Cfg.NhamTatCa then return true end
    local key = player.Team and player.Team.Name or "__NO_TEAM__"
    local cfg = Cfg.Team[key] or Cfg.Team["__NO_TEAM__"]
    if not cfg then return true end
    if cfg.Mode == 0 then return false end
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PLAYER DATA
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function GetPD(uid)
    if not PData[uid] then
        PData[uid] = {
            lastUpdate  = 0,
            alive       = false,
            target      = false,
            hbOn        = false,
            espOn       = false,
            dist        = 9999,
            inSafe      = false,
            hasWeapon   = false,
            weaponName  = nil,
            weaponScore = 0,
            hp          = 100,
            maxHp       = 100,
            hpRatio     = 1,
            rootPart    = nil,
            espCache    = {},
        }
    end
    return PData[uid]
end

local function UpdatePlayer(player, now)
    local uid = player.UserId
    local pd  = GetPD(uid)

    local rate = pd.dist < 100 and 0.08 or 0.15
    if (now - pd.lastUpdate) < rate then return pd, false end
    pd.lastUpdate = now

    local char = player.Character
    local hum  = char and char:FindFirstChildOfClass("Humanoid")
    local root = char and char:FindFirstChild("HumanoidRootPart")

    pd.alive    = char ~= nil and hum ~= nil and root ~= nil and hum.Health > 0
    pd.rootPart = root

    if not pd.alive then
        pd.target = false
        pd.hbOn   = false
        pd.espOn  = false
        return pd, true
    end

    pd.dist    = GetDist(root)
    pd.hp      = hum.Health
    pd.maxHp   = max(hum.MaxHealth, 1)
    pd.hpRatio = clamp(pd.hp / pd.maxHp, 0, 1)
    pd.inSafe  = CheckSafeZone(player)

    local tool = char:FindFirstChildOfClass("Tool")
    if tool then
        local isW, score = AnalyzeWeapon(tool)
        pd.hasWeapon   = isW
        pd.weaponName  = tool.Name
        pd.weaponScore = score
    else
        pd.hasWeapon   = false
        pd.weaponName  = nil
        pd.weaponScore = 0
    end

    pd.target = ShouldTarget(player, pd.inSafe)
    pd.hbOn   = Cfg.HB.On  and pd.target and pd.dist <= Cfg.HB.MaxD
    pd.espOn  = Cfg.ESP.On and pd.target and pd.dist <= Cfg.ESP.MaxD

    return pd, true
end

local function ForceRecalcAll()
    for _, pd in pairs(PData) do
        pd.lastUpdate = 0
        pd.espCache   = {}
    end
    WPN_CACHE = {}
    ZoneCache = {}
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“¦ HITBOX SYSTEM â€” RESIZE PARTS THáº¬T
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--[[
    â˜…â˜…â˜… CÃCH ÄÃšNG â˜…â˜…â˜…
    Thay vÃ¬ táº¡o Part má»›i bÃªn ngoÃ i character (game khÃ´ng raycast vÃ o),
    ta RESIZE TRá»°C TIáº¾P cÃ¡c parts cá»§a enemy.
    â†’ Weapon cá»§a game sáº½ hit Ä‘Ãºng vÃ¬ raycast vÃ o character parts tháº­t.
    â†’ LÆ°u size gá»‘c Ä‘á»ƒ restore khi táº¯t.
]]

local HB_PART_NAMES = {
    "HumanoidRootPart",
    "UpperTorso", "LowerTorso", "Torso",
    "Head",
    "RightUpperArm", "LeftUpperArm",
    "RightLowerArm", "LeftLowerArm",
    "RightHand",     "LeftHand",
    "RightUpperLeg", "LeftUpperLeg",
    "RightLowerLeg", "LeftLowerLeg",
    "RightFoot",     "LeftFoot",
    -- R6
    "Right Arm", "Left Arm", "Right Leg", "Left Leg",
}

local function RestoreHitbox(uid)
    local orig = OrigSizes[uid]
    if not orig then return end

    local player = Players:GetPlayerByUserId(uid)
    local char   = player and player.Character

    if char then
        for partName, origSize in pairs(orig) do
            local part = char:FindFirstChild(partName)
            if part and part:IsA("BasePart") then
                pcall(function() part.Size = origSize end)
            end
        end
    end

    OrigSizes[uid] = nil
end

local function ExpandHitbox(player, size)
    local uid  = player.UserId
    local char = player.Character
    if not char then return end

    if not OrigSizes[uid] then
        OrigSizes[uid] = {}
    end

    local sv3 = V3(size, size, size)

    for _, partName in ipairs(HB_PART_NAMES) do
        local part = char:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            -- LÆ°u size gá»‘c (chá»‰ láº§n Ä‘áº§u, trÃ¡nh ghi Ä‘Ã¨)
            if not OrigSizes[uid][partName] then
                OrigSizes[uid][partName] = part.Size
            end
            pcall(function() part.Size = sv3 end)
        end
    end
end

local function UpdateHitbox(player, pd)
    local uid = player.UserId

    if not pd.hbOn or not pd.alive or not pd.rootPart then
        -- Táº¯t hitbox â†’ restore size gá»‘c
        RestoreHitbox(uid)
        return
    end

    -- Expand parts tháº­t cá»§a enemy
    ExpandHitbox(player, Cfg.HB.Size)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- HITBOX VIZ (SelectionBox trÃªn character tháº­t)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function EnsureHBViz(uid)
    if HBViz[uid] and HBViz[uid].Parent then return HBViz[uid] end
    local f  = Instance.new("Folder", VR)
    f.Name   = "HBViz_"..uid
    local sb = Instance.new("SelectionBox", f)
    sb.Name  = "Box"
    sb.LineThickness = 0.035
    HBViz[uid] = f
    return f
end

local function UpdateHBViz(player, pd)
    local uid = player.UserId

    if not pd.hbOn or not pd.alive or not pd.rootPart then
        local f = HBViz[uid]
        if f then
            local sb = f:FindFirstChild("Box")
            if sb then sb.Adornee = nil end
        end
        return
    end

    local f  = EnsureHBViz(uid)
    local sb = f:FindFirstChild("Box")
    if not sb then return end

    local col = pd.inSafe and VN.ChuMo or (pd.hasWeapon and VN.NguyHiem or VN.Vang)

    -- â˜… Adornee vÃ o HumanoidRootPart THáº¬T
    sb.Adornee        = pd.rootPart
    sb.Color3         = col
    sb.SurfaceColor3  = col
    sb.SurfaceTransparency = Cfg.HB.Trans
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ‘ï¸ ESP
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function EnsureESP(uid)
    if ESPViz[uid] and ESPViz[uid].Parent then return ESPViz[uid] end

    local f  = Instance.new("Folder", VR)
    f.Name   = "ESP_"..uid

    local hl = Instance.new("Highlight", f)
    hl.Name  = "HL"
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Enabled   = false

    local bg = Instance.new("BillboardGui", f)
    bg.Name  = "BG"
    bg.AlwaysOnTop = true
    bg.Size  = UD2(0, 150, 0, 95)
    bg.StudsOffset = V3(0, 3, 0)
    bg.MaxDistance = 1200
    bg.Enabled = false

    local ct = Instance.new("Frame", bg)
    ct.Name  = "CT"
    ct.Size  = UD2(1, 0, 1, 0)
    ct.BackgroundTransparency = 1

    local ly = Instance.new("UIListLayout", ct)
    ly.HorizontalAlignment = Enum.HorizontalAlignment.Center
    ly.Padding = UDim.new(0, 2)

    local function ML(nm, ord, h, sz)
        local l = Instance.new("TextLabel", ct)
        l.Name  = nm
        l.LayoutOrder = ord
        l.Size  = UD2(1, 0, 0, h)
        l.BackgroundTransparency = 1
        l.Font  = Enum.Font.GothamBold
        l.TextSize = sz
        l.TextStrokeTransparency = 0
        l.TextStrokeColor3 = C3(0, 0, 0)
        l.RichText = true
        l.Text  = ""
    end

    ML("NL",  1, 14, 11)
    ML("ZL",  2, 12, 9)
    ML("WL",  3, 12, 9)
    ML("DL",  4, 12, 10)
    ML("HL2", 5, 10, 9)

    local hpBg = Instance.new("Frame", ct)
    hpBg.Name  = "HPBg"
    hpBg.LayoutOrder = 6
    hpBg.Size  = UD2(0.6, 0, 0, 5)
    hpBg.BackgroundColor3 = C3(30, 10, 10)
    hpBg.BorderSizePixel  = 0
    Instance.new("UICorner", hpBg).CornerRadius = UDim.new(1, 0)

    local hpF = Instance.new("Frame", hpBg)
    hpF.Name  = "HPF"
    hpF.Size  = UD2(1, 0, 1, 0)
    hpF.BackgroundColor3 = VN.AnToan
    hpF.BorderSizePixel  = 0
    Instance.new("UICorner", hpF).CornerRadius = UDim.new(1, 0)

    ESPViz[uid] = f
    return f
end

local function UpdateESP(player, pd)
    local uid = player.UserId

    if not pd.espOn or not pd.alive or not pd.rootPart then
        local f = ESPViz[uid]
        if f then
            local hl = f:FindFirstChild("HL")
            if hl then hl.Enabled = false end
            local bg = f:FindFirstChild("BG")
            if bg then bg.Enabled = false end
        end
        return
    end

    local f    = EnsureESP(uid)
    local char = player.Character

    -- Lazy update
    local cache   = pd.espCache
    local wpnName = pd.weaponName or ""
    if cache.hp == floor(pd.hp) and cache.safe == pd.inSafe
    and cache.weapon == wpnName and abs((cache.dist or 0) - pd.dist) < 20 then
        return
    end
    cache.hp     = floor(pd.hp)
    cache.safe   = pd.inSafe
    cache.weapon = wpnName
    cache.dist   = pd.dist

    local dist    = pd.dist
    local fade    = Cfg.ESP.Fade and clamp((dist - 50) / 450, 0, 1) or 0
    local hpC     = HPColor(pd.hpRatio)
    local baseCol = pd.inSafe and VN.ChuMo or (pd.hasWeapon and VN.NguyHiem or VN.Vang)
    local tf      = max(fade * 0.5, 0.08)

    -- Highlight
    local hl = f:FindFirstChild("HL")
    if hl and Cfg.ESP.HL then
        hl.Enabled  = true
        hl.Adornee  = char
        hl.FillColor  = baseCol
        hl.OutlineColor = pd.hasWeapon and VN.NguyHiem or VN.Vang
        hl.FillTransparency    = max(0.15, fade * 0.6)
        hl.OutlineTransparency = fade * 0.5
    elseif hl then
        hl.Enabled = false
    end

    -- Billboard
    local bg = f:FindFirstChild("BG")
    if bg then
        bg.Adornee = pd.rootPart
        bg.Enabled = true
    end

    local ct = bg and bg:FindFirstChild("CT")
    if not ct then return end

    local function SL(nm, txt, col)
        local l = ct:FindFirstChild(nm)
        if l then
            l.Text = txt
            if col then l.TextColor3 = col end
            l.TextTransparency = tf
            l.Visible = txt ~= ""
        end
    end

    if Cfg.ESP.Name then
        SL("NL", string.format("<b>%s</b>", player.Name), baseCol)
    else SL("NL", "") end

    if Cfg.ESP.Zone then
        if pd.inSafe then
            SL("ZL", '<font color="#888">ğŸ›¡ï¸ AN TOÃ€N</font>')
        else
            SL("ZL", '<font color="#AA66FF">âš”ï¸ CHIáº¾N Äáº¤U</font>')
        end
    else SL("ZL", "") end

    if Cfg.ESP.Wpn and pd.weaponName then
        local wCol  = pd.hasWeapon and "#FF4400" or "#888888"
        local wIcon = pd.hasWeapon and "ğŸ”«" or "ğŸ“¦"
        SL("WL", string.format('<font color="%s">%s %s [%d]</font>', wCol, wIcon, pd.weaponName, pd.weaponScore))
    else SL("WL", "") end

    if Cfg.ESP.Dist then
        SL("DL", string.format("%.0f m", dist),
           VN.AnToan:Lerp(VN.NguyHiem, clamp(dist / Cfg.ESP.MaxD, 0, 1)))
    else SL("DL", "") end

    if Cfg.ESP.HP then
        local hpHex = string.format("#%02X%02X%02X",
            floor(hpC.R*255), floor(hpC.G*255), floor(hpC.B*255))
        SL("HL2", string.format('<font color="%s">%.0f HP</font>', hpHex, pd.hp))
    else SL("HL2", "") end

    local hpBg2  = ct:FindFirstChild("HPBg")
    local hpFill = hpBg2 and hpBg2:FindFirstChild("HPF")
    if hpBg2 and Cfg.ESP.HP then
        hpBg2.Visible = true
        if hpFill then
            hpFill.Size = UD2(pd.hpRatio, 0, 1, 0)
            hpFill.BackgroundColor3 = hpC
        end
    elseif hpBg2 then
        hpBg2.Visible = false
    end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CLEANUP
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function HideVisuals(uid)
    local hb = HBViz[uid]
    if hb then
        local sb = hb:FindFirstChild("Box")
        if sb then sb.Adornee = nil end
    end
    local esp = ESPViz[uid]
    if esp then
        local hl = esp:FindFirstChild("HL")
        if hl then hl.Enabled = false end
        local bg = esp:FindFirstChild("BG")
        if bg then bg.Enabled = false end
    end
end

local function FullCleanup(player)
    local uid = player.UserId
    RestoreHitbox(uid)
    PData[uid]     = nil
    ZoneCache[uid] = nil
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PLAYER HOOKS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function HookPlayer(player)
    table.insert(Conns, player.CharacterAdded:Connect(function()
        local uid = player.UserId
        OrigSizes[uid] = nil
        HideVisuals(uid)
        local pd = GetPD(uid)
        pd.lastUpdate = 0
        pd.espCache   = {}
    end))
    table.insert(Conns, player.CharacterRemoving:Connect(function()
        OrigSizes[player.UserId] = nil
        FullCleanup(player)
    end))
end

local function SyncTeams()
    for _, t in ipairs(Teams:GetChildren()) do
        if t:IsA("Team") and not Cfg.Team[t.Name] then
            Cfg.Team[t.Name] = {Mode=0, Color=t.TeamColor.Color}
        end
    end
    Cfg.Team["__NO_TEAM__"] = Cfg.Team["__NO_TEAM__"] or {Mode=0, Color=Color3.new(1,1,1)}
end

SyncTeams()
table.insert(Conns, Teams.ChildAdded:Connect(SyncTeams))
for _, p in ipairs(Players:GetPlayers()) do HookPlayer(p) end
table.insert(Conns, Players.PlayerAdded:Connect(HookPlayer))
table.insert(Conns, Players.PlayerRemoving:Connect(function(p)
    FullCleanup(p)
    local uid = p.UserId
    if HBViz[uid]  then pcall(function() HBViz[uid]:Destroy()  end); HBViz[uid]  = nil end
    if ESPViz[uid] then pcall(function() ESPViz[uid]:Destroy() end); ESPViz[uid] = nil end
end))

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ‡»ğŸ‡³ UI
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function BuildUI()
    local Gui = Instance.new("ScreenGui", CoreGui)
    Gui.Name  = "Flow_VN_v65"
    Gui.ResetOnSpawn  = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.DisplayOrder  = 100

    local Main = Instance.new("Frame", Gui)
    Main.Name  = "Main"
    Main.Size  = UD2(0, 330, 0, 440)
    Main.Position = UD2(0.5, -165, 0.5, -220)
    Main.BackgroundColor3 = VN.Nen
    Main.BorderSizePixel  = 0
    Main.Active    = true
    Main.Draggable = true
    Main.ClipsDescendants = true
    Main.Visible   = false
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 12)
    Instance.new("UIStroke", Main).Color = VN.Do

    -- Header
    local Hdr = Instance.new("Frame", Main)
    Hdr.Size  = UD2(1, 0, 0, 42)
    Hdr.BackgroundColor3 = VN.Do
    Hdr.BorderSizePixel  = 0
    Instance.new("UICorner", Hdr).CornerRadius = UDim.new(0, 12)
    local HFix = Instance.new("Frame", Hdr)
    HFix.Size  = UD2(1, 0, 0, 12)
    HFix.Position = UD2(0, 0, 1, -12)
    HFix.BackgroundColor3 = VN.Do
    HFix.BorderSizePixel  = 0

    local FI = Instance.new("TextLabel", Hdr)
    FI.Size  = UD2(0, 20, 0, 20)
    FI.Position = UD2(0, 8, 0.5, -10)
    FI.BackgroundTransparency = 1
    FI.Text  = "ğŸ‡»ğŸ‡³"
    FI.TextSize = 14

    local TL = Instance.new("TextLabel", Hdr)
    TL.Size  = UD2(1, -70, 0, 18)
    TL.Position = UD2(0, 32, 0, 6)
    TL.BackgroundTransparency = 1
    TL.Text  = "âš¡ FLOW v6.5"
    TL.Font  = Enum.Font.GothamBlack
    TL.TextSize = 14
    TL.TextColor3 = VN.Vang
    TL.TextXAlignment = Enum.TextXAlignment.Left

    local ST = Instance.new("TextLabel", Hdr)
    ST.Size  = UD2(0, 140, 0, 10)
    ST.Position = UD2(0, 32, 0, 24)
    ST.BackgroundTransparency = 1
    ST.Text  = "REWRITE + HITBOX FIX"
    ST.Font  = Enum.Font.GothamMedium
    ST.TextSize = 7
    ST.TextColor3 = VN.VangSang
    ST.TextXAlignment = Enum.TextXAlignment.Left

    local CB = Instance.new("TextButton", Hdr)
    CB.Size  = UD2(0, 22, 0, 22)
    CB.Position = UD2(1, -28, 0.5, -11)
    CB.Text  = "âœ•"
    CB.TextColor3 = VN.Vang
    CB.Font  = Enum.Font.GothamBold
    CB.TextSize = 11
    CB.BackgroundColor3 = VN.DoTham
    CB.BorderSizePixel  = 0
    CB.AutoButtonColor  = false
    Instance.new("UICorner", CB).CornerRadius = UDim.new(0, 5)
    CB.MouseButton1Click:Connect(function() Main.Visible = false end)

    -- Tab Bar
    local TB = Instance.new("Frame", Main)
    TB.Size  = UD2(1, -8, 0, 28)
    TB.Position = UD2(0, 4, 0, 46)
    TB.BackgroundColor3 = VN.NenNhat
    TB.BorderSizePixel  = 0
    Instance.new("UICorner", TB).CornerRadius = UDim.new(0, 7)
    local tbLy = Instance.new("UIListLayout", TB)
    tbLy.FillDirection = Enum.FillDirection.Horizontal
    tbLy.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tbLy.VerticalAlignment   = Enum.VerticalAlignment.Center
    tbLy.Padding = UDim.new(0, 3)

    local Content = Instance.new("Frame", Main)
    Content.Size  = UD2(1, -8, 1, -112)
    Content.Position = UD2(0, 4, 0, 78)
    Content.BackgroundTransparency = 1
    Content.ClipsDescendants = true

    local SBar = Instance.new("Frame", Main)
    SBar.Size  = UD2(1, -8, 0, 22)
    SBar.Position = UD2(0, 4, 1, -28)
    SBar.BackgroundColor3 = VN.NenNhat
    SBar.BorderSizePixel  = 0
    Instance.new("UICorner", SBar).CornerRadius = UDim.new(0, 5)

    local SLbl = Instance.new("TextLabel", SBar)
    SLbl.Size  = UD2(1, -6, 1, 0)
    SLbl.Position = UD2(0, 3, 0, 0)
    SLbl.BackgroundTransparency = 1
    SLbl.Text  = "ğŸ‡»ğŸ‡³ FLOW v6.5"
    SLbl.Font  = Enum.Font.GothamMedium
    SLbl.TextSize = 8
    SLbl.TextColor3 = VN.ChuMo
    SLbl.TextXAlignment = Enum.TextXAlignment.Left

    local tabs = {}

    local function MkScroll()
        local s = Instance.new("ScrollingFrame", Content)
        s.Size  = UD2(1, 0, 1, 0)
        s.BackgroundTransparency = 1
        s.AutomaticCanvasSize = Enum.AutomaticSize.Y
        s.ScrollBarThickness  = 3
        s.ScrollBarImageColor3 = VN.Do
        s.BorderSizePixel = 0
        s.Visible = false
        s.CanvasSize = UD2(0, 0, 0, 0)
        local ly = Instance.new("UIListLayout", s)
        ly.Padding = UDim.new(0, 4)
        ly.SortOrder = Enum.SortOrder.LayoutOrder
        Instance.new("UIPadding", s).PaddingTop = UDim.new(0, 2)
        return s
    end

    local function MkTab(nm, ic)
        local btn = Instance.new("TextButton", TB)
        btn.Size  = UD2(0, 95, 0, 22)
        btn.Text  = ic.." "..nm
        btn.Font  = Enum.Font.GothamBold
        btn.TextSize = 9
        btn.TextColor3 = VN.ChuToi
        btn.BackgroundColor3 = VN.Nen
        btn.BackgroundTransparency = 0.5
        btn.BorderSizePixel = 0
        btn.AutoButtonColor = false
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)

        local ind = Instance.new("Frame", btn)
        ind.Size  = UD2(0.3, 0, 0, 2)
        ind.Position = UD2(0.35, 0, 1, -3)
        ind.BackgroundColor3 = VN.Vang
        ind.BorderSizePixel  = 0
        ind.Visible = false
        Instance.new("UICorner", ind).CornerRadius = UDim.new(1, 0)

        local scr = MkScroll()
        tabs[nm]  = {btn=btn, ind=ind, scroll=scr}

        btn.MouseButton1Click:Connect(function()
            for n, d in pairs(tabs) do
                local a = (n == nm)
                d.scroll.Visible = a
                d.ind.Visible    = a
                Tw(d.btn, {
                    TextColor3 = a and VN.Vang or VN.ChuToi,
                    BackgroundColor3 = a and C3(50,20,18) or VN.Nen,
                    BackgroundTransparency = a and 0.1 or 0.5,
                }, 0.15)
            end
        end)

        return scr
    end

    local function Card(p, h)
        local f = Instance.new("Frame", p)
        f.Size  = UD2(1, -4, 0, h or 34)
        f.BackgroundColor3 = VN.NenNhat
        f.BackgroundTransparency = 0.15
        f.BorderSizePixel = 0
        Instance.new("UICorner", f).CornerRadius = UDim.new(0, 7)
        return f
    end

    local function Section(p, t)
        local f = Card(p, 20)
        f.BackgroundColor3 = C3(50, 18, 14)
        local l = Instance.new("TextLabel", f)
        l.Size  = UD2(1, -8, 1, 0)
        l.Position = UD2(0, 4, 0, 0)
        l.BackgroundTransparency = 1
        l.Text  = t
        l.Font  = Enum.Font.GothamBold
        l.TextSize = 9
        l.TextColor3 = VN.Vang
        l.TextXAlignment = Enum.TextXAlignment.Left
    end

    local function Toggle(p, lbl, init, cb, col)
        col = col or VN.Do
        local f   = Card(p, 32)
        local txt = Instance.new("TextLabel", f)
        txt.Size  = UD2(1, -50, 1, 0)
        txt.Position = UD2(0, 7, 0, 0)
        txt.BackgroundTransparency = 1
        txt.Text  = lbl
        txt.Font  = Enum.Font.Gotham
        txt.TextSize = 9
        txt.TextColor3 = init and VN.Chu or VN.ChuMo
        txt.TextXAlignment = Enum.TextXAlignment.Left

        local trk = Instance.new("Frame", f)
        trk.Size  = UD2(0, 34, 0, 16)
        trk.Position = UD2(1, -42, 0.5, -8)
        trk.BackgroundColor3 = init and col or C3(50, 35, 35)
        trk.BorderSizePixel  = 0
        Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)

        local thb = Instance.new("Frame", trk)
        thb.Size  = UD2(0, 10, 0, 10)
        thb.Position = init and UD2(1,-13,0.5,-5) or UD2(0,3,0.5,-5)
        thb.BackgroundColor3 = init and Color3.new(1,1,1) or C3(140,120,120)
        thb.BorderSizePixel  = 0
        Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)

        local on  = init
        local btn = Instance.new("TextButton", f)
        btn.Size  = UD2(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text  = ""
        btn.ZIndex = 5

        btn.MouseButton1Click:Connect(function()
            on = not on
            TwSpring(trk, {BackgroundColor3 = on and col or C3(50,35,35)}, 0.15)
            TwSpring(thb, {
                Position = on and UD2(1,-13,0.5,-5) or UD2(0,3,0.5,-5),
                BackgroundColor3 = on and Color3.new(1,1,1) or C3(140,120,120),
            }, 0.15)
            Tw(txt, {TextColor3 = on and VN.Chu or VN.ChuMo}, 0.1)
            cb(on)
        end)
    end

    local function Slider(p, lbl, mn, mx, def, dp, cb)
        local f   = Card(p, 40)
        local txt = Instance.new("TextLabel", f)
        txt.Size  = UD2(0.5, 0, 0, 12)
        txt.Position = UD2(0, 7, 0, 4)
        txt.BackgroundTransparency = 1
        txt.Text  = lbl
        txt.Font  = Enum.Font.Gotham
        txt.TextSize = 8
        txt.TextColor3 = VN.ChuMo
        txt.TextXAlignment = Enum.TextXAlignment.Left

        local vt  = Instance.new("TextLabel", f)
        vt.Size   = UD2(0.4, 0, 0, 12)
        vt.Position = UD2(0.58, 0, 0, 4)
        vt.BackgroundTransparency = 1
        vt.Text   = tostring(def)
        vt.Font   = Enum.Font.GothamBold
        vt.TextSize = 9
        vt.TextColor3 = VN.Vang
        vt.TextXAlignment = Enum.TextXAlignment.Right

        local trk = Instance.new("Frame", f)
        trk.Size  = UD2(1, -14, 0, 5)
        trk.Position = UD2(0, 7, 0, 26)
        trk.BackgroundColor3 = C3(40, 18, 18)
        trk.BorderSizePixel  = 0
        Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)

        local fill = Instance.new("Frame", trk)
        fill.Size  = UD2((def-mn)/max(mx-mn,1), 0, 1, 0)
        fill.BackgroundColor3 = VN.Do
        fill.BorderSizePixel  = 0
        Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)

        local thb = Instance.new("TextButton", trk)
        thb.Size  = UD2(0, 10, 0, 10)
        thb.Position = UD2((def-mn)/max(mx-mn,1), -5, 0.5, -5)
        thb.BackgroundColor3 = VN.Vang
        thb.Text  = ""
        thb.BorderSizePixel = 0
        thb.ZIndex = 5
        Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)

        local prec = 10^dp
        local drag = false

        local function upd(ix)
            local tw = trk.AbsoluteSize.X
            if tw <= 0 then return end
            local rel = clamp((ix - trk.AbsolutePosition.X) / tw, 0, 1)
            local v   = floor((mn + (mx-mn)*rel) * prec + 0.5) / prec
            Tw(fill, {Size = UD2(rel, 0, 1, 0)}, 0.05)
            Tw(thb,  {Position = UD2(rel, -5, 0.5, -5)}, 0.05)
            vt.Text = tostring(v)
            cb(v)
        end

        thb.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
            or i.UserInputType == Enum.UserInputType.Touch then
                drag = true
            end
        end)
        trk.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
            or i.UserInputType == Enum.UserInputType.Touch then
                drag = true; upd(i.Position.X)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if drag and (i.UserInputType == Enum.UserInputType.MouseMovement
            or i.UserInputType == Enum.UserInputType.Touch) then
                upd(i.Position.X)
            end
        end)
        UIS.InputEnded:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
            or i.UserInputType == Enum.UserInputType.Touch then
                drag = false
            end
        end)
    end

    local function InfoCard(p, t, c)
        local f = Card(p, 40)
        f.BackgroundColor3 = C3(10, 16, 10)
        local l = Instance.new("TextLabel", f)
        l.Size  = UD2(1, -8, 1, -4)
        l.Position = UD2(0, 4, 0, 2)
        l.BackgroundTransparency = 1
        l.Text  = t
        l.Font  = Enum.Font.Gotham
        l.TextSize = 8
        l.TextColor3 = c or VN.AnToan
        l.TextXAlignment = Enum.TextXAlignment.Left
        l.TextWrapped = true
        l.RichText = true
    end

    -- â”€â”€â”€â”€â”€â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€
    local tT = MkTab("Má»¤C TIÃŠU", "ğŸ¯")
    local tH = MkTab("HITBOX",   "ğŸ“¦")
    local tE = MkTab("ESP",      "ğŸ‘")

    tabs["Má»¤C TIÃŠU"].scroll.Visible = true
    tabs["Má»¤C TIÃŠU"].ind.Visible    = true
    tabs["Má»¤C TIÃŠU"].btn.TextColor3 = VN.Vang
    tabs["Má»¤C TIÃŠU"].btn.BackgroundColor3 = C3(50,20,18)
    tabs["Má»¤C TIÃŠU"].btn.BackgroundTransparency = 0.1

    -- â”€â”€â”€â”€â”€â”€â”€â”€ TAB: Má»¤C TIÃŠU â”€â”€â”€â”€â”€â”€â”€â”€
    Section(tT, "ğŸ¯ CHáº¾ Äá»˜")
    Toggle(tT, "âš¡ Nháº¯m Táº¤T Cáº¢ (bá» Team)", Cfg.NhamTatCa,
        function(v) Cfg.NhamTatCa = v; ForceRecalcAll() end, VN.NguyHiem)

    Section(tT, "ğŸ´ TEAM")
    InfoCard(tT,
        '<font color="#FF5050">Táº®T</font>  <font color="#50FF50">Táº¤T Cáº¢</font>  <font color="#FFAA00">ÄE Dá»ŒA</font>\n'..
        'â˜… Player trong SAFE ZONE sáº½ KHÃ”NG bá»‹ target',
        C3(180,220,160))

    local mL = {[0]="Táº®T", [1]="Táº¤T Cáº¢", [2]="ÄE Dá»ŒA"}
    local mC = {[0]=C3(70,50,50), [1]=VN.AnToan, [2]=VN.CanhBao}

    for tn, td in pairs(Cfg.Team) do
        local dn = tn == "__NO_TEAM__" and "ğŸš« No Team" or tn
        local f  = Card(tT, 30)

        local dot = Instance.new("Frame", f)
        dot.Size  = UD2(0, 7, 0, 7)
        dot.Position = UD2(0, 7, 0.5, -3.5)
        dot.BackgroundColor3 = td.Color
        dot.BorderSizePixel  = 0
        Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)

        local nl = Instance.new("TextLabel", f)
        nl.Size  = UD2(0.45, 0, 1, 0)
        nl.Position = UD2(0, 18, 0, 0)
        nl.BackgroundTransparency = 1
        nl.Text  = dn
        nl.Font  = Enum.Font.Gotham
        nl.TextSize = 8
        nl.TextColor3 = VN.Chu
        nl.TextXAlignment = Enum.TextXAlignment.Left

        local mb = Instance.new("TextButton", f)
        mb.Size  = UD2(0, 62, 0, 18)
        mb.Position = UD2(1, -70, 0.5, -9)
        mb.Text  = mL[td.Mode]
        mb.TextColor3 = Color3.new(1,1,1)
        mb.Font  = Enum.Font.GothamBold
        mb.TextSize = 8
        mb.BackgroundColor3 = mC[td.Mode]
        mb.BorderSizePixel  = 0
        mb.AutoButtonColor  = false
        Instance.new("UICorner", mb).CornerRadius = UDim.new(0, 4)

        mb.MouseButton1Click:Connect(function()
            td.Mode = (td.Mode + 1) % 3
            mb.Text = mL[td.Mode]
            TwSpring(mb, {BackgroundColor3 = mC[td.Mode]}, 0.15)
            ForceRecalcAll()
        end)
    end

    -- â”€â”€â”€â”€â”€â”€â”€â”€ TAB: HITBOX â”€â”€â”€â”€â”€â”€â”€â”€
    Section(tH, "ğŸ“¦ HITBOX")
    Toggle(tH, "ğŸ”¥ Báº­t Hitbox", Cfg.HB.On,
        function(v)
            Cfg.HB.On = v
            if not v then
                for _, p in ipairs(Players:GetPlayers()) do
                    if p ~= LP then RestoreHitbox(p.UserId) end
                end
            end
            ForceRecalcAll()
        end, VN.Do)

    Section(tH, "âš™ï¸ CÃ€I Äáº¶T")
    Slider(tH, "KÃ­ch thÆ°á»›c", 5, 35, Cfg.HB.Size, 0, function(v) Cfg.HB.Size = v end)
    Slider(tH, "Trong suá»‘t", 0, 1, Cfg.HB.Trans, 2, function(v) Cfg.HB.Trans = v end)
    Slider(tH, "KC tá»‘i Ä‘a",  50, 350, Cfg.HB.MaxD, 0,
        function(v) Cfg.HB.MaxD = v; ForceRecalcAll() end)

    InfoCard(tH,
        'â˜… Resize TRá»°C TIáº¾P parts cá»§a enemy\n'..
        'â˜… Weapon/raycast game sáº½ hit Ä‘Ãºng\n'..
        'â˜… Size tá»± restore khi táº¯t / player cháº¿t',
        C3(180,200,160))

    -- â”€â”€â”€â”€â”€â”€â”€â”€ TAB: ESP â”€â”€â”€â”€â”€â”€â”€â”€
    Section(tE, "ğŸ‘ ESP")
    Toggle(tE, "ğŸ”¥ Báº­t ESP",    Cfg.ESP.On,   function(v) Cfg.ESP.On   = v; ForceRecalcAll() end, VN.Do)
    Toggle(tE, "ğŸŒ«ï¸ Má» theo KC", Cfg.ESP.Fade, function(v) Cfg.ESP.Fade = v end)

    Section(tE, "ğŸ“Š HIá»‚N THá»Š")
    Toggle(tE, "âœ¨ Highlight",         Cfg.ESP.HL,   function(v) Cfg.ESP.HL   = v end, VN.Vang)
    Toggle(tE, "ğŸ“› TÃªn",               Cfg.ESP.Name, function(v) Cfg.ESP.Name = v end, VN.AnToan)
    Toggle(tE, "ğŸ”« VÅ© khÃ­ + Score",   Cfg.ESP.Wpn,  function(v) Cfg.ESP.Wpn  = v end, VN.CanhBao)
    Toggle(tE, "ğŸ“ Khoáº£ng cÃ¡ch",       Cfg.ESP.Dist, function(v) Cfg.ESP.Dist = v end)
    Toggle(tE, "â¤ï¸ HP",                Cfg.ESP.HP,   function(v) Cfg.ESP.HP   = v end, VN.NguyHiem)
    Toggle(tE, "ğŸ—ºï¸ Zone (Safe/Combat)", Cfg.ESP.Zone, function(v) Cfg.ESP.Zone = v end, VN.CanhBao)

    Slider(tE, "KC tá»‘i Ä‘a", 100, 1200, Cfg.ESP.MaxD, 0,
        function(v) Cfg.ESP.MaxD = v; ForceRecalcAll() end)

    -- â”€â”€â”€â”€â”€â”€â”€â”€ FLOAT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€
    local Fl = Instance.new("TextButton", Gui)
    Fl.Size  = UD2(0, 40, 0, 40)
    Fl.Position = UD2(0, 8, 0.35, 0)
    Fl.BackgroundColor3 = VN.Do
    Fl.Text  = "â˜…"
    Fl.TextColor3 = VN.Vang
    Fl.Font  = Enum.Font.GothamBlack
    Fl.TextSize = 16
    Fl.BorderSizePixel  = 0
    Fl.ZIndex = 50
    Fl.AutoButtonColor  = false
    Instance.new("UICorner", Fl).CornerRadius = UDim.new(1, 0)
    Instance.new("UIStroke", Fl).Color = VN.Vang

    local fd, fds, fps_pos = false, nil, nil
    Fl.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1
        or i.UserInputType == Enum.UserInputType.Touch then
            fd  = true
            fds = i.Position
            fps_pos = Fl.Position
        end
    end)
    Fl.InputChanged:Connect(function(i)
        if fd and (i.UserInputType == Enum.UserInputType.MouseMovement
        or i.UserInputType == Enum.UserInputType.Touch) then
            local d = i.Position - fds
            Fl.Position = UD2(fps_pos.X.Scale, fps_pos.X.Offset + d.X,
                               fps_pos.Y.Scale, fps_pos.Y.Offset + d.Y)
        end
    end)
    Fl.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1
        or i.UserInputType == Enum.UserInputType.Touch then
            if fds then
                local d = i.Position - fds
                if abs(d.X) < 10 and abs(d.Y) < 10 then
                    Main.Visible = not Main.Visible
                end
            end
            fd = false
        end
    end)

    task.spawn(function()
        local big = true
        while Fl.Parent do
            if big then TwSpring(Fl, {TextSize=20, Rotation=5},  0.4)
            else         TwSpring(Fl, {TextSize=16, Rotation=-5}, 0.4) end
            big = not big
            task.wait(0.5)
        end
    end)

    table.insert(Conns, UIS.InputBegan:Connect(function(i, gp)
        if gp then return end
        if i.KeyCode == Enum.KeyCode.RightControl
        or i.KeyCode == Enum.KeyCode.F6 then
            Main.Visible = not Main.Visible
        end
    end))

    return SLbl
end

local SLbl = BuildUI()

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- MAIN LOOP (Heartbeat ~10 FPS)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local fc, fps, lft, lup = 0, 60, tick(), 0

local heartbeat = RS.Heartbeat:Connect(function()
    local now = tick()
    local dt  = now - lft
    lft = now
    fps = fps * 0.9 + (1/max(dt, 0.001)) * 0.1

    if (now - lup) < 0.1 then return end
    lup = now

    local allP = Players:GetPlayers()
    local tc   = 0

    for _, player in ipairs(allP) do
        if player == LP then continue end

        local pd, upd = UpdatePlayer(player, now)

        if not pd.alive then
            if OrigSizes[player.UserId] then
                RestoreHitbox(player.UserId)
            end
            HideVisuals(player.UserId)
            continue
        end

        if upd then
            UpdateHitbox(player, pd)
            UpdateHBViz(player, pd)
            UpdateESP(player, pd)
        end

        if pd.target then tc += 1 end
    end

    fc += 1
    if fc % 10 == 0 and SLbl and SLbl.Parent then
        local ft = {}
        if Cfg.HB.On  then table.insert(ft, "HB")  end
        if Cfg.ESP.On then table.insert(ft, "ESP") end
        local fs = #ft > 0 and table.concat(ft, "Â·") or "Táº®T"
        SLbl.Text = string.format("ğŸ‡»ğŸ‡³ %s | ğŸ¯ %d | âš¡ %.0f", fs, tc, fps)
        SLbl.TextColor3 = tc > 0 and VN.Vang or VN.ChuMo
    end
end)
table.insert(Conns, heartbeat)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- KILL SWITCH
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
_G._FlowKill = function()
    for _, c in ipairs(Conns) do
        pcall(function() c:Disconnect() end)
    end
    Conns = {}

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LP then
            pcall(function() RestoreHitbox(p.UserId) end)
        end
    end

    if VR and VR.Parent then VR:Destroy() end
    pcall(function() CoreGui:FindFirstChild("Flow_VN_v65"):Destroy() end)

    WPN_CACHE = {}
    ZoneCache = {}
    OrigSizes = {}
    HBViz     = {}
    ESPViz    = {}
    PData     = {}

    print("ğŸ‡»ğŸ‡³ [FLOW v6.5] âœ… ÄÃ£ dá»n dáº¹p hoÃ n toÃ n!")
end

print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("ğŸ‡»ğŸ‡³ FLOW v6.5 â€” REWRITE + HITBOX FIX ğŸ‰")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… HITBOX: Resize parts tháº­t (HRP/Torso/Head...)")
print("âœ… HITBOX: Restore size khi táº¯t/cháº¿t/rá»i game")
print("âœ… ZONE: ThÃªm Region3 spatial check")
print("âœ… ZONE: Detect zone Part váº­t lÃ½ (khÃ´ng chá»‰ tag)")
print("âœ… REMOVE: KhÃ´ng cÃ²n Part fake + RenderStepped")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("â˜… Nháº¥n â˜… Ä‘á»ƒ má»Ÿ | Hotkey: RightCtrl / F6")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
