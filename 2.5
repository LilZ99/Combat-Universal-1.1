if _G._FlowKill then pcall(_G._FlowKill) end

--[[
    â˜… FLOW v6.4 â€” COMPLETE FIX â˜…
    â˜… FIX: Hitbox Follow + Zone Detect + Weapon â˜…
    â˜… ğŸ‡»ğŸ‡³ Há»’NG LONG VIá»†T NAM ğŸ‰ â˜…
]]

local Players = game:GetService("Players")
local RS = game:GetService("RunService")
local TS = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Teams = game:GetService("Teams")
local UIS = game:GetService("UserInputService")
local CS = game:GetService("CollectionService")
local LP = Players.LocalPlayer
local Cam = workspace.CurrentCamera

for _, n in ipairs({"Flow_Loading","Flow_VN_v5","Flow_VN_v51","Flow_VN_v52","Flow_VN_v53","Flow_VN_v54","Flow_VN_v6","Flow_VN_v61","Flow_VN_v62","Flow_VN_v63","Flow_VN_v64","Elysium_VR","HongLong_VR"}) do
    pcall(function() CoreGui:FindFirstChild(n):Destroy() end)
end

local V3, CF, C3, UD2 = Vector3.new, CFrame.new, Color3.fromRGB, UDim2.new
local abs, min, max, floor, clamp = math.abs, math.min, math.max, math.floor, math.clamp
local tick = tick

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ THEME ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
local VN = {
    Do = C3(218,37,29), DoSang = C3(255,60,50), DoTham = C3(150,20,15),
    Vang = C3(255,203,5), VangSang = C3(255,235,100), VangKim = C3(255,215,0),
    Nen = C3(12,6,6), NenNhat = C3(25,12,12), Vien = C3(80,30,25),
    AnToan = C3(34,197,94), NguyHiem = C3(239,68,68), CanhBao = C3(251,191,36), DacBiet = C3(180,100,255),
    Chu = C3(252,248,244), ChuMo = C3(148,118,112), ChuToi = C3(100,78,75),
}

local function Tw(o,p,t) if not o or not o.Parent then return end; pcall(function() TS:Create(o,TweenInfo.new(t or 0.25,Enum.EasingStyle.Quint,Enum.EasingDirection.Out),p):Play() end) end
local function TwSpring(o,p,t) if not o or not o.Parent then return end; pcall(function() TS:Create(o,TweenInfo.new(t or 0.35,Enum.EasingStyle.Back,Enum.EasingDirection.Out),p):Play() end) end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ LOADING ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
do
    local L = Instance.new("ScreenGui",CoreGui); L.Name="Flow_Loading"; L.IgnoreGuiInset=true; L.DisplayOrder=9999
    local BG = Instance.new("Frame",L); BG.Size=UD2(1,0,1,0); BG.BackgroundColor3=VN.DoTham; BG.BorderSizePixel=0
    local Card = Instance.new("Frame",BG); Card.Size=UD2(0,300,0,180); Card.Position=UD2(0.5,-150,0.5,-90); Card.BackgroundColor3=VN.Nen; Card.BorderSizePixel=0
    Instance.new("UICorner",Card).CornerRadius=UDim.new(0,14); Instance.new("UIStroke",Card).Color=VN.Do
    local Flag = Instance.new("Frame",Card); Flag.Size=UD2(0,50,0,32); Flag.Position=UD2(0.5,-25,0,12); Flag.BackgroundColor3=VN.Do; Flag.BorderSizePixel=0
    Instance.new("UICorner",Flag).CornerRadius=UDim.new(0,4)
    local Star = Instance.new("TextLabel",Flag); Star.Size=UD2(1,0,1,0); Star.BackgroundTransparency=1; Star.Text="â˜…"; Star.TextColor3=VN.Vang; Star.TextSize=20; Star.Font=Enum.Font.GothamBlack
    local Title = Instance.new("TextLabel",Card); Title.Size=UD2(1,0,0,24); Title.Position=UD2(0,0,0,48); Title.BackgroundTransparency=1; Title.Text="âš¡ FLOW v6.4"; Title.Font=Enum.Font.GothamBlack; Title.TextSize=18; Title.TextColor3=VN.Vang
    local Sub = Instance.new("TextLabel",Card); Sub.Size=UD2(1,0,0,14); Sub.Position=UD2(0,0,0,72); Sub.BackgroundTransparency=1; Sub.Text="ğŸ‰ COMPLETE FIX ğŸ‰"; Sub.Font=Enum.Font.GothamBold; Sub.TextSize=9; Sub.TextColor3=VN.VangSang
    local PBCont = Instance.new("Frame",Card); PBCont.Size=UD2(0.7,0,0,10); PBCont.Position=UD2(0.15,0,0,100); PBCont.BackgroundColor3=C3(30,12,12); PBCont.BorderSizePixel=0
    Instance.new("UICorner",PBCont).CornerRadius=UDim.new(0,5)
    local PBFill = Instance.new("Frame",PBCont); PBFill.Size=UD2(0,0,1,0); PBFill.BackgroundColor3=VN.Do; PBFill.BorderSizePixel=0
    Instance.new("UICorner",PBFill).CornerRadius=UDim.new(0,5)
    local Status = Instance.new("TextLabel",Card); Status.Size=UD2(1,0,0,12); Status.Position=UD2(0,0,0,120); Status.BackgroundTransparency=1; Status.Font=Enum.Font.GothamMedium; Status.TextSize=9; Status.TextColor3=VN.ChuMo
    local Footer = Instance.new("TextLabel",Card); Footer.Size=UD2(1,0,0,12); Footer.Position=UD2(0,0,1,-16); Footer.BackgroundTransparency=1; Footer.Text="ğŸ‡»ğŸ‡³ Viá»‡t Nam"; Footer.Font=Enum.Font.GothamMedium; Footer.TextSize=8; Footer.TextColor3=VN.ChuMo
    task.spawn(function()
        for i=0,100,25 do Status.Text=i==100 and "âœ… XONG!" or "Loading..."; Tw(PBFill,{Size=UD2(i/100,0,1,0)},0.1); task.wait(0.12) end
        task.wait(0.15); Tw(BG,{BackgroundTransparency=1},0.2); Tw(Card,{BackgroundTransparency=1},0.2); task.wait(0.25); L:Destroy()
    end)
end
task.wait(0.9)

-- â•â•â•â•â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•
local Cfg = {
    NhamTatCa = false,
    Team = {},
    HB = {On=false, Size=18, Trans=0.8, MaxD=300},
    ESP = {On=false, Fade=true, MaxD=1000, HL=true, Name=true, Dist=true, HP=true, Wpn=true, Zone=true},
}

local HitboxParts, HBViz, ESPViz, PData = {}, {}, {}, {}
local Conns = {}
local VR = Instance.new("Folder",CoreGui); VR.Name="HongLong_VR"

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ§  WEAPON DETECTION (SUPER LOW THRESHOLD) â•â•â•â•â•â•â•â•â•â•â•
local WPN_CACHE = {}

-- â˜…â˜…â˜… MEGA PATTERNS - gáº§n nhÆ° detect Ä‘Æ°á»£c táº¥t cáº£ â˜…â˜…â˜…
local WPN_NAMES = {
    -- English
    "gun","pistol","rifle","shotgun","sniper","smg","lmg","rpg","launcher","weapon","firearm",
    "ak","glock","deagle","m4","m16","mp5","mp7","mp9","uzi","vector","scar","famas","aug","awp","awm",
    "knife","sword","blade","katana","machete","axe","dagger","karambit","bowie","bayonet",
    "revolver","magnum","desert","eagle","beretta","colt","usp","p90","mac","tec","five","seven",
    "minigun","gatling","turret","cannon","laser","plasma","ray","blaster","phaser",
    "bow","crossbow","arrow","grenade","explosive","bomb","mine","c4","dynamite",
    "kar","mosin","springfield","dragunov","intervention","barrett","m24","l96","scout",
    "spas","benelli","mossberg","remington","saiga","aa12","pump","double",
    "thompson","sten","ppsh","grease","m3","p250","cz","negev","m249","pkm","rpk",
    "combat","tactical","military","assault","auto","semi","burst","silenced","suppressed",
    -- Short forms
    "ar","sr","dmr","br","hg","sg","mg","rl","gl","smg","lmg","hmg",
    -- Vietnamese
    "sung","sungtruong","sungngan","sungluc","dao","kiem","bom","vukhi","luudan",
    -- Game specific
    "peacekeeper","wingman","flatline","havoc","devotion","spitfire","mastiff","mozambique",
    "r99","car","alternator","prowler","hemlock","bocek","sentinel","longbow","kraber",
    "vandal","phantom","operator","sheriff","spectre","stinger","bulldog","guardian","odin",
    -- Generic weapon words
    "shoot","fire","kill","attack","damage","hit","bang","boom","slash","stab","cut",
}

local WPN_SAFE = {
    "shovel","hoe","rake","seed","water","fish","rod","pole","bucket","pail",
    "wrench","screwdriver","hammer tool","paint","brush","key","keycard","card",
    "flashlight","torch","lantern","camera","binocular","phone","radio","tablet",
    "medkit","bandage","medicine","health","food","drink","snack","money","cash","coin",
    "book","map","compass","note","paper","flower","plant","furniture","decoration",
    "instrument","guitar","piano","drum","flute","toy","ball","frisbee","pet","leash",
}

local function FastMatch(str, list)
    for i=1,#list do if str:find(list[i],1,true) then return true end end
    return false
end

local function AnalyzeWeapon(tool)
    if not tool or not tool:IsA("Tool") then return false, 0 end
    
    local cached = WPN_CACHE[tool]
    if cached and (tick()-cached.t) < 20 then return cached.w, cached.s end
    
    local name = tool.Name:lower():gsub("[%-%_%.%s%d]","")
    
    -- Quick reject
    if FastMatch(name, WPN_SAFE) then
        WPN_CACHE[tool] = {w=false, s=0, t=tick()}
        return false, 0
    end
    
    local score = 0
    
    -- â˜… Name check (HIGH WEIGHT)
    if FastMatch(name, WPN_NAMES) then
        score = score + 50
    end
    
    -- â˜… Check descendants (limit 20)
    local ok, descs = pcall(function() return tool:GetDescendants() end)
    if ok then
        local count = 0
        for _, d in ipairs(descs) do
            if count > 20 then break end
            count = count + 1
            local dn = d.Name:lower()
            
            -- Parts
            if d:IsA("BasePart") or d:IsA("Attachment") then
                if dn:find("muzzle") or dn:find("barrel") or dn:find("trigger") or dn:find("mag") or 
                   dn:find("scope") or dn:find("sight") or dn:find("grip") or dn:find("stock") or
                   dn:find("blade") or dn:find("handle") or dn:find("bolt") or dn:find("chamber") then
                    score = score + 12
                end
            end
            
            -- Sounds
            if d:IsA("Sound") then
                if dn:find("shoot") or dn:find("fire") or dn:find("gun") or dn:find("reload") or 
                   dn:find("shot") or dn:find("bang") or dn:find("slash") or dn:find("swing") or
                   dn:find("attack") or dn:find("hit") then
                    score = score + 15
                end
            end
            
            -- Remotes
            if d:IsA("RemoteEvent") or d:IsA("RemoteFunction") or d:IsA("BindableEvent") then
                if dn:find("fire") or dn:find("shoot") or dn:find("attack") or dn:find("damage") or 
                   dn:find("hit") or dn:find("reload") or dn:find("equip") then
                    score = score + 12
                end
            end
        end
    end
    
    -- Handle shape
    local handle = tool:FindFirstChild("Handle")
    if handle and handle:IsA("BasePart") then
        local s = handle.Size
        local ratio = max(s.X,s.Y,s.Z) / max(min(s.X,s.Y,s.Z), 0.1)
        if ratio > 2.5 then score = score + 8 end
    end
    
    -- â˜…â˜…â˜… SUPER LOW THRESHOLD: 8 â˜…â˜…â˜…
    local isWeapon = score >= 8
    
    WPN_CACHE[tool] = {w=isWeapon, s=score, t=tick()}
    return isWeapon, score
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ—ºï¸ ZONE DETECTION (SIMPLE + RELIABLE) â•â•â•â•â•â•â•â•â•â•â•
--[[
    â˜… LOGIC ÄÆ N GIáº¢N:
    - Check ForceField â†’ SAFE
    - Check Attribute/Value/Tag cÃ³ chá»©a "safe" â†’ SAFE
    - CÃ²n láº¡i â†’ COMBAT (cÃ³ thá»ƒ target)
]]

local ZONE_SAFE, ZONE_COMBAT = 1, 2
local ZoneCache = {}

local function CheckSafeZone(player)
    local char = player.Character
    if not char then return false end
    
    local uid = player.UserId
    local cached = ZoneCache[uid]
    if cached and (tick()-cached.t) < 0.4 then return cached.r end
    
    -- â˜… ForceField = 100% safe
    if char:FindFirstChildOfClass("ForceField") then
        ZoneCache[uid] = {r=true, t=tick()}
        return true
    end
    
    -- â˜… Check common safe indicators
    local checkTargets = {player, char}
    local safeKeywords = {"safe","insafe","safezone","lobby","spawn","protected","nopvp","immune","invulnerable","peaceful","godmode"}
    
    for _, target in ipairs(checkTargets) do
        -- Attributes
        local ok1, attrs = pcall(function() return target:GetAttributes() end)
        if ok1 and attrs then
            for attrName, attrVal in pairs(attrs) do
                local nameLower = attrName:lower()
                for _, kw in ipairs(safeKeywords) do
                    if nameLower:find(kw, 1, true) then
                        if attrVal == true or (type(attrVal) == "number" and attrVal > 0) then
                            ZoneCache[uid] = {r=true, t=tick()}
                            return true
                        end
                    end
                end
            end
        end
        
        -- Value objects
        local ok2, children = pcall(function() return target:GetChildren() end)
        if ok2 then
            for _, obj in ipairs(children) do
                if obj:IsA("BoolValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") or obj:IsA("StringValue") then
                    local nameLower = obj.Name:lower()
                    for _, kw in ipairs(safeKeywords) do
                        if nameLower:find(kw, 1, true) then
                            local vok, val = pcall(function() return obj.Value end)
                            if vok then
                                if (obj:IsA("BoolValue") and val == true) or
                                   ((obj:IsA("IntValue") or obj:IsA("NumberValue")) and val > 0) or
                                   (obj:IsA("StringValue") and (val == "true" or val == "1" or val:lower() == "yes")) then
                                    ZoneCache[uid] = {r=true, t=tick()}
                                    return true
                                end
                            end
                        end
                    end
                end
            end
        end
        
        -- Tags
        local ok3, tags = pcall(function() return CS:GetTags(target) end)
        if ok3 then
            for _, tag in ipairs(tags) do
                local tagLower = tag:lower()
                for _, kw in ipairs(safeKeywords) do
                    if tagLower:find(kw, 1, true) then
                        ZoneCache[uid] = {r=true, t=tick()}
                        return true
                    end
                end
            end
        end
    end
    
    -- â˜… Not in safe zone = COMBAT
    ZoneCache[uid] = {r=false, t=tick()}
    return false
end

-- â•â•â•â•â•â•â•â•â•â•â• UTILITIES â•â•â•â•â•â•â•â•â•â•â•
local function MyRoot()
    local c = LP.Character
    return c and c:FindFirstChild("HumanoidRootPart")
end

local function GetDist(part)
    local mr = MyRoot()
    if not mr or not part then return 9999 end
    return (mr.Position - part.Position).Magnitude
end

local function HPColor(r)
    r = clamp(r, 0, 1)
    if r > 0.6 then return VN.AnToan
    elseif r > 0.3 then return VN.CanhBao
    else return VN.NguyHiem end
end

local function ShouldTarget(player, inSafe)
    if player == LP then return false end
    if inSafe then return false end  -- â˜… KHÃ”NG target player trong safe zone
    if Cfg.NhamTatCa then return true end
    
    local key = player.Team and player.Team.Name or "__NO_TEAM__"
    local cfg = Cfg.Team[key] or Cfg.Team["__NO_TEAM__"]
    
    if not cfg then return true end
    if cfg.Mode == 0 then return false end
    if cfg.Mode == 1 then return true end
    if cfg.Mode == 2 then return true end  -- Mode 2 = target all not in safe
    
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â• PLAYER DATA â•â•â•â•â•â•â•â•â•â•â•
local function GetPD(uid)
    if not PData[uid] then
        PData[uid] = {
            lastUpdate = 0,
            alive = false,
            target = false,
            hbOn = false,
            espOn = false,
            dist = 9999,
            inSafe = false,
            hasWeapon = false,
            weaponName = nil,
            weaponScore = 0,
            hp = 100,
            maxHp = 100,
            hpRatio = 1,
            rootPart = nil,
            espCache = {},
        }
    end
    return PData[uid]
end

local function UpdatePlayer(player, now)
    local uid = player.UserId
    local pd = GetPD(uid)
    
    -- Rate limit
    local rate = pd.dist < 100 and 0.08 or 0.15
    if (now - pd.lastUpdate) < rate then return pd, false end
    pd.lastUpdate = now
    
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local root = char and char:FindFirstChild("HumanoidRootPart")
    
    pd.alive = char ~= nil and hum ~= nil and root ~= nil and hum.Health > 0
    pd.rootPart = root
    
    if not pd.alive then
        pd.target = false
        pd.hbOn = false
        pd.espOn = false
        return pd, true
    end
    
    pd.dist = GetDist(root)
    pd.hp = hum.Health
    pd.maxHp = max(hum.MaxHealth, 1)
    pd.hpRatio = clamp(pd.hp / pd.maxHp, 0, 1)
    
    -- Zone check
    pd.inSafe = CheckSafeZone(player)
    
    -- Weapon check
    local tool = char:FindFirstChildOfClass("Tool")
    if tool then
        local isW, score = AnalyzeWeapon(tool)
        pd.hasWeapon = isW
        pd.weaponName = tool.Name
        pd.weaponScore = score
    else
        pd.hasWeapon = false
        pd.weaponName = nil
        pd.weaponScore = 0
    end
    
    -- Target logic
    pd.target = ShouldTarget(player, pd.inSafe)
    
    -- Enable features
    pd.hbOn = Cfg.HB.On and pd.target and pd.dist <= Cfg.HB.MaxD
    pd.espOn = Cfg.ESP.On and pd.target and pd.dist <= Cfg.ESP.MaxD
    
    return pd, true
end

local function ForceRecalcAll()
    for uid, pd in pairs(PData) do
        pd.lastUpdate = 0
        pd.espCache = {}
    end
    WPN_CACHE = {}
    ZoneCache = {}
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ“¦ HITBOX SYSTEM (FIX: UPDATE CFRAME Má»–I FRAME) â•â•â•â•â•â•â•â•â•â•â•
--[[
    â˜…â˜…â˜… FIX CHÃNH â˜…â˜…â˜…
    - KHÃ”NG dÃ¹ng Weld (khÃ´ng hoáº¡t Ä‘á»™ng vá»›i Part má»›i)
    - Thay vÃ o Ä‘Ã³: Update CFrame trong RenderStepped
    - Part sáº½ LUÃ”N follow player real-time
]]

local function DestroyHitbox(uid)
    if HitboxParts[uid] then
        pcall(function() HitboxParts[uid]:Destroy() end)
        HitboxParts[uid] = nil
    end
end

local function CreateHitbox(uid, size)
    DestroyHitbox(uid)
    
    local hb = Instance.new("Part")
    hb.Name = "FlowHB_" .. uid
    hb.Size = V3(size, size, size)
    hb.Transparency = 0.9  -- â˜… Gáº§n nhÆ° vÃ´ hÃ¬nh nhÆ°ng váº«n detect Ä‘Æ°á»£c
    hb.Color = C3(255, 0, 0)
    hb.Material = Enum.Material.ForceField
    hb.CanCollide = false
    hb.CanTouch = false
    hb.CanQuery = true  -- â˜… CRITICAL: Raycast sáº½ hit
    hb.Massless = true
    hb.Anchored = true  -- â˜… Anchored = true, update CFrame manually
    hb.CastShadow = false
    hb.Parent = VR  -- â˜… Parent vÃ o folder riÃªng, khÃ´ng vÃ o character
    
    HitboxParts[uid] = hb
    return hb
end

local function UpdateHitbox(player, pd)
    local uid = player.UserId
    
    if not pd.hbOn or not pd.alive or not pd.rootPart then
        DestroyHitbox(uid)
        return
    end
    
    local hb = HitboxParts[uid]
    
    -- Create if not exists
    if not hb or not hb.Parent then
        hb = CreateHitbox(uid, Cfg.HB.Size)
    end
    
    -- â˜…â˜…â˜… UPDATE SIZE â˜…â˜…â˜…
    local targetSize = Cfg.HB.Size
    if abs(hb.Size.X - targetSize) > 1 then
        hb.Size = V3(targetSize, targetSize, targetSize)
    end
    
    -- â˜…â˜…â˜… UPDATE POSITION (follow player) â˜…â˜…â˜…
    hb.CFrame = pd.rootPart.CFrame
end

-- â˜…â˜…â˜… RENDER LOOP: Update hitbox positions má»—i frame â˜…â˜…â˜…
local function UpdateAllHitboxPositions()
    for uid, hb in pairs(HitboxParts) do
        if hb and hb.Parent then
            local pd = PData[uid]
            if pd and pd.alive and pd.rootPart and pd.rootPart.Parent then
                hb.CFrame = pd.rootPart.CFrame
            else
                -- Player dead or gone, destroy hitbox
                DestroyHitbox(uid)
            end
        end
    end
end

-- â•â•â•â•â•â•â•â•â•â•â• HITBOX VIZ â•â•â•â•â•â•â•â•â•â•â•
local function EnsureHBViz(uid)
    if HBViz[uid] and HBViz[uid].Parent then return HBViz[uid] end
    local f = Instance.new("Folder", VR)
    f.Name = "HBViz_" .. uid
    local sb = Instance.new("SelectionBox", f)
    sb.Name = "Box"
    sb.LineThickness = 0.035
    HBViz[uid] = f
    return f
end

local function UpdateHBViz(player, pd)
    local uid = player.UserId
    
    if not pd.hbOn or not pd.alive then
        local f = HBViz[uid]
        if f then
            local sb = f:FindFirstChild("Box")
            if sb then sb.Adornee = nil end
        end
        return
    end
    
    local f = EnsureHBViz(uid)
    local sb = f:FindFirstChild("Box")
    if not sb then return end
    
    local hb = HitboxParts[uid]
    if not hb or not hb.Parent then return end
    
    -- Color based on state
    local col
    if pd.inSafe then
        col = VN.ChuMo
    elseif pd.hasWeapon then
        col = VN.NguyHiem
    else
        col = VN.Vang
    end
    
    sb.Adornee = hb
    sb.Color3 = col
    sb.SurfaceColor3 = col
    sb.SurfaceTransparency = Cfg.HB.Trans
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‘ï¸ ESP â•â•â•â•â•â•â•â•â•â•â•
local function EnsureESP(uid)
    if ESPViz[uid] and ESPViz[uid].Parent then return ESPViz[uid] end
    
    local f = Instance.new("Folder", VR)
    f.Name = "ESP_" .. uid
    
    local hl = Instance.new("Highlight", f)
    hl.Name = "HL"
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Enabled = false
    
    local bg = Instance.new("BillboardGui", f)
    bg.Name = "BG"
    bg.AlwaysOnTop = true
    bg.Size = UD2(0, 150, 0, 95)
    bg.StudsOffset = V3(0, 3, 0)
    bg.MaxDistance = 1200
    bg.Enabled = false
    
    local ct = Instance.new("Frame", bg)
    ct.Name = "CT"
    ct.Size = UD2(1, 0, 1, 0)
    ct.BackgroundTransparency = 1
    
    local ly = Instance.new("UIListLayout", ct)
    ly.HorizontalAlignment = Enum.HorizontalAlignment.Center
    ly.Padding = UDim.new(0, 2)
    
    local function ML(nm, ord, h, sz)
        local l = Instance.new("TextLabel", ct)
        l.Name = nm
        l.LayoutOrder = ord
        l.Size = UD2(1, 0, 0, h)
        l.BackgroundTransparency = 1
        l.Font = Enum.Font.GothamBold
        l.TextSize = sz
        l.TextStrokeTransparency = 0
        l.TextStrokeColor3 = C3(0, 0, 0)
        l.RichText = true
        l.Text = ""
    end
    
    ML("NL", 1, 14, 11)
    ML("ZL", 2, 12, 9)
    ML("WL", 3, 12, 9)
    ML("DL", 4, 12, 10)
    ML("HL2", 5, 10, 9)
    
    local hpBg = Instance.new("Frame", ct)
    hpBg.Name = "HPBg"
    hpBg.LayoutOrder = 6
    hpBg.Size = UD2(0.6, 0, 0, 5)
    hpBg.BackgroundColor3 = C3(30, 10, 10)
    hpBg.BorderSizePixel = 0
    Instance.new("UICorner", hpBg).CornerRadius = UDim.new(1, 0)
    
    local hpF = Instance.new("Frame", hpBg)
    hpF.Name = "HPF"
    hpF.Size = UD2(1, 0, 1, 0)
    hpF.BackgroundColor3 = VN.AnToan
    hpF.BorderSizePixel = 0
    Instance.new("UICorner", hpF).CornerRadius = UDim.new(1, 0)
    
    ESPViz[uid] = f
    return f
end

local function UpdateESP(player, pd)
    local uid = player.UserId
    
    if not pd.espOn or not pd.alive or not pd.rootPart then
        local f = ESPViz[uid]
        if f then
            local hl = f:FindFirstChild("HL")
            if hl then hl.Enabled = false end
            local bg = f:FindFirstChild("BG")
            if bg then bg.Enabled = false end
        end
        return
    end
    
    local f = EnsureESP(uid)
    local char = player.Character
    
    -- Lazy update check
    local cache = pd.espCache
    local wpnName = pd.weaponName or ""
    if cache.hp == floor(pd.hp) and cache.safe == pd.inSafe and cache.weapon == wpnName and abs((cache.dist or 0) - pd.dist) < 20 then
        return
    end
    cache.hp = floor(pd.hp)
    cache.safe = pd.inSafe
    cache.weapon = wpnName
    cache.dist = pd.dist
    
    local dist = pd.dist
    local fade = Cfg.ESP.Fade and clamp((dist - 50) / 450, 0, 1) or 0
    local hpC = HPColor(pd.hpRatio)
    
    -- Base color
    local baseCol
    if pd.inSafe then
        baseCol = VN.ChuMo
    elseif pd.hasWeapon then
        baseCol = VN.NguyHiem
    else
        baseCol = VN.Vang
    end
    
    local tf = max(fade * 0.5, 0.08)
    
    -- Highlight
    local hl = f:FindFirstChild("HL")
    if hl and Cfg.ESP.HL then
        hl.Enabled = true
        hl.Adornee = char
        hl.FillColor = baseCol
        hl.OutlineColor = pd.hasWeapon and VN.NguyHiem or VN.Vang
        hl.FillTransparency = max(0.15, fade * 0.6)
        hl.OutlineTransparency = fade * 0.5
    elseif hl then
        hl.Enabled = false
    end
    
    -- Billboard
    local bg = f:FindFirstChild("BG")
    if bg then
        bg.Adornee = pd.rootPart
        bg.Enabled = true
    end
    
    local ct = bg and bg:FindFirstChild("CT")
    if not ct then return end
    
    local function SL(nm, txt, col)
        local l = ct:FindFirstChild(nm)
        if l then
            l.Text = txt
            if col then l.TextColor3 = col end
            l.TextTransparency = tf
            l.Visible = txt ~= ""
        end
    end
    
    -- Name
    if Cfg.ESP.Name then
        SL("NL", string.format("<b>%s</b>", player.Name), baseCol)
    else
        SL("NL", "")
    end
    
    -- Zone status
    if Cfg.ESP.Zone then
        if pd.inSafe then
            SL("ZL", '<font color="#888">ğŸ›¡ï¸ AN TOÃ€N</font>')
        else
            SL("ZL", '<font color="#AA66FF">âš”ï¸ CHIáº¾N Äáº¤U</font>')
        end
    else
        SL("ZL", "")
    end
    
    -- Weapon
    if Cfg.ESP.Wpn and pd.weaponName then
        local wColor = pd.hasWeapon and "#FF4400" or "#888888"
        local wIcon = pd.hasWeapon and "ğŸ”«" or "ğŸ“¦"
        SL("WL", string.format('<font color="%s">%s %s [%d]</font>', wColor, wIcon, pd.weaponName, pd.weaponScore))
    else
        SL("WL", "")
    end
    
    -- Distance
    if Cfg.ESP.Dist then
        SL("DL", string.format("%.0f m", dist), VN.AnToan:Lerp(VN.NguyHiem, clamp(dist / Cfg.ESP.MaxD, 0, 1)))
    else
        SL("DL", "")
    end
    
    -- HP
    if Cfg.ESP.HP then
        local hpHex = string.format("#%02X%02X%02X", floor(hpC.R * 255), floor(hpC.G * 255), floor(hpC.B * 255))
        SL("HL2", string.format('<font color="%s">%.0f HP</font>', hpHex, pd.hp))
    else
        SL("HL2", "")
    end
    
    -- HP Bar
    local hpBg2 = ct:FindFirstChild("HPBg")
    local hpFill = hpBg2 and hpBg2:FindFirstChild("HPF")
    if hpBg2 and Cfg.ESP.HP then
        hpBg2.Visible = true
        if hpFill then
            hpFill.Size = UD2(pd.hpRatio, 0, 1, 0)
            hpFill.BackgroundColor3 = hpC
        end
    elseif hpBg2 then
        hpBg2.Visible = false
    end
end

-- â•â•â•â•â•â•â•â•â•â•â• CLEANUP â•â•â•â•â•â•â•â•â•â•â•
local function FullCleanup(player)
    local uid = player.UserId
    DestroyHitbox(uid)
    PData[uid] = nil
    ZoneCache[uid] = nil
end

local function HideVisuals(uid)
    local hb = HBViz[uid]
    if hb then
        local sb = hb:FindFirstChild("Box")
        if sb then sb.Adornee = nil end
    end
    local esp = ESPViz[uid]
    if esp then
        local hl = esp:FindFirstChild("HL")
        if hl then hl.Enabled = false end
        local bg = esp:FindFirstChild("BG")
        if bg then bg.Enabled = false end
    end
end

local function HookPlayer(player)
    table.insert(Conns, player.CharacterAdded:Connect(function()
        local uid = player.UserId
        DestroyHitbox(uid)
        HideVisuals(uid)
        local pd = GetPD(uid)
        pd.lastUpdate = 0
        pd.espCache = {}
    end))
    table.insert(Conns, player.CharacterRemoving:Connect(function()
        FullCleanup(player)
    end))
end

local function SyncTeams()
    for _, t in ipairs(Teams:GetChildren()) do
        if t:IsA("Team") and not Cfg.Team[t.Name] then
            Cfg.Team[t.Name] = {Mode = 0, Color = t.TeamColor.Color}
        end
    end
    Cfg.Team["__NO_TEAM__"] = Cfg.Team["__NO_TEAM__"] or {Mode = 0, Color = Color3.new(1, 1, 1)}
end

SyncTeams()
table.insert(Conns, Teams.ChildAdded:Connect(SyncTeams))
for _, p in ipairs(Players:GetPlayers()) do HookPlayer(p) end
table.insert(Conns, Players.PlayerAdded:Connect(HookPlayer))
table.insert(Conns, Players.PlayerRemoving:Connect(function(p)
    FullCleanup(p)
    local uid = p.UserId
    if HBViz[uid] then pcall(function() HBViz[uid]:Destroy() end); HBViz[uid] = nil end
    if ESPViz[uid] then pcall(function() ESPViz[uid]:Destroy() end); ESPViz[uid] = nil end
end))

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ UI VIá»†T NAM ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
local function BuildUI()
    local Gui = Instance.new("ScreenGui", CoreGui)
    Gui.Name = "Flow_VN_v64"
    Gui.ResetOnSpawn = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.DisplayOrder = 100
    
    local Main = Instance.new("Frame", Gui)
    Main.Name = "Main"
    Main.Size = UD2(0, 330, 0, 440)
    Main.Position = UD2(0.5, -165, 0.5, -220)
    Main.BackgroundColor3 = VN.Nen
    Main.BorderSizePixel = 0
    Main.Active = true
    Main.Draggable = true
    Main.ClipsDescendants = true
    Main.Visible = false
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 12)
    Instance.new("UIStroke", Main).Color = VN.Do
    
    -- Header
    local Hdr = Instance.new("Frame", Main)
    Hdr.Size = UD2(1, 0, 0, 42)
    Hdr.BackgroundColor3 = VN.Do
    Hdr.BorderSizePixel = 0
    Instance.new("UICorner", Hdr).CornerRadius = UDim.new(0, 12)
    local HFix = Instance.new("Frame", Hdr)
    HFix.Size = UD2(1, 0, 0, 12)
    HFix.Position = UD2(0, 0, 1, -12)
    HFix.BackgroundColor3 = VN.Do
    HFix.BorderSizePixel = 0
    
    local FI = Instance.new("TextLabel", Hdr)
    FI.Size = UD2(0, 20, 0, 20)
    FI.Position = UD2(0, 8, 0.5, -10)
    FI.BackgroundTransparency = 1
    FI.Text = "ğŸ‡»ğŸ‡³"
    FI.TextSize = 14
    
    local TL = Instance.new("TextLabel", Hdr)
    TL.Size = UD2(1, -70, 0, 18)
    TL.Position = UD2(0, 32, 0, 6)
    TL.BackgroundTransparency = 1
    TL.Text = "âš¡ FLOW v6.4"
    TL.Font = Enum.Font.GothamBlack
    TL.TextSize = 14
    TL.TextColor3 = VN.Vang
    TL.TextXAlignment = Enum.TextXAlignment.Left
    
    local ST = Instance.new("TextLabel", Hdr)
    ST.Size = UD2(0, 100, 0, 10)
    ST.Position = UD2(0, 32, 0, 24)
    ST.BackgroundTransparency = 1
    ST.Text = "COMPLETE FIX"
    ST.Font = Enum.Font.GothamMedium
    ST.TextSize = 7
    ST.TextColor3 = VN.VangSang
    ST.TextXAlignment = Enum.TextXAlignment.Left
    
    local CB = Instance.new("TextButton", Hdr)
    CB.Size = UD2(0, 22, 0, 22)
    CB.Position = UD2(1, -28, 0.5, -11)
    CB.Text = "âœ•"
    CB.TextColor3 = VN.Vang
    CB.Font = Enum.Font.GothamBold
    CB.TextSize = 11
    CB.BackgroundColor3 = VN.DoTham
    CB.BorderSizePixel = 0
    CB.AutoButtonColor = false
    Instance.new("UICorner", CB).CornerRadius = UDim.new(0, 5)
    CB.MouseButton1Click:Connect(function() Main.Visible = false end)
    
    -- Tab Bar
    local TB = Instance.new("Frame", Main)
    TB.Size = UD2(1, -8, 0, 28)
    TB.Position = UD2(0, 4, 0, 46)
    TB.BackgroundColor3 = VN.NenNhat
    TB.BorderSizePixel = 0
    Instance.new("UICorner", TB).CornerRadius = UDim.new(0, 7)
    local tbLy = Instance.new("UIListLayout", TB)
    tbLy.FillDirection = Enum.FillDirection.Horizontal
    tbLy.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tbLy.VerticalAlignment = Enum.VerticalAlignment.Center
    tbLy.Padding = UDim.new(0, 3)
    
    local Content = Instance.new("Frame", Main)
    Content.Size = UD2(1, -8, 1, -112)
    Content.Position = UD2(0, 4, 0, 78)
    Content.BackgroundTransparency = 1
    Content.ClipsDescendants = true
    
    local SBar = Instance.new("Frame", Main)
    SBar.Size = UD2(1, -8, 0, 22)
    SBar.Position = UD2(0, 4, 1, -28)
    SBar.BackgroundColor3 = VN.NenNhat
    SBar.BorderSizePixel = 0
    Instance.new("UICorner", SBar).CornerRadius = UDim.new(0, 5)
    
    local SLbl = Instance.new("TextLabel", SBar)
    SLbl.Size = UD2(1, -6, 1, 0)
    SLbl.Position = UD2(0, 3, 0, 0)
    SLbl.BackgroundTransparency = 1
    SLbl.Text = "ğŸ‡»ğŸ‡³ FLOW v6.4"
    SLbl.Font = Enum.Font.GothamMedium
    SLbl.TextSize = 8
    SLbl.TextColor3 = VN.ChuMo
    SLbl.TextXAlignment = Enum.TextXAlignment.Left
    
    local tabs = {}
    
    local function MkScroll()
        local s = Instance.new("ScrollingFrame", Content)
        s.Size = UD2(1, 0, 1, 0)
        s.BackgroundTransparency = 1
        s.AutomaticCanvasSize = Enum.AutomaticSize.Y
        s.ScrollBarThickness = 3
        s.ScrollBarImageColor3 = VN.Do
        s.BorderSizePixel = 0
        s.Visible = false
        s.CanvasSize = UD2(0, 0, 0, 0)
        local ly = Instance.new("UIListLayout", s)
        ly.Padding = UDim.new(0, 4)
        ly.SortOrder = Enum.SortOrder.LayoutOrder
        Instance.new("UIPadding", s).PaddingTop = UDim.new(0, 2)
        return s
    end
    
    local function MkTab(nm, ic)
        local btn = Instance.new("TextButton", TB)
        btn.Size = UD2(0, 95, 0, 22)
        btn.Text = ic .. " " .. nm
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 9
        btn.TextColor3 = VN.ChuToi
        btn.BackgroundColor3 = VN.Nen
        btn.BackgroundTransparency = 0.5
        btn.BorderSizePixel = 0
        btn.AutoButtonColor = false
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
        
        local ind = Instance.new("Frame", btn)
        ind.Size = UD2(0.3, 0, 0, 2)
        ind.Position = UD2(0.35, 0, 1, -3)
        ind.BackgroundColor3 = VN.Vang
        ind.BorderSizePixel = 0
        ind.Visible = false
        Instance.new("UICorner", ind).CornerRadius = UDim.new(1, 0)
        
        local scr = MkScroll()
        tabs[nm] = {btn = btn, ind = ind, scroll = scr}
        
        btn.MouseButton1Click:Connect(function()
            for n, d in pairs(tabs) do
                local a = (n == nm)
                d.scroll.Visible = a
                d.ind.Visible = a
                Tw(d.btn, {TextColor3 = a and VN.Vang or VN.ChuToi, BackgroundColor3 = a and C3(50, 20, 18) or VN.Nen, BackgroundTransparency = a and 0.1 or 0.5}, 0.15)
            end
        end)
        
        return scr
    end
    
    local function Card(p, h)
        local f = Instance.new("Frame", p)
        f.Size = UD2(1, -4, 0, h or 34)
        f.BackgroundColor3 = VN.NenNhat
        f.BackgroundTransparency = 0.15
        f.BorderSizePixel = 0
        Instance.new("UICorner", f).CornerRadius = UDim.new(0, 7)
        return f
    end
    
    local function Section(p, t)
        local f = Card(p, 20)
        f.BackgroundColor3 = C3(50, 18, 14)
        local l = Instance.new("TextLabel", f)
        l.Size = UD2(1, -8, 1, 0)
        l.Position = UD2(0, 4, 0, 0)
        l.BackgroundTransparency = 1
        l.Text = t
        l.Font = Enum.Font.GothamBold
        l.TextSize = 9
        l.TextColor3 = VN.Vang
        l.TextXAlignment = Enum.TextXAlignment.Left
    end
    
    local function Toggle(p, lbl, init, cb, col)
        col = col or VN.Do
        local f = Card(p, 32)
        local txt = Instance.new("TextLabel", f)
        txt.Size = UD2(1, -50, 1, 0)
        txt.Position = UD2(0, 7, 0, 0)
        txt.BackgroundTransparency = 1
        txt.Text = lbl
        txt.Font = Enum.Font.Gotham
        txt.TextSize = 9
        txt.TextColor3 = init and VN.Chu or VN.ChuMo
        txt.TextXAlignment = Enum.TextXAlignment.Left
        
        local trk = Instance.new("Frame", f)
        trk.Size = UD2(0, 34, 0, 16)
        trk.Position = UD2(1, -42, 0.5, -8)
        trk.BackgroundColor3 = init and col or C3(50, 35, 35)
        trk.BorderSizePixel = 0
        Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)
        
        local thb = Instance.new("Frame", trk)
        thb.Size = UD2(0, 10, 0, 10)
        thb.Position = init and UD2(1, -13, 0.5, -5) or UD2(0, 3, 0.5, -5)
        thb.BackgroundColor3 = init and Color3.new(1, 1, 1) or C3(140, 120, 120)
        thb.BorderSizePixel = 0
        Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)
        
        local on = init
        local btn = Instance.new("TextButton", f)
        btn.Size = UD2(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text = ""
        btn.ZIndex = 5
        
        btn.MouseButton1Click:Connect(function()
            on = not on
            TwSpring(trk, {BackgroundColor3 = on and col or C3(50, 35, 35)}, 0.15)
            TwSpring(thb, {Position = on and UD2(1, -13, 0.5, -5) or UD2(0, 3, 0.5, -5), BackgroundColor3 = on and Color3.new(1, 1, 1) or C3(140, 120, 120)}, 0.15)
            Tw(txt, {TextColor3 = on and VN.Chu or VN.ChuMo}, 0.1)
            cb(on)
        end)
    end
    
    local function Slider(p, lbl, mn, mx, def, dp, cb)
        local f = Card(p, 40)
        local txt = Instance.new("TextLabel", f)
        txt.Size = UD2(0.5, 0, 0, 12)
        txt.Position = UD2(0, 7, 0, 4)
        txt.BackgroundTransparency = 1
        txt.Text = lbl
        txt.Font = Enum.Font.Gotham
        txt.TextSize = 8
        txt.TextColor3 = VN.ChuMo
        txt.TextXAlignment = Enum.TextXAlignment.Left
        
        local vt = Instance.new("TextLabel", f)
        vt.Size = UD2(0.4, 0, 0, 12)
        vt.Position = UD2(0.58, 0, 0, 4)
        vt.BackgroundTransparency = 1
        vt.Text = tostring(def)
        vt.Font = Enum.Font.GothamBold
        vt.TextSize = 9
        vt.TextColor3 = VN.Vang
        vt.TextXAlignment = Enum.TextXAlignment.Right
        
        local trk = Instance.new("Frame", f)
        trk.Size = UD2(1, -14, 0, 5)
        trk.Position = UD2(0, 7, 0, 26)
        trk.BackgroundColor3 = C3(40, 18, 18)
        trk.BorderSizePixel = 0
        Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)
        
        local fill = Instance.new("Frame", trk)
        fill.Size = UD2((def - mn) / max(mx - mn, 1), 0, 1, 0)
        fill.BackgroundColor3 = VN.Do
        fill.BorderSizePixel = 0
        Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
        
        local thb = Instance.new("TextButton", trk)
        thb.Size = UD2(0, 10, 0, 10)
        thb.Position = UD2((def - mn) / max(mx - mn, 1), -5, 0.5, -5)
        thb.BackgroundColor3 = VN.Vang
        thb.Text = ""
        thb.BorderSizePixel = 0
        thb.ZIndex = 5
        Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)
        
        local prec = 10 ^ dp
        local drag = false
        
        local function upd(ix)
            local tw = trk.AbsoluteSize.X
            if tw <= 0 then return end
            local rel = clamp((ix - trk.AbsolutePosition.X) / tw, 0, 1)
            local v = floor((mn + (mx - mn) * rel) * prec + 0.5) / prec
            Tw(fill, {Size = UD2(rel, 0, 1, 0)}, 0.05)
            Tw(thb, {Position = UD2(rel, -5, 0.5, -5)}, 0.05)
            vt.Text = tostring(v)
            cb(v)
        end
        
        thb.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
                drag = true
            end
        end)
        trk.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
                drag = true
                upd(i.Position.X)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if drag and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
                upd(i.Position.X)
            end
        end)
        UIS.InputEnded:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
                drag = false
            end
        end)
    end
    
    local function InfoCard(p, t, c)
        local f = Card(p, 38)
        f.BackgroundColor3 = C3(10, 16, 10)
        local l = Instance.new("TextLabel", f)
        l.Size = UD2(1, -8, 1, -4)
        l.Position = UD2(0, 4, 0, 2)
        l.BackgroundTransparency = 1
        l.Text = t
        l.Font = Enum.Font.Gotham
        l.TextSize = 8
        l.TextColor3 = c or VN.AnToan
        l.TextXAlignment = Enum.TextXAlignment.Left
        l.TextWrapped = true
        l.RichText = true
    end
    
    -- Create Tabs
    local tT = MkTab("Má»¤C TIÃŠU", "ğŸ¯")
    local tH = MkTab("HITBOX", "ğŸ“¦")
    local tE = MkTab("ESP", "ğŸ‘")
    
    tabs["Má»¤C TIÃŠU"].scroll.Visible = true
    tabs["Má»¤C TIÃŠU"].ind.Visible = true
    tabs["Má»¤C TIÃŠU"].btn.TextColor3 = VN.Vang
    tabs["Má»¤C TIÃŠU"].btn.BackgroundColor3 = C3(50, 20, 18)
    tabs["Má»¤C TIÃŠU"].btn.BackgroundTransparency = 0.1
    
    -- TAB: Má»¤C TIÃŠU
    Section(tT, "ğŸ¯ CHáº¾ Äá»˜")
    Toggle(tT, "âš¡ Nháº¯m Táº¤T Cáº¢ (bá» Team)", Cfg.NhamTatCa, function(v) Cfg.NhamTatCa = v; ForceRecalcAll() end, VN.NguyHiem)
    
    Section(tT, "ğŸ´ TEAM")
    InfoCard(tT, '<font color="#FF5050">Táº®T</font> <font color="#50FF50">Táº¤T Cáº¢</font> <font color="#FFAA00">ÄE Dá»ŒA</font>\nâ˜… Player trong SAFE ZONE sáº½ KHÃ”NG bá»‹ target', C3(180, 220, 160))
    
    local mL = {[0] = "Táº®T", [1] = "Táº¤T Cáº¢", [2] = "ÄE Dá»ŒA"}
    local mC = {[0] = C3(70, 50, 50), [1] = VN.AnToan, [2] = VN.CanhBao}
    
    for tn, td in pairs(Cfg.Team) do
        local dn = tn == "__NO_TEAM__" and "ğŸš« No Team" or tn
        local f = Card(tT, 30)
        
        local dot = Instance.new("Frame", f)
        dot.Size = UD2(0, 7, 0, 7)
        dot.Position = UD2(0, 7, 0.5, -3.5)
        dot.BackgroundColor3 = td.Color
        dot.BorderSizePixel = 0
        Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
        
        local nl = Instance.new("TextLabel", f)
        nl.Size = UD2(0.45, 0, 1, 0)
        nl.Position = UD2(0, 18, 0, 0)
        nl.BackgroundTransparency = 1
        nl.Text = dn
        nl.Font = Enum.Font.Gotham
        nl.TextSize = 8
        nl.TextColor3 = VN.Chu
        nl.TextXAlignment = Enum.TextXAlignment.Left
        
        local mb = Instance.new("TextButton", f)
        mb.Size = UD2(0, 62, 0, 18)
        mb.Position = UD2(1, -70, 0.5, -9)
        mb.Text = mL[td.Mode]
        mb.TextColor3 = Color3.new(1, 1, 1)
        mb.Font = Enum.Font.GothamBold
        mb.TextSize = 8
        mb.BackgroundColor3 = mC[td.Mode]
        mb.BorderSizePixel = 0
        mb.AutoButtonColor = false
        Instance.new("UICorner", mb).CornerRadius = UDim.new(0, 4)
        
        mb.MouseButton1Click:Connect(function()
            td.Mode = (td.Mode + 1) % 3
            mb.Text = mL[td.Mode]
            TwSpring(mb, {BackgroundColor3 = mC[td.Mode]}, 0.15)
            ForceRecalcAll()
        end)
    end
    
    -- TAB: HITBOX
    Section(tH, "ğŸ“¦ HITBOX")
    Toggle(tH, "ğŸ”¥ Báº­t Hitbox", Cfg.HB.On, function(v) Cfg.HB.On = v; ForceRecalcAll() end, VN.Do)
    
    Section(tH, "âš™ï¸ CÃ€I Äáº¶T")
    Slider(tH, "KÃ­ch thÆ°á»›c", 5, 35, Cfg.HB.Size, 0, function(v) Cfg.HB.Size = v end)
    Slider(tH, "Trong suá»‘t", 0, 1, Cfg.HB.Trans, 2, function(v) Cfg.HB.Trans = v end)
    Slider(tH, "KC tá»‘i Ä‘a", 50, 350, Cfg.HB.MaxD, 0, function(v) Cfg.HB.MaxD = v; ForceRecalcAll() end)
    
    InfoCard(tH, 'â˜… Hitbox update vá»‹ trÃ­ Má»–I FRAME\nâ˜… Anchored Part â†’ 100% damage\nâ˜… CanQuery=true â†’ Raycast detect', C3(180, 200, 160))
    
    -- TAB: ESP
    Section(tE, "ğŸ‘ ESP")
    Toggle(tE, "ğŸ”¥ Báº­t ESP", Cfg.ESP.On, function(v) Cfg.ESP.On = v; ForceRecalcAll() end, VN.Do)
    Toggle(tE, "ğŸŒ«ï¸ Má» theo KC", Cfg.ESP.Fade, function(v) Cfg.ESP.Fade = v end)
    
    Section(tE, "ğŸ“Š HIá»‚N THá»Š")
    Toggle(tE, "âœ¨ Highlight", Cfg.ESP.HL, function(v) Cfg.ESP.HL = v end, VN.Vang)
    Toggle(tE, "ğŸ“› TÃªn", Cfg.ESP.Name, function(v) Cfg.ESP.Name = v end, VN.AnToan)
    Toggle(tE, "ğŸ”« VÅ© khÃ­ + Score", Cfg.ESP.Wpn, function(v) Cfg.ESP.Wpn = v end, VN.CanhBao)
    Toggle(tE, "ğŸ“ Khoáº£ng cÃ¡ch", Cfg.ESP.Dist, function(v) Cfg.ESP.Dist = v end)
    Toggle(tE, "â¤ï¸ HP", Cfg.ESP.HP, function(v) Cfg.ESP.HP = v end, VN.NguyHiem)
    Toggle(tE, "ğŸ—ºï¸ Zone (Safe/Combat)", Cfg.ESP.Zone, function(v) Cfg.ESP.Zone = v end, VN.CanhBao)
    
    Slider(tE, "KC tá»‘i Ä‘a", 100, 1200, Cfg.ESP.MaxD, 0, function(v) Cfg.ESP.MaxD = v; ForceRecalcAll() end)
    
    -- Float Button
    local Fl = Instance.new("TextButton", Gui)
    Fl.Size = UD2(0, 40, 0, 40)
    Fl.Position = UD2(0, 8, 0.35, 0)
    Fl.BackgroundColor3 = VN.Do
    Fl.Text = "â˜…"
    Fl.TextColor3 = VN.Vang
    Fl.Font = Enum.Font.GothamBlack
    Fl.TextSize = 16
    Fl.BorderSizePixel = 0
    Fl.ZIndex = 50
    Fl.AutoButtonColor = false
    Instance.new("UICorner", Fl).CornerRadius = UDim.new(1, 0)
    Instance.new("UIStroke", Fl).Color = VN.Vang
    
    local fd, fds, fps = false, nil, nil
    Fl.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            fd = true
            fds = i.Position
            fps = Fl.Position
        end
    end)
    Fl.InputChanged:Connect(function(i)
        if fd and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local d = i.Position - fds
            Fl.Position = UD2(fps.X.Scale, fps.X.Offset + d.X, fps.Y.Scale, fps.Y.Offset + d.Y)
        end
    end)
    Fl.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            if fds then
                local d = i.Position - fds
                if abs(d.X) < 10 and abs(d.Y) < 10 then
                    Main.Visible = not Main.Visible
                end
            end
            fd = false
        end
    end)
    
    task.spawn(function()
        local big = true
        while Fl.Parent do
            if big then TwSpring(Fl, {TextSize = 20, Rotation = 5}, 0.4)
            else TwSpring(Fl, {TextSize = 16, Rotation = -5}, 0.4) end
            big = not big
            task.wait(0.5)
        end
    end)
    
    table.insert(Conns, UIS.InputBegan:Connect(function(i, gp)
        if gp then return end
        if i.KeyCode == Enum.KeyCode.RightControl or i.KeyCode == Enum.KeyCode.F6 then
            Main.Visible = not Main.Visible
        end
    end))
    
    return SLbl
end

local SLbl = BuildUI()

-- â•â•â•â•â•â•â•â•â•â•â• MAIN LOOPS â•â•â•â•â•â•â•â•â•â•â•

-- â˜…â˜…â˜… RENDER LOOP: Update hitbox positions (RenderStepped = má»—i frame) â˜…â˜…â˜…
local renderConn = RS.RenderStepped:Connect(function()
    UpdateAllHitboxPositions()
end)
table.insert(Conns, renderConn)

-- â˜…â˜…â˜… LOGIC LOOP: Update player data (Heartbeat = 10 FPS) â˜…â˜…â˜…
local fc, fps, lft, lup = 0, 60, tick(), 0

local heartbeat = RS.Heartbeat:Connect(function()
    local now = tick()
    local dt = now - lft
    lft = now
    fps = fps * 0.9 + (1 / max(dt, 0.001)) * 0.1
    
    -- 10 FPS update
    if (now - lup) < 0.1 then return end
    lup = now
    
    local allP = Players:GetPlayers()
    local tc = 0
    
    for _, player in ipairs(allP) do
        if player == LP then continue end
        
        local pd, upd = UpdatePlayer(player, now)
        
        if not pd.alive then
            DestroyHitbox(player.UserId)
            HideVisuals(player.UserId)
            continue
        end
        
        if upd then
            UpdateHitbox(player, pd)
            UpdateHBViz(player, pd)
            UpdateESP(player, pd)
        end
        
        if pd.target then tc = tc + 1 end
    end
    
    fc = fc + 1
    if fc % 10 == 0 and SLbl and SLbl.Parent then
        local ft = {}
        if Cfg.HB.On then table.insert(ft, "HB") end
        if Cfg.ESP.On then table.insert(ft, "ESP") end
        local fs = #ft > 0 and table.concat(ft, "Â·") or "Táº®T"
        SLbl.Text = string.format("ğŸ‡»ğŸ‡³ %s | ğŸ¯ %d | âš¡ %.0f", fs, tc, fps)
        SLbl.TextColor3 = tc > 0 and VN.Vang or VN.ChuMo
    end
end)
table.insert(Conns, heartbeat)

-- â•â•â•â•â•â•â•â•â•â•â• KILL SWITCH â•â•â•â•â•â•â•â•â•â•â•
_G._FlowKill = function()
    for _, c in ipairs(Conns) do pcall(function() c:Disconnect() end) end
    Conns = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LP then FullCleanup(p) end
    end
    if VR and VR.Parent then VR:Destroy() end
    pcall(function() CoreGui:FindFirstChild("Flow_VN_v64"):Destroy() end)
    WPN_CACHE = {}
    ZoneCache = {}
    HitboxParts = {}
    print("ğŸ‡»ğŸ‡³ [FLOW v6.4] âœ… ÄÃ£ dá»n dáº¹p!")
end

print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("ğŸ‡»ğŸ‡³ FLOW v6.4 â€” COMPLETE FIX ğŸ‰")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… FIX HITBOX: Anchored + RenderStepped update")
print("âœ… FIX ZONE: Simple Safe/Combat detection")
print("âœ… FIX WEAPON: Threshold 8 (super low)")
print("âœ… ESP hiá»ƒn thá»‹ weapon score Ä‘á»ƒ debug")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("â˜… Nháº¥n â˜… Ä‘á»ƒ má»Ÿ | Hotkey: RightCtrl / F6")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
