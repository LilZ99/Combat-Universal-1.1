if _G._FlowKill then pcall(_G._FlowKill) end

--[[
    â˜… FLOW v6.6 â€” PREMIUM ACADEMIC BUILD â˜…
    â˜… Cá»T LÃ•I: Giá»¯ nguyÃªn v6.5 (UI, CÆ¡ cháº¿, Tá»‘i Æ°u)
    â˜… NÃ‚NG Cáº¤P: Heuristic Raycast (Wall Check) & Dynamic Hostility
]]

local Players   = game:GetService("Players")
local RS        = game:GetService("RunService")
local TS        = game:GetService("TweenService")
local CoreGui   = game:GetService("CoreGui")
local Teams     = game:GetService("Teams")
local UIS       = game:GetService("UserInputService")
local CS        = game:GetService("CollectionService")
local LP        = Players.LocalPlayer
local Cam       = workspace.CurrentCamera

-- Dá»n dáº¹p báº£n cÅ©
for _, n in ipairs({"Flow_Loading","Flow_VN_v5","Flow_VN_v6","Flow_VN_v65","Flow_Premium_v66","HongLong_VR"}) do
    pcall(function() CoreGui:FindFirstChild(n):Destroy() end)
end

local V3, CF, C3, UD2 = Vector3.new, CFrame.new, Color3.fromRGB, UDim2.new
local abs, min, max, floor, clamp = math.abs, math.min, math.max, math.floor, math.clamp

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- THEME & UTILS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local VN = {
    Do       = C3(218,37,29),  DoSang   = C3(255,60,50),   DoTham  = C3(150,20,15),
    Vang     = C3(255,203,5),  VangSang = C3(255,235,100), VangKim = C3(255,215,0),
    Nen      = C3(12,6,6),     NenNhat  = C3(25,12,12),    Vien    = C3(80,30,25),
    AnToan   = C3(34,197,94),  NguyHiem = C3(239,68,68),
    CanhBao  = C3(251,191,36), DacBiet  = C3(180,100,255),
    Chu      = C3(252,248,244),ChuMo    = C3(148,118,112), ChuToi  = C3(100,78,75),
}

local function Tw(o,p,t)
    if not o or not o.Parent then return end
    pcall(function() TS:Create(o,TweenInfo.new(t or 0.25,Enum.EasingStyle.Quint,Enum.EasingDirection.Out),p):Play() end)
end
local function TwSpring(o,p,t)
    if not o or not o.Parent then return end
    pcall(function() TS:Create(o,TweenInfo.new(t or 0.35,Enum.EasingStyle.Back,Enum.EasingDirection.Out),p):Play() end)
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Cáº¤U HÃŒNH (THÃŠM WALL CHECK VÃ€O Cáº¤U HÃŒNH)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local Cfg = {
    NhamTatCa = false,
    WallCheck = true, -- TÃ­nh nÄƒng má»›i
    Team = {},
    HB  = {On=false, Size=18, Trans=0.8, MaxD=300},
    ESP = {On=false, Fade=true, MaxD=1000, HL=true, Name=true, Dist=true, HP=true, Wpn=true, Zone=true},
}

local OrigSizes = {}   
local HBViz     = {}   
local ESPViz    = {}   
local PData     = {}   
local Conns     = {}

local VR = Instance.new("Folder", CoreGui)
VR.Name  = "HongLong_VR"

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ§  THUáº¬T TOÃN 1: HEURISTIC RAYCASTING (WALL CHECK)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function IsVisible(targetChar)
    if not Cfg.WallCheck then return true end
    if not targetChar then return false end
    
    local origin = Cam.CFrame.Position
    local partsToCheck = {"Head", "HumanoidRootPart", "UpperTorso", "LowerTorso", "RightUpperArm", "LeftUpperArm"}
    
    -- XÃ¢y dá»±ng Ignore List chuáº©n há»c thuáº­t: Bá» qua Cam, LocalPlayer, VR Folder vÃ  cÃ¡c phá»¥ kiá»‡n cá»§a má»¥c tiÃªu
    local ignoreList = {LP.Character, Cam, VR}
    for _, acc in ipairs(targetChar:GetChildren()) do
        if acc:IsA("Accessory") or acc:IsA("Hat") then table.insert(ignoreList, acc) end
    end

    local params = RaycastParams.new()
    params.FilterDescendantsInstances = ignoreList
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.IgnoreWater = true

    for _, partName in ipairs(partsToCheck) do
        local part = targetChar:FindFirstChild(partName)
        if part then
            local dir = (part.Position - origin)
            local result = workspace:Raycast(origin, dir, params)
            
            -- Lá»c ngoáº¡i lá»‡: Báº¯n trÃºng Ä‘á»‹ch HOáº¶C trÃºng váº­t thá»ƒ tÃ ng hÃ¬nh/kÃ­nh/khÃ´ng cÃ³ va cháº¡m
            if not result then 
                return true -- KhÃ´ng bá»‹ cáº£n
            elseif result.Instance:IsDescendantOf(targetChar) then
                return true -- TrÃºng Ä‘Ã­ch xÃ¡c
            elseif result.Instance.Transparency > 0.4 or not result.Instance.CanCollide then
                -- Bá»‹ cháº·n bá»Ÿi cá», kÃ­nh, váº­t tÃ ng hÃ¬nh -> Váº«n coi lÃ  nhÃ¬n tháº¥y
                -- Tiáº¿p tá»¥c raycast xuyÃªn qua váº­t thá»ƒ Ä‘Ã³ (MÃ´ phá»ng Ä‘Ã¢m xuyÃªn)
                local secondOrigin = result.Position + (dir.Unit * 0.1)
                local secondResult = workspace:Raycast(secondOrigin, dir, params)
                if not secondResult or secondResult.Instance:IsDescendantOf(targetChar) then
                    return true
                end
            end
        end
    end
    return false
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ§  THUáº¬T TOÃN 2: WEAPON DETECTION (Giá»¯ nguyÃªn v6.5)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local WPN_CACHE = {}
local WPN_NAMES = {"gun","pistol","glock","rifle","shotgun","sniper","smg","lmg","rpg","launcher","weapon","firearm","ak","glock","deagle","m4","m16","mp5","mp7","mp9","uzi","vector","scar","famas","aug","awp","awm","knife","sword","blade","katana","machete","axe","dagger","karambit","bowie","bayonet","revolver","magnum","desert","eagle","beretta","colt","usp","p90","mac","tec","five","seven","minigun","gatling","turret","cannon","laser","plasma","ray","blaster","phaser","bow","crossbow","arrow","grenade","explosive","bomb","mine","c4","dynamite","kar","mosin","springfield","dragunov","intervention","barrett","m24","l96","scout","spas","benelli","mossberg","remington","saiga","aa12","pump","double","thompson","sten","ppsh","grease","m3","p250","cz","negev","m249","pkm","rpk","combat","tactical","military","assault","auto","semi","burst","silenced","suppressed","ar","sr","dmr","br","hg","sg","mg","rl","gl","sung","sungtruong","sungngan","sungluc","dao","kiem","bom","vukhi","luudan","shoot","fire","kill","attack","damage","hit","bang","boom","slash","stab","cut"}
local WPN_SAFE = {"shovel","hoe","rake","seed","water","fish","rod","pole","bucket","pail","wrench","screwdriver","paint","brush","key","keycard","flashlight","torch","lantern","camera","binocular","phone","radio","tablet","medkit","bandage","medicine","health","food","drink","snack","money","cash","coin","book","map","compass","note","paper","flower","plant","furniture","decoration","instrument","guitar","piano","drum","flute","toy","ball","frisbee","pet","leash"}

local function FastMatch(str, list)
    for i = 1, #list do if str:find(list[i], 1, true) then return true end end
    return false
end

local function AnalyzeWeapon(tool)
    if not tool or not tool:IsA("Tool") then return false, 0 end
    local cached = WPN_CACHE[tool]
    if cached and (tick()-cached.t) < 20 then return cached.w, cached.s end

    local name = tool.Name:lower():gsub("[%-%_%.%s%d]","")
    if FastMatch(name, WPN_SAFE) then WPN_CACHE[tool] = {w=false, s=0, t=tick()}; return false, 0 end

    local score = 0
    if FastMatch(name, WPN_NAMES) then score = score + 50 end

    local ok, descs = pcall(function() return tool:GetDescendants() end)
    if ok then
        local count = 0
        for _, d in ipairs(descs) do
            if count > 20 then break end; count += 1
            local dn = d.Name:lower()
            if (d:IsA("BasePart") or d:IsA("Attachment")) and (dn:find("muzzle") or dn:find("barrel") or dn:find("trigger") or dn:find("mag") or dn:find("scope") or dn:find("sight") or dn:find("grip") or dn:find("stock") or dn:find("blade") or dn:find("handle") or dn:find("bolt") or dn:find("chamber")) then score += 12 end
            if d:IsA("Sound") and (dn:find("shoot") or dn:find("fire") or dn:find("gun") or dn:find("reload") or dn:find("shot") or dn:find("bang") or dn:find("slash") or dn:find("swing") or dn:find("attack") or dn:find("hit")) then score += 15 end
            if (d:IsA("RemoteEvent") or d:IsA("RemoteFunction") or d:IsA("BindableEvent")) and (dn:find("fire") or dn:find("shoot") or dn:find("attack") or dn:find("damage") or dn:find("hit") or dn:find("reload") or dn:find("equip")) then score += 12 end
        end
    end
    local handle = tool:FindFirstChild("Handle")
    if handle and handle:IsA("BasePart") then
        local s = handle.Size
        local ratio = max(s.X, s.Y, s.Z) / max(min(s.X, s.Y, s.Z), 0.1)
        if ratio > 2.5 then score += 8 end
    end
    local isWeapon = score >= 8
    WPN_CACHE[tool] = {w=isWeapon, s=score, t=tick()}
    return isWeapon, score
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ§  THUáº¬T TOÃN 3: TÃŒM KIáº¾M Äá»ŠCH & ZONE (NÃ‚NG Cáº¤P)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local ZoneCache = {}
local SAFE_KW   = {"safe","insafe","safezone","lobby","spawn","protected","nopvp","immune","invulnerable","peaceful","godmode","base","hub","town"}

local function CheckSafeZone(player)
    local char = player.Character
    if not char then return false end
    
    local uid = player.UserId
    -- Decay nhanh hÆ¡n (0.2s) Ä‘á»ƒ báº¯t ngay khoáº£nh kháº¯c Ä‘á»‹ch nháº£y ra khá»i zone
    if ZoneCache[uid] and (tick() - ZoneCache[uid].t) < 0.2 then return ZoneCache[uid].r end

    local function Cache(val) ZoneCache[uid] = {r=val, t=tick()}; return val end

    if char:FindFirstChildOfClass("ForceField") then return Cache(true) end

    local root = char:FindFirstChild("HumanoidRootPart")
    if root then
        local r = 2.5 -- Thu háº¹p bÃ¡n kÃ­nh Ä‘á»ƒ trÃ¡nh nháº­n diá»‡n sai á»Ÿ ranh giá»›i
        local reg = Region3.new(root.Position - V3(r,r,r), root.Position + V3(r,r,r))
        local ok, parts = pcall(function() return workspace:FindPartsInRegion3WithIgnoreList(reg, {char, Cam}, 15) end)
        if ok then
            for _, part in ipairs(parts) do
                local pn = part.Name:lower()
                for _, kw in ipairs(SAFE_KW) do if pn:find(kw, 1, true) then return Cache(true) end end
            end
        end
    end
    return Cache(false)
end

local function ShouldTarget(player, inSafe, hasWeapon)
    if player == LP then return false end
    if inSafe then return false end -- LuÃ´n bá» qua Ä‘á»‹ch trong SafeZone
    if Cfg.NhamTatCa then return true end
    
    local myTeam = LP.Team
    local enTeam = player.Team
    
    -- Xá»­ lÃ½ ngoáº¡i lá»‡: Free-For-All (CÃ¹ng khÃ´ng cÃ³ team)
    if not myTeam and not enTeam then
        return true -- Máº·c Ä‘á»‹nh lÃ  Ä‘á»‹ch náº¿u khÃ´ng cÃ³ há»‡ thá»‘ng Team
    end

    local key = enTeam and enTeam.Name or "__NO_TEAM__"
    local cfg = Cfg.Team[key] or Cfg.Team["__NO_TEAM__"]
    
    if not cfg then return true end
    if cfg.Mode == 0 then return false end
    if cfg.Mode == 2 and not hasWeapon then return false end -- Chá»‰ má»¥c tiÃªu Ä‘e dá»a (cÃ³ vÅ© khÃ­)
    
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- UTILITIES & PLAYER DATA
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function GetDist(part)
    local c = LP.Character
    local mr = c and c:FindFirstChild("HumanoidRootPart")
    if not mr or not part then return 9999 end
    return (mr.Position - part.Position).Magnitude
end

local function HPColor(r)
    r = clamp(r, 0, 1)
    if r > 0.6 then return VN.AnToan elseif r > 0.3 then return VN.CanhBao else return VN.NguyHiem end
end

local function GetPD(uid)
    if not PData[uid] then
        PData[uid] = {lastUpdate=0, alive=false, target=false, hbOn=false, espOn=false, isVis=false, dist=9999, inSafe=false, hasWeapon=false, weaponName=nil, weaponScore=0, hp=100, maxHp=100, hpRatio=1, rootPart=nil, espCache={}}
    end
    return PData[uid]
end

local function UpdatePlayer(player, now)
    local uid = player.UserId
    local pd  = GetPD(uid)

    local rate = pd.dist < 100 and 0.08 or 0.15
    if (now - pd.lastUpdate) < rate then return pd, false end
    pd.lastUpdate = now

    local char = player.Character
    local hum  = char and char:FindFirstChildOfClass("Humanoid")
    local root = char and char:FindFirstChild("HumanoidRootPart")

    pd.alive    = char ~= nil and hum ~= nil and root ~= nil and hum.Health > 0
    pd.rootPart = root

    if not pd.alive then
        pd.target, pd.hbOn, pd.espOn = false, false, false
        return pd, true
    end

    pd.dist    = GetDist(root)
    pd.hp      = hum.Health
    pd.maxHp   = max(hum.MaxHealth, 1)
    pd.hpRatio = clamp(pd.hp / pd.maxHp, 0, 1)
    pd.inSafe  = CheckSafeZone(player)

    local tool = char:FindFirstChildOfClass("Tool")
    if tool then
        local isW, score = AnalyzeWeapon(tool)
        pd.hasWeapon, pd.weaponName, pd.weaponScore = isW, tool.Name, score
    else
        pd.hasWeapon, pd.weaponName, pd.weaponScore = false, nil, 0
    end

    -- ÄÃ¡nh giÃ¡ Target káº¿t há»£p WallCheck
    pd.isVis  = IsVisible(char)
    pd.target = ShouldTarget(player, pd.inSafe, pd.hasWeapon)
    
    -- Hitbox chá»‰ kÃ­ch hoáº¡t khi Ä‘Ãºng má»¥c tiÃªu, trong táº§m, VÃ€ KHÃ”NG Bá»Š TÆ¯á»œNG CHáº®N (Náº¿u báº­t WallCheck)
    pd.hbOn   = Cfg.HB.On  and pd.target and pd.dist <= Cfg.HB.MaxD and pd.isVis
    pd.espOn  = Cfg.ESP.On and pd.target and pd.dist <= Cfg.ESP.MaxD

    return pd, true
end

local function ForceRecalcAll()
    for _, pd in pairs(PData) do pd.lastUpdate = 0; pd.espCache = {} end
    WPN_CACHE = {}; ZoneCache = {}
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“¦ HITBOX & ESP VIZ (Giá»¯ nguyÃªn v6.5)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local HB_PART_NAMES = {"HumanoidRootPart","UpperTorso","LowerTorso","Torso","Head","RightUpperArm","LeftUpperArm","RightLowerArm","LeftLowerArm","RightHand","LeftHand","RightUpperLeg","LeftUpperLeg","RightLowerLeg","LeftLowerLeg","RightFoot","LeftFoot","Right Arm","Left Arm","Right Leg","Left Leg"}

local function RestoreHitbox(uid)
    local orig = OrigSizes[uid]
    if not orig then return end
    local player = Players:GetPlayerByUserId(uid)
    local char   = player and player.Character
    if char then
        for partName, origSize in pairs(orig) do
            local part = char:FindFirstChild(partName)
            if part and part:IsA("BasePart") then pcall(function() part.Size = origSize end) end
        end
    end
    OrigSizes[uid] = nil
end

local function UpdateHitbox(player, pd)
    local uid = player.UserId
    if not pd.hbOn or not pd.alive or not pd.rootPart then RestoreHitbox(uid); return end

    local char = player.Character
    if not OrigSizes[uid] then OrigSizes[uid] = {} end
    local sv3 = V3(Cfg.HB.Size, Cfg.HB.Size, Cfg.HB.Size)

    for _, partName in ipairs(HB_PART_NAMES) do
        local part = char:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            if not OrigSizes[uid][partName] then OrigSizes[uid][partName] = part.Size end
            pcall(function() part.Size = sv3 end)
        end
    end
end

local function EnsureHBViz(uid)
    if HBViz[uid] and HBViz[uid].Parent then return HBViz[uid] end
    local f = Instance.new("Folder", VR); f.Name = "HBViz_"..uid
    local sb = Instance.new("SelectionBox", f); sb.Name = "Box"; sb.LineThickness = 0.035
    HBViz[uid] = f
    return f
end

local function UpdateHBViz(player, pd)
    local uid = player.UserId
    if not pd.hbOn or not pd.alive or not pd.rootPart then
        if HBViz[uid] and HBViz[uid]:FindFirstChild("Box") then HBViz[uid].Box.Adornee = nil end
        return
    end

    local f = EnsureHBViz(uid)
    local sb = f:FindFirstChild("Box")
    local col = pd.inSafe and VN.ChuMo or (pd.hasWeapon and VN.NguyHiem or VN.Vang)
    
    sb.Adornee = pd.rootPart
    sb.Color3 = col
    sb.SurfaceColor3 = col
    sb.SurfaceTransparency = Cfg.HB.Trans
end

local function EnsureESP(uid)
    if ESPViz[uid] and ESPViz[uid].Parent then return ESPViz[uid] end
    local f = Instance.new("Folder", VR); f.Name = "ESP_"..uid
    local hl = Instance.new("Highlight", f); hl.Name = "HL"; hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop; hl.Enabled = false
    local bg = Instance.new("BillboardGui", f); bg.Name = "BG"; bg.AlwaysOnTop = true; bg.Size = UD2(0, 150, 0, 95); bg.StudsOffset = V3(0, 3, 0); bg.MaxDistance = 1200; bg.Enabled = false
    local ct = Instance.new("Frame", bg); ct.Name = "CT"; ct.Size = UD2(1, 0, 1, 0); ct.BackgroundTransparency = 1
    local ly = Instance.new("UIListLayout", ct); ly.HorizontalAlignment = Enum.HorizontalAlignment.Center; ly.Padding = UDim.new(0, 2)
    
    local function ML(nm, ord, h, sz)
        local l = Instance.new("TextLabel", ct); l.Name = nm; l.LayoutOrder = ord; l.Size = UD2(1, 0, 0, h); l.BackgroundTransparency = 1; l.Font = Enum.Font.GothamBold; l.TextSize = sz; l.TextStrokeTransparency = 0; l.TextStrokeColor3 = C3(0, 0, 0); l.RichText = true; l.Text = ""
    end
    ML("NL", 1, 14, 11); ML("ZL", 2, 12, 9); ML("WL", 3, 12, 9); ML("DL", 4, 12, 10); ML("HL2", 5, 10, 9)
    
    local hpBg = Instance.new("Frame", ct); hpBg.Name = "HPBg"; hpBg.LayoutOrder = 6; hpBg.Size = UD2(0.6, 0, 0, 5); hpBg.BackgroundColor3 = C3(30, 10, 10); hpBg.BorderSizePixel = 0; Instance.new("UICorner", hpBg).CornerRadius = UDim.new(1, 0)
    local hpF = Instance.new("Frame", hpBg); hpF.Name = "HPF"; hpF.Size = UD2(1, 0, 1, 0); hpF.BackgroundColor3 = VN.AnToan; hpF.BorderSizePixel = 0; Instance.new("UICorner", hpF).CornerRadius = UDim.new(1, 0)
    
    ESPViz[uid] = f
    return f
end

local function UpdateESP(player, pd)
    local uid = player.UserId
    if not pd.espOn or not pd.alive or not pd.rootPart then
        if ESPViz[uid] then 
            if ESPViz[uid]:FindFirstChild("HL") then ESPViz[uid].HL.Enabled = false end
            if ESPViz[uid]:FindFirstChild("BG") then ESPViz[uid].BG.Enabled = false end
        end
        return
    end

    local f = EnsureESP(uid)
    local cache = pd.espCache
    local wpnName = pd.weaponName or ""
    
    if cache.hp == floor(pd.hp) and cache.safe == pd.inSafe and cache.weapon == wpnName and abs((cache.dist or 0) - pd.dist) < 20 then return end
    cache.hp, cache.safe, cache.weapon, cache.dist = floor(pd.hp), pd.inSafe, wpnName, pd.dist

    local dist = pd.dist
    local fade = Cfg.ESP.Fade and clamp((dist - 50) / 450, 0, 1) or 0
    local hpC = HPColor(pd.hpRatio)
    local baseCol = pd.inSafe and VN.ChuMo or (pd.hasWeapon and VN.NguyHiem or VN.Vang)
    local tf = max(fade * 0.5, 0.08)

    local hl = f:FindFirstChild("HL")
    if hl and Cfg.ESP.HL then
        hl.Enabled = true; hl.Adornee = player.Character; hl.FillColor = baseCol; hl.OutlineColor = pd.hasWeapon and VN.NguyHiem or VN.Vang; hl.FillTransparency = max(0.15, fade * 0.6); hl.OutlineTransparency = fade * 0.5
    elseif hl then hl.Enabled = false end

    local bg = f:FindFirstChild("BG")
    if bg then bg.Adornee = pd.rootPart; bg.Enabled = true end

    local ct = bg and bg:FindFirstChild("CT")
    if not ct then return end

    local function SL(nm, txt, col)
        local l = ct:FindFirstChild(nm)
        if l then l.Text = txt; if col then l.TextColor3 = col end; l.TextTransparency = tf; l.Visible = txt ~= "" end
    end

    if Cfg.ESP.Name then SL("NL", string.format("<b>%s</b>", player.Name), baseCol) else SL("NL", "") end
    if Cfg.ESP.Zone then
        if pd.inSafe then SL("ZL", '<font color="#888">ğŸ›¡ï¸ AN TOÃ€N</font>') else SL("ZL", '<font color="#AA66FF">âš”ï¸ CHIáº¾N Äáº¤U</font>') end
    else SL("ZL", "") end
    if Cfg.ESP.Wpn and pd.weaponName then
        local wCol = pd.hasWeapon and "#FF4400" or "#888888"; local wIcon = pd.hasWeapon and "ğŸ”«" or "ğŸ“¦"
        SL("WL", string.format('<font color="%s">%s %s [%d]</font>', wCol, wIcon, pd.weaponName, pd.weaponScore))
    else SL("WL", "") end
    if Cfg.ESP.Dist then SL("DL", string.format("%.0f m", dist), VN.AnToan:Lerp(VN.NguyHiem, clamp(dist / Cfg.ESP.MaxD, 0, 1))) else SL("DL", "") end
    if Cfg.ESP.HP then
        local hpHex = string.format("#%02X%02X%02X", floor(hpC.R*255), floor(hpC.G*255), floor(hpC.B*255))
        SL("HL2", string.format('<font color="%s">%.0f HP</font>', hpHex, pd.hp))
    else SL("HL2", "") end

    local hpBg2 = ct:FindFirstChild("HPBg")
    local hpFill = hpBg2 and hpBg2:FindFirstChild("HPF")
    if hpBg2 and Cfg.ESP.HP then hpBg2.Visible = true; if hpFill then hpFill.Size = UD2(pd.hpRatio, 0, 1, 0); hpFill.BackgroundColor3 = hpC end elseif hpBg2 then hpBg2.Visible = false end
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- GIAO DIá»†N (Giá»¯ nguyÃªn form v6.5, thÃªm má»¥c WallCheck)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local function BuildUI()
    local Gui = Instance.new("ScreenGui", CoreGui); Gui.Name = "Flow_Premium_v66"; Gui.ResetOnSpawn = false; Gui.DisplayOrder = 100
    local Main = Instance.new("Frame", Gui); Main.Name = "Main"; Main.Size = UD2(0, 330, 0, 440); Main.Position = UD2(0.5, -165, 0.5, -220); Main.BackgroundColor3 = VN.Nen; Main.BorderSizePixel = 0; Main.Active = true; Main.Draggable = true; Main.ClipsDescendants = true; Main.Visible = false
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 12); Instance.new("UIStroke", Main).Color = VN.Do

    local Hdr = Instance.new("Frame", Main); Hdr.Size = UD2(1, 0, 0, 42); Hdr.BackgroundColor3 = VN.Do; Hdr.BorderSizePixel = 0; Instance.new("UICorner", Hdr).CornerRadius = UDim.new(0, 12)
    local HFix = Instance.new("Frame", Hdr); HFix.Size = UD2(1, 0, 0, 12); HFix.Position = UD2(0, 0, 1, -12); HFix.BackgroundColor3 = VN.Do; HFix.BorderSizePixel = 0
    local FI = Instance.new("TextLabel", Hdr); FI.Size = UD2(0, 20, 0, 20); FI.Position = UD2(0, 8, 0.5, -10); FI.BackgroundTransparency = 1; FI.Text = "ğŸ‡»ğŸ‡³"; FI.TextSize = 14
    local TL = Instance.new("TextLabel", Hdr); TL.Size = UD2(1, -70, 0, 18); TL.Position = UD2(0, 32, 0, 6); TL.BackgroundTransparency = 1; TL.Text = "âš¡ FLOW v6.6 PREMIUM"; TL.Font = Enum.Font.GothamBlack; TL.TextSize = 14; TL.TextColor3 = VN.Vang; TL.TextXAlignment = Enum.TextXAlignment.Left
    local ST = Instance.new("TextLabel", Hdr); ST.Size = UD2(0, 140, 0, 10); ST.Position = UD2(0, 32, 0, 24); ST.BackgroundTransparency = 1; ST.Text = "ACADEMIC FIXES"; ST.Font = Enum.Font.GothamMedium; ST.TextSize = 7; ST.TextColor3 = VN.VangSang; ST.TextXAlignment = Enum.TextXAlignment.Left
    local CB = Instance.new("TextButton", Hdr); CB.Size = UD2(0, 22, 0, 22); CB.Position = UD2(1, -28, 0.5, -11); CB.Text = "âœ•"; CB.TextColor3 = VN.Vang; CB.Font = Enum.Font.GothamBold; CB.TextSize = 11; CB.BackgroundColor3 = VN.DoTham; CB.BorderSizePixel = 0; CB.AutoButtonColor = false; Instance.new("UICorner", CB).CornerRadius = UDim.new(0, 5)
    CB.MouseButton1Click:Connect(function() Main.Visible = false end)

    local TB = Instance.new("Frame", Main); TB.Size = UD2(1, -8, 0, 28); TB.Position = UD2(0, 4, 0, 46); TB.BackgroundColor3 = VN.NenNhat; TB.BorderSizePixel = 0; Instance.new("UICorner", TB).CornerRadius = UDim.new(0, 7)
    local tbLy = Instance.new("UIListLayout", TB); tbLy.FillDirection = Enum.FillDirection.Horizontal; tbLy.HorizontalAlignment = Enum.HorizontalAlignment.Center; tbLy.VerticalAlignment = Enum.VerticalAlignment.Center; tbLy.Padding = UDim.new(0, 3)
    local Content = Instance.new("Frame", Main); Content.Size = UD2(1, -8, 1, -112); Content.Position = UD2(0, 4, 0, 78); Content.BackgroundTransparency = 1; Content.ClipsDescendants = true
    local SBar = Instance.new("Frame", Main); SBar.Size = UD2(1, -8, 0, 22); SBar.Position = UD2(0, 4, 1, -28); SBar.BackgroundColor3 = VN.NenNhat; SBar.BorderSizePixel = 0; Instance.new("UICorner", SBar).CornerRadius = UDim.new(0, 5)
    local SLbl = Instance.new("TextLabel", SBar); SLbl.Size = UD2(1, -6, 1, 0); SLbl.Position = UD2(0, 3, 0, 0); SLbl.BackgroundTransparency = 1; SLbl.Text = "ğŸ‡»ğŸ‡³ FLOW v6.6"; SLbl.Font = Enum.Font.GothamMedium; SLbl.TextSize = 8; SLbl.TextColor3 = VN.ChuMo; SLbl.TextXAlignment = Enum.TextXAlignment.Left

    local tabs = {}
    local function MkScroll()
        local s = Instance.new("ScrollingFrame", Content); s.Size = UD2(1, 0, 1, 0); s.BackgroundTransparency = 1; s.AutomaticCanvasSize = Enum.AutomaticSize.Y; s.ScrollBarThickness = 3; s.ScrollBarImageColor3 = VN.Do; s.BorderSizePixel = 0; s.Visible = false; s.CanvasSize = UD2(0, 0, 0, 0)
        local ly = Instance.new("UIListLayout", s); ly.Padding = UDim.new(0, 4); ly.SortOrder = Enum.SortOrder.LayoutOrder; Instance.new("UIPadding", s).PaddingTop = UDim.new(0, 2)
        return s
    end

    local function MkTab(nm, ic)
        local btn = Instance.new("TextButton", TB); btn.Size = UD2(0, 95, 0, 22); btn.Text = ic.." "..nm; btn.Font = Enum.Font.GothamBold; btn.TextSize = 9; btn.TextColor3 = VN.ChuToi; btn.BackgroundColor3 = VN.Nen; btn.BackgroundTransparency = 0.5; btn.BorderSizePixel = 0; btn.AutoButtonColor = false; Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
        local ind = Instance.new("Frame", btn); ind.Size = UD2(0.3, 0, 0, 2); ind.Position = UD2(0.35, 0, 1, -3); ind.BackgroundColor3 = VN.Vang; ind.BorderSizePixel = 0; ind.Visible = false; Instance.new("UICorner", ind).CornerRadius = UDim.new(1, 0)
        local scr = MkScroll(); tabs[nm] = {btn=btn, ind=ind, scroll=scr}
        btn.MouseButton1Click:Connect(function()
            for n, d in pairs(tabs) do
                local a = (n == nm); d.scroll.Visible = a; d.ind.Visible = a
                Tw(d.btn, {TextColor3 = a and VN.Vang or VN.ChuToi, BackgroundColor3 = a and C3(50,20,18) or VN.Nen, BackgroundTransparency = a and 0.1 or 0.5}, 0.15)
            end
        end)
        return scr
    end

    local function Card(p, h) local f = Instance.new("Frame", p); f.Size = UD2(1, -4, 0, h or 34); f.BackgroundColor3 = VN.NenNhat; f.BackgroundTransparency = 0.15; f.BorderSizePixel = 0; Instance.new("UICorner", f).CornerRadius = UDim.new(0, 7); return f end
    local function Section(p, t) local f = Card(p, 20); f.BackgroundColor3 = C3(50, 18, 14); local l = Instance.new("TextLabel", f); l.Size = UD2(1, -8, 1, 0); l.Position = UD2(0, 4, 0, 0); l.BackgroundTransparency = 1; l.Text = t; l.Font = Enum.Font.GothamBold; l.TextSize = 9; l.TextColor3 = VN.Vang; l.TextXAlignment = Enum.TextXAlignment.Left end
    
    local function Toggle(p, lbl, init, cb, col)
        col = col or VN.Do; local f = Card(p, 32); local txt = Instance.new("TextLabel", f); txt.Size = UD2(1, -50, 1, 0); txt.Position = UD2(0, 7, 0, 0); txt.BackgroundTransparency = 1; txt.Text = lbl; txt.Font = Enum.Font.Gotham; txt.TextSize = 9; txt.TextColor3 = init and VN.Chu or VN.ChuMo; txt.TextXAlignment = Enum.TextXAlignment.Left
        local trk = Instance.new("Frame", f); trk.Size = UD2(0, 34, 0, 16); trk.Position = UD2(1, -42, 0.5, -8); trk.BackgroundColor3 = init and col or C3(50, 35, 35); trk.BorderSizePixel = 0; Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)
        local thb = Instance.new("Frame", trk); thb.Size = UD2(0, 10, 0, 10); thb.Position = init and UD2(1,-13,0.5,-5) or UD2(0,3,0.5,-5); thb.BackgroundColor3 = init and Color3.new(1,1,1) or C3(140,120,120); thb.BorderSizePixel = 0; Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)
        local on = init; local btn = Instance.new("TextButton", f); btn.Size = UD2(1, 0, 1, 0); btn.BackgroundTransparency = 1; btn.Text = ""; btn.ZIndex = 5
        btn.MouseButton1Click:Connect(function() on = not on; TwSpring(trk, {BackgroundColor3 = on and col or C3(50,35,35)}, 0.15); TwSpring(thb, {Position = on and UD2(1,-13,0.5,-5) or UD2(0,3,0.5,-5), BackgroundColor3 = on and Color3.new(1,1,1) or C3(140,120,120)}, 0.15); Tw(txt, {TextColor3 = on and VN.Chu or VN.ChuMo}, 0.1); cb(on) end)
    end

    local function Slider(p, lbl, mn, mx, def, dp, cb)
        local f = Card(p, 40); local txt = Instance.new("TextLabel", f); txt.Size = UD2(0.5, 0, 0, 12); txt.Position = UD2(0, 7, 0, 4); txt.BackgroundTransparency = 1; txt.Text = lbl; txt.Font = Enum.Font.Gotham; txt.TextSize = 8; txt.TextColor3 = VN.ChuMo; txt.TextXAlignment = Enum.TextXAlignment.Left
        local vt = Instance.new("TextLabel", f); vt.Size = UD2(0.4, 0, 0, 12); vt.Position = UD2(0.58, 0, 0, 4); vt.BackgroundTransparency = 1; vt.Text = tostring(def); vt.Font = Enum.Font.GothamBold; vt.TextSize = 9; vt.TextColor3 = VN.Vang; vt.TextXAlignment = Enum.TextXAlignment.Right
        local trk = Instance.new("Frame", f); trk.Size = UD2(1, -14, 0, 5); trk.Position = UD2(0, 7, 0, 26); trk.BackgroundColor3 = C3(40, 18, 18); trk.BorderSizePixel = 0; Instance.new("UICorner", trk).CornerRadius = UDim.new(1, 0)
        local fill = Instance.new("Frame", trk); fill.Size = UD2((def-mn)/max(mx-mn,1), 0, 1, 0); fill.BackgroundColor3 = VN.Do; fill.BorderSizePixel = 0; Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
        local thb = Instance.new("TextButton", trk); thb.Size = UD2(0, 10, 0, 10); thb.Position = UD2((def-mn)/max(mx-mn,1), -5, 0.5, -5); thb.BackgroundColor3 = VN.Vang; thb.Text = ""; thb.BorderSizePixel = 0; thb.ZIndex = 5; Instance.new("UICorner", thb).CornerRadius = UDim.new(1, 0)
        local prec = 10^dp; local drag = false
        local function upd(ix) local tw = trk.AbsoluteSize.X; if tw <= 0 then return end; local rel = clamp((ix - trk.AbsolutePosition.X) / tw, 0, 1); local v = floor((mn + (mx-mn)*rel) * prec + 0.5) / prec; Tw(fill, {Size = UD2(rel, 0, 1, 0)}, 0.05); Tw(thb, {Position = UD2(rel, -5, 0.5, -5)}, 0.05); vt.Text = tostring(v); cb(v) end
        thb.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then drag = true end end)
        trk.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then drag = true; upd(i.Position.X) end end)
        UIS.InputChanged:Connect(function(i) if drag and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then upd(i.Position.X) end end)
        UIS.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then drag = false end end)
    end

    local function InfoCard(p, t, c)
        local f = Card(p, 40); f.BackgroundColor3 = C3(10, 16, 10); local l = Instance.new("TextLabel", f); l.Size = UD2(1, -8, 1, -4); l.Position = UD2(0, 4, 0, 2); l.BackgroundTransparency = 1; l.Text = t; l.Font = Enum.Font.Gotham; l.TextSize = 8; l.TextColor3 = c or VN.AnToan; l.TextXAlignment = Enum.TextXAlignment.Left; l.TextWrapped = true; l.RichText = true
    end

    local tT = MkTab("Má»¤C TIÃŠU", "ğŸ¯"); local tH = MkTab("HITBOX", "ğŸ“¦"); local tE = MkTab("ESP", "ğŸ‘")
    tabs["Má»¤C TIÃŠU"].scroll.Visible = true; tabs["Má»¤C TIÃŠU"].ind.Visible = true; tabs["Má»¤C TIÃŠU"].btn.TextColor3 = VN.Vang; tabs["Má»¤C TIÃŠU"].btn.BackgroundColor3 = C3(50,20,18); tabs["Má»¤C TIÃŠU"].btn.BackgroundTransparency = 0.1

    -- TAB Má»¤C TIÃŠU
    Section(tT, "ğŸ¯ CHáº¾ Äá»˜")
    Toggle(tT, "âš¡ Nháº¯m Táº¤T Cáº¢ (bá» Team)", Cfg.NhamTatCa, function(v) Cfg.NhamTatCa = v; ForceRecalcAll() end, VN.NguyHiem)
    Toggle(tT, "ğŸ§± Báº­t Wall Check (XuyÃªn TÆ°á»ng)", Cfg.WallCheck, function(v) Cfg.WallCheck = v; ForceRecalcAll() end, VN.VangKim)

    Section(tT, "ğŸ´ TEAM")
    InfoCard(tT, '<font color="#FF5050">Táº®T</font>  <font color="#50FF50">Táº¤T Cáº¢</font>  <font color="#FFAA00">ÄE Dá»ŒA</font>\nâ˜… Äá»‹ch rá»i vÃ¹ng an toÃ n/cáº§m vÅ© khÃ­ tá»± Ä‘á»™ng bá»‹ Ä‘Ã¡nh dáº¥u.', C3(180,220,160))
    local mL = {[0]="Táº®T", [1]="Táº¤T Cáº¢", [2]="ÄE Dá»ŒA"}; local mC = {[0]=C3(70,50,50), [1]=VN.AnToan, [2]=VN.CanhBao}
    
    local function RenderTeams()
        for _, c in ipairs(tT:GetChildren()) do if c.Name == "TeamItem" then c:Destroy() end end
        for tn, td in pairs(Cfg.Team) do
            local dn = tn == "__NO_TEAM__" and "ğŸš« No Team (Free For All)" or tn
            local f = Card(tT, 30); f.Name = "TeamItem"
            local dot = Instance.new("Frame", f); dot.Size = UD2(0, 7, 0, 7); dot.Position = UD2(0, 7, 0.5, -3.5); dot.BackgroundColor3 = td.Color; dot.BorderSizePixel = 0; Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
            local nl = Instance.new("TextLabel", f); nl.Size = UD2(0.45, 0, 1, 0); nl.Position = UD2(0, 18, 0, 0); nl.BackgroundTransparency = 1; nl.Text = dn; nl.Font = Enum.Font.Gotham; nl.TextSize = 8; nl.TextColor3 = VN.Chu; nl.TextXAlignment = Enum.TextXAlignment.Left
            local mb = Instance.new("TextButton", f); mb.Size = UD2(0, 62, 0, 18); mb.Position = UD2(1, -70, 0.5, -9); mb.Text = mL[td.Mode]; mb.TextColor3 = Color3.new(1,1,1); mb.Font = Enum.Font.GothamBold; mb.TextSize = 8; mb.BackgroundColor3 = mC[td.Mode]; mb.BorderSizePixel = 0; mb.AutoButtonColor = false; Instance.new("UICorner", mb).CornerRadius = UDim.new(0, 4)
            mb.MouseButton1Click:Connect(function() td.Mode = (td.Mode + 1) % 3; mb.Text = mL[td.Mode]; TwSpring(mb, {BackgroundColor3 = mC[td.Mode]}, 0.15); ForceRecalcAll() end)
        end
    end
    RenderTeams()

    -- TAB HITBOX
    Section(tH, "ğŸ“¦ HITBOX")
    Toggle(tH, "ğŸ”¥ Báº­t Hitbox", Cfg.HB.On, function(v) Cfg.HB.On = v; if not v then for _, p in ipairs(Players:GetPlayers()) do if p ~= LP then RestoreHitbox(p.UserId) end end end; ForceRecalcAll() end, VN.Do)
    Section(tH, "âš™ï¸ CÃ€I Äáº¶T")
    Slider(tH, "KÃ­ch thÆ°á»›c", 5, 35, Cfg.HB.Size, 0, function(v) Cfg.HB.Size = v end)
    Slider(tH, "Trong suá»‘t", 0, 1, Cfg.HB.Trans, 2, function(v) Cfg.HB.Trans = v end)
    Slider(tH, "KC tá»‘i Ä‘a", 50, 350, Cfg.HB.MaxD, 0, function(v) Cfg.HB.MaxD = v; ForceRecalcAll() end)

    -- TAB ESP
    Section(tE, "ğŸ‘ ESP")
    Toggle(tE, "ğŸ”¥ Báº­t ESP", Cfg.ESP.On, function(v) Cfg.ESP.On = v; ForceRecalcAll() end, VN.Do)
    Toggle(tE, "ğŸŒ«ï¸ Má» theo KC", Cfg.ESP.Fade, function(v) Cfg.ESP.Fade = v end)
    Section(tE, "ğŸ“Š HIá»‚N THá»Š")
    Toggle(tE, "âœ¨ Highlight", Cfg.ESP.HL, function(v) Cfg.ESP.HL = v end, VN.Vang)
    Toggle(tE, "ğŸ“› TÃªn", Cfg.ESP.Name, function(v) Cfg.ESP.Name = v end, VN.AnToan)
    Toggle(tE, "ğŸ”« VÅ© khÃ­ + Score", Cfg.ESP.Wpn, function(v) Cfg.ESP.Wpn = v end, VN.CanhBao)
    Toggle(tE, "ğŸ“ Khoáº£ng cÃ¡ch", Cfg.ESP.Dist, function(v) Cfg.ESP.Dist = v end)
    Toggle(tE, "â¤ï¸ HP", Cfg.ESP.HP, function(v) Cfg.ESP.HP = v end, VN.NguyHiem)
    Toggle(tE, "ğŸ—ºï¸ Zone (Safe/Combat)", Cfg.ESP.Zone, function(v) Cfg.ESP.Zone = v end, VN.CanhBao)
    Slider(tE, "KC tá»‘i Ä‘a", 100, 1200, Cfg.ESP.MaxD, 0, function(v) Cfg.ESP.MaxD = v; ForceRecalcAll() end)

    -- FLOAT BUTTON
    local Fl = Instance.new("TextButton", Gui); Fl.Size = UD2(0, 40, 0, 40); Fl.Position = UD2(0, 8, 0.35, 0); Fl.BackgroundColor3 = VN.Do; Fl.Text = "â˜…"; Fl.TextColor3 = VN.Vang; Fl.Font = Enum.Font.GothamBlack; Fl.TextSize = 16; Fl.BorderSizePixel = 0; Fl.ZIndex = 50; Fl.AutoButtonColor = false; Instance.new("UICorner", Fl).CornerRadius = UDim.new(1, 0); Instance.new("UIStroke", Fl).Color = VN.Vang
    local fd, fds, fps_pos = false, nil, nil
    Fl.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then fd = true; fds = i.Position; fps_pos = Fl.Position end end)
    Fl.InputChanged:Connect(function(i) if fd and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then local d = i.Position - fds; Fl.Position = UD2(fps_pos.X.Scale, fps_pos.X.Offset + d.X, fps_pos.Y.Scale, fps_pos.Y.Offset + d.Y) end end)
    Fl.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then if fds then local d = i.Position - fds; if abs(d.X) < 10 and abs(d.Y) < 10 then Main.Visible = not Main.Visible end end; fd = false end end)

    task.spawn(function() local big = true; while Fl.Parent do if big then TwSpring(Fl, {TextSize=20, Rotation=5}, 0.4) else TwSpring(Fl, {TextSize=16, Rotation=-5}, 0.4) end; big = not big; task.wait(0.5) end end)

    table.insert(Conns, UIS.InputBegan:Connect(function(i, gp) if gp then return end; if i.KeyCode == Enum.KeyCode.RightControl or i.KeyCode == Enum.KeyCode.F6 then Main.Visible = not Main.Visible end end))
    return SLbl, RenderTeams
end

local SLbl, RenderTeams = BuildUI()

-- Cáº­p nháº­t Team liÃªn tá»¥c (Báº£o Ä‘áº£m khÃ´ng sÃ³t FFA)
local function SyncTeams()
    for _, t in ipairs(Teams:GetChildren()) do
        if t:IsA("Team") and not Cfg.Team[t.Name] then Cfg.Team[t.Name] = {Mode=0, Color=t.TeamColor.Color} end
    end
    Cfg.Team["__NO_TEAM__"] = Cfg.Team["__NO_TEAM__"] or {Mode=0, Color=Color3.new(1,1,1)}
    if RenderTeams then RenderTeams() end
end

SyncTeams()
table.insert(Conns, Teams.ChildAdded:Connect(SyncTeams))

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- MAIN LOOP (HEARTBEAT)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
local fc, fps, lft, lup = 0, 60, tick(), 0
table.insert(Conns, RS.Heartbeat:Connect(function()
    local now = tick(); local dt = now - lft; lft = now
    fps = fps * 0.9 + (1/max(dt, 0.001)) * 0.1
    if (now - lup) < 0.1 then return end; lup = now

    local tc = 0
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LP then continue end
        local pd, upd = UpdatePlayer(player, now)

        if not pd.alive then
            if OrigSizes[player.UserId] then RestoreHitbox(player.UserId) end
            if HBViz[player.UserId] and HBViz[player.UserId]:FindFirstChild("Box") then HBViz[player.UserId].Box.Adornee = nil end
            if ESPViz[player.UserId] then
                if ESPViz[player.UserId]:FindFirstChild("HL") then ESPViz[player.UserId].HL.Enabled = false end
                if ESPViz[player.UserId]:FindFirstChild("BG") then ESPViz[player.UserId].BG.Enabled = false end
            end
            continue
        end

        if upd then UpdateHitbox(player, pd); UpdateHBViz(player, pd); UpdateESP(player, pd) end
        if pd.target then tc += 1 end
    end

    fc += 1
    if fc % 10 == 0 and SLbl and SLbl.Parent then
        local ft = {}
        if Cfg.HB.On then table.insert(ft, "HB") end
        if Cfg.ESP.On then table.insert(ft, "ESP") end
        local fs = #ft > 0 and table.concat(ft, "Â·") or "Táº®T"
        SLbl.Text = string.format("ğŸ‡»ğŸ‡³ %s | ğŸ¯ %d | âš¡ %.0f", fs, tc, fps)
        SLbl.TextColor3 = tc > 0 and VN.Vang or VN.ChuMo
    end
end))

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CLEANUP
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
_G._FlowKill = function()
    for _, c in ipairs(Conns) do pcall(function() c:Disconnect() end) end
    for _, p in ipairs(Players:GetPlayers()) do pcall(function() RestoreHitbox(p.UserId) end) end
    if VR then VR:Destroy() end
    pcall(function() CoreGui:FindFirstChild("Flow_Premium_v66"):Destroy() end)
end

print("ğŸ‡»ğŸ‡³ FLOW v6.6 PREMIUM - THUáº¬T TOÃN Há»ŒC THUáº¬T ÄÆ¯á»¢C KÃCH HOáº T")
