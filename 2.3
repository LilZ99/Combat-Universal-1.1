if _G._FlowKill then pcall(_G._FlowKill) end

--[[
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•    â•šâ•â•â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â•â•â•â•â•    â•šâ•â•â•â•â•â•â•â•
    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•             â–ˆâ–ˆâ•—  
    â•šâ•â•     â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•šâ•â•â•       â•šâ•â•â•â•              â•šâ•â•  
    
    â˜… FLOW v6.3 â€” BALANCED EDITION â˜…
    â˜… 90% Features + Smooth Performance â˜…
    â˜… ğŸ‡»ğŸ‡³ Há»’NG LONG VIá»†T NAM ğŸ‰ â˜…
]]

local Players = game:GetService("Players")
local RS = game:GetService("RunService")
local TS = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Teams = game:GetService("Teams")
local UIS = game:GetService("UserInputService")
local CS = game:GetService("CollectionService")
local LP = Players.LocalPlayer
local Cam = workspace.CurrentCamera

for _, n in ipairs({"Flow_Loading","Flow_VN_v5","Flow_VN_v51","Flow_VN_v52","Flow_VN_v53","Flow_VN_v54","Flow_VN_v6","Flow_VN_v61","Flow_VN_v62","Flow_VN_v63","Elysium_VR","HongLong_VR"}) do
    pcall(function() CoreGui:FindFirstChild(n):Destroy() end)
end

local V3, CF, C3, UD2 = Vector3.new, CFrame.new, Color3.fromRGB, UDim2.new
local abs, min, max, floor, clamp = math.abs, math.min, math.max, math.floor, math.clamp
local random, tick = math.random, tick

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ THEME ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
local VN = {
    Do = C3(218,37,29), DoSang = C3(255,60,50), DoTham = C3(150,20,15),
    Vang = C3(255,203,5), VangSang = C3(255,235,100), VangKim = C3(255,215,0),
    Nen = C3(12,6,6), NenNhat = C3(25,12,12), Vien = C3(80,30,25),
    AnToan = C3(34,197,94), NguyHiem = C3(239,68,68), CanhBao = C3(251,191,36), DacBiet = C3(180,100,255),
    Chu = C3(252,248,244), ChuMo = C3(148,118,112), ChuToi = C3(100,78,75),
}

local function Tw(o,p,t) if not o or not o.Parent then return end; pcall(function() TS:Create(o,TweenInfo.new(t or 0.25,Enum.EasingStyle.Quint,Enum.EasingDirection.Out),p):Play() end) end
local function TwSpring(o,p,t) if not o or not o.Parent then return end; pcall(function() TS:Create(o,TweenInfo.new(t or 0.35,Enum.EasingStyle.Back,Enum.EasingDirection.Out),p):Play() end) end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ LOADING NHANH ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
do
    local L = Instance.new("ScreenGui",CoreGui); L.Name="Flow_Loading"; L.IgnoreGuiInset=true; L.DisplayOrder=9999
    local BG = Instance.new("Frame",L); BG.Size=UD2(1,0,1,0); BG.BackgroundColor3=VN.DoTham; BG.BorderSizePixel=0
    local Card = Instance.new("Frame",BG); Card.Size=UD2(0,320,0,200); Card.Position=UD2(0.5,-160,0.5,-100); Card.BackgroundColor3=VN.Nen; Card.BorderSizePixel=0
    Instance.new("UICorner",Card).CornerRadius=UDim.new(0,16); Instance.new("UIStroke",Card).Color=VN.Do
    local Flag = Instance.new("Frame",Card); Flag.Size=UD2(0,56,0,36); Flag.Position=UD2(0.5,-28,0,14); Flag.BackgroundColor3=VN.Do; Flag.BorderSizePixel=0
    Instance.new("UICorner",Flag).CornerRadius=UDim.new(0,4)
    local Star = Instance.new("TextLabel",Flag); Star.Size=UD2(1,0,1,0); Star.BackgroundTransparency=1; Star.Text="â˜…"; Star.TextColor3=VN.Vang; Star.TextSize=22; Star.Font=Enum.Font.GothamBlack
    local Title = Instance.new("TextLabel",Card); Title.Size=UD2(1,0,0,28); Title.Position=UD2(0,0,0,55); Title.BackgroundTransparency=1; Title.Text="âš¡ FLOW v6.3"; Title.Font=Enum.Font.GothamBlack; Title.TextSize=20; Title.TextColor3=VN.Vang
    local Sub = Instance.new("TextLabel",Card); Sub.Size=UD2(1,0,0,16); Sub.Position=UD2(0,0,0,82); Sub.BackgroundTransparency=1; Sub.Text="ğŸ‰ BALANCED EDITION ğŸ‰"; Sub.Font=Enum.Font.GothamBold; Sub.TextSize=10; Sub.TextColor3=VN.VangSang
    local PBCont = Instance.new("Frame",Card); PBCont.Size=UD2(0.7,0,0,12); PBCont.Position=UD2(0.15,0,0,115); PBCont.BackgroundColor3=C3(30,12,12); PBCont.BorderSizePixel=0
    Instance.new("UICorner",PBCont).CornerRadius=UDim.new(0,6)
    local PBFill = Instance.new("Frame",PBCont); PBFill.Size=UD2(0,0,1,0); PBFill.BackgroundColor3=VN.Do; PBFill.BorderSizePixel=0
    Instance.new("UICorner",PBFill).CornerRadius=UDim.new(0,6)
    Instance.new("UIGradient",PBFill).Color=ColorSequence.new{ColorSequenceKeypoint.new(0,VN.Do),ColorSequenceKeypoint.new(0.5,VN.DoSang),ColorSequenceKeypoint.new(1,VN.Vang)}
    local Status = Instance.new("TextLabel",Card); Status.Size=UD2(1,0,0,14); Status.Position=UD2(0,0,0,138); Status.BackgroundTransparency=1; Status.Font=Enum.Font.GothamMedium; Status.TextSize=9; Status.TextColor3=VN.ChuMo
    local Pct = Instance.new("TextLabel",Card); Pct.Size=UD2(1,0,0,18); Pct.Position=UD2(0,0,0,155); Pct.BackgroundTransparency=1; Pct.Font=Enum.Font.GothamBlack; Pct.TextSize=16; Pct.TextColor3=VN.Vang
    local Footer = Instance.new("TextLabel",Card); Footer.Size=UD2(1,0,0,12); Footer.Position=UD2(0,0,1,-18); Footer.BackgroundTransparency=1; Footer.Text="ğŸ‡»ğŸ‡³ Vinh quang Viá»‡t Nam ğŸ‡»ğŸ‡³"; Footer.Font=Enum.Font.GothamMedium; Footer.TextSize=8; Footer.TextColor3=VN.ChuMo
    task.spawn(function()
        local steps={{0,"Khá»Ÿi Ä‘á»™ng..."},{25,"Real Hitbox..."},{50,"Zone Engine..."},{75,"Weapon AI..."},{100,"âœ… XONG!"}}
        for _,s in ipairs(steps) do Status.Text=s[2]; Pct.Text=s[1].."%"; Tw(PBFill,{Size=UD2(s[1]/100,0,1,0)},0.12); task.wait(0.15) end
        task.wait(0.15); Tw(BG,{BackgroundTransparency=1},0.2); Tw(Card,{BackgroundTransparency=1},0.2); task.wait(0.25); L:Destroy()
    end)
end
task.wait(1.1)

-- â•â•â•â•â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•
local Cfg = {
    NhamTatCa = false,
    Team = {},
    HB = {On=false, Size=15, Trans=0.85, Wall=false, MaxD=350, Adaptive=true},  -- â˜… GIá»® Adaptive
    ESP = {On=false, Fade=true, NearD=50, FarD=500, MaxD=1200, HL=true, Name=true, Dist=true, HP=true, Wpn=true, Status=true},
    Perf = {UpdateRate=0.1, Budget=5},  -- â˜… 10 FPS, 5 players/tick
}

local RealHitboxes, HBViz, ESPViz, PData, ZoneStates, ZonePartsCache = {},{},{},{},{},{}
local Conns = {}
local VR = Instance.new("Folder",CoreGui); VR.Name="HongLong_VR"

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ§  WEAPON AI (OPTIMIZED + ACCURATE) â•â•â•â•â•â•â•â•â•â•â•
local WPN_CACHE = {}

local WPN_PATTERNS = {
    "gun","pistol","rifle","shotgun","sniper","smg","lmg","rpg","launcher",
    "ak","glock","deagle","m4","m16","mp5","mp7","uzi","vector","scar","famas","aug","awp","m24","barrett",
    "knife","sword","blade","katana","machete","axe","dagger","karambit","bowie",
    "revolver","magnum","desert","eagle","beretta","colt","usp","p90","mac10","mac11",
    "minigun","gatling","turret","cannon","laser","plasma","ray","blaster",
    "sung","dao","kiem","bom","vukhi","sungtruong",
    "weapon","firearm","combat","tactical","military","assault","auto","semi",
    "p250","tec9","fiveseven","cz75","negev","m249","pkm","rpk",
    "kar98","mosin","springfield","dragunov","intervention","l96",
    "spas","benelli","mossberg","remington","saiga",
    "thompson","sten","mp40","ppsh","grease",
    "crossbow","bow","arrow","throwing","grenade","explosive","mine","c4",
}

local WPN_PARTS = {"muzzle","barrel","trigger","magazine","scope","sight","bolt","grip","stock","blade","handle","chamber","receiver","rail"}
local WPN_SOUNDS = {"shoot","fire","gun","reload","shot","bang","blast","slash","swing","attack","hit","impact"}
local WPN_SAFE = {"shovel","hoe","seed","fish","rod","bucket","wrench","paint","key","flashlight","camera","phone","medkit","food","money","book","map","instrument","guitar","toy","ball","flower","plant","furniture"}

local function FastMatch(str, list)
    for i=1,#list do if str:find(list[i],1,true) then return true end end
    return false
end

local function AnalyzeWeapon(tool)
    if not tool or not tool:IsA("Tool") then return false,0,"none" end
    
    local cached = WPN_CACHE[tool]
    if cached and (tick()-cached.t) < 15 then return cached.w,cached.s,cached.y end
    
    local name = tool.Name:lower():gsub("[%-%_%.%s]","")
    
    if FastMatch(name, WPN_SAFE) then
        WPN_CACHE[tool] = {w=false,s=0,y="safe",t=tick()}
        return false,0,"safe"
    end
    
    local score = 0
    local wtype = "unknown"
    
    -- Name check (HIGH WEIGHT)
    if FastMatch(name, WPN_PATTERNS) then
        score = score + 40
        if name:find("sniper") or name:find("awp") or name:find("barrett") or name:find("dragunov") then wtype="sniper"
        elseif name:find("shot") or name:find("pump") or name:find("spas") then wtype="shotgun"
        elseif name:find("knife") or name:find("sword") or name:find("blade") or name:find("katana") or name:find("axe") then wtype="melee"
        elseif name:find("launch") or name:find("rpg") or name:find("rocket") or name:find("grenade") then wtype="launcher"
        elseif name:find("smg") or name:find("mp5") or name:find("mp7") or name:find("uzi") or name:find("p90") then wtype="smg"
        elseif name:find("lmg") or name:find("m249") or name:find("minigun") or name:find("pkm") then wtype="lmg"
        else wtype="gun" end
    end
    
    -- Descendant check (LIMITED to 30)
    local ok,descs = pcall(function() return tool:GetDescendants() end)
    if ok then
        local count = 0
        for _,d in ipairs(descs) do
            if count > 30 then break end
            count = count + 1
            local dn = d.Name:lower()
            if d:IsA("BasePart") or d:IsA("Attachment") then
                if FastMatch(dn, WPN_PARTS) then score=score+7 end
            elseif d:IsA("Sound") then
                if FastMatch(dn, WPN_SOUNDS) then score=score+9 end
            elseif d:IsA("RemoteEvent") or d:IsA("RemoteFunction") then
                if dn:find("fire") or dn:find("shoot") or dn:find("attack") or dn:find("damage") or dn:find("hit") then score=score+8 end
            elseif d:IsA("Animation") then
                if dn:find("shoot") or dn:find("fire") or dn:find("reload") or dn:find("aim") or dn:find("attack") then score=score+6 end
            end
        end
    end
    
    -- Handle shape
    local handle = tool:FindFirstChild("Handle")
    if handle and handle:IsA("BasePart") then
        local s = handle.Size
        local ratio = max(s.X,s.Y,s.Z) / max(min(s.X,s.Y,s.Z),0.1)
        if ratio > 3 then score=score+5 end
        if ratio > 5 then score=score+3 end
    end
    
    -- â˜… THRESHOLD 12 (very low = detect almost all weapons)
    local isW = score >= 12
    if isW and wtype=="unknown" then wtype="weapon" end
    
    WPN_CACHE[tool] = {w=isW,s=score,y=wtype,t=tick()}
    return isW,score,wtype
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ—ºï¸ ZONE ENGINE (BALANCED â€” FAST + ACCURATE) â•â•â•â•â•â•â•â•â•â•â•
local ZONE_SAFE, ZONE_GRACE, ZONE_COMBAT = 1, 2, 3
local GRACE_TIME = 6  -- â˜… 6 seconds grace period (shorter but exists)
local ZoneCache = {}

local SAFE_KEYS = {"safe","safezone","insafe","inlobby","inspawn","protected","nopvp","immune","invulnerable","peaceful","inbase","inhome","spawn"}

-- â˜… SMART ZONE PARTS CACHE: Scan workspace ONCE per player spawn
local function CacheZoneParts()
    if ZonePartsCache.cached then return end
    ZonePartsCache.parts = {}
    
    -- â˜… LIMITED scan: only named folders/models
    local searchIn = {workspace}
    local folders = {"SafeZones","Zones","Spawns","Lobby","Safe","Protected"}
    for _,fname in ipairs(folders) do
        local f = workspace:FindFirstChild(fname)
        if f then table.insert(searchIn, f) end
    end
    
    local count = 0
    for _,container in ipairs(searchIn) do
        local ok,children = pcall(function() return container:GetChildren() end)
        if ok then
            for _,part in ipairs(children) do
                if count > 50 then break end  -- â˜… LIMIT 50 parts
                if part:IsA("BasePart") and part.Anchored then
                    local pn = part.Name:lower()
                    if FastMatch(pn, SAFE_KEYS) then
                        table.insert(ZonePartsCache.parts, part)
                        count = count + 1
                    end
                end
            end
        end
    end
    
    ZonePartsCache.cached = true
    ZonePartsCache.time = tick()
end

local function CheckSafeZone(player)
    local char = player.Character
    if not char then return false end
    
    local uid = player.UserId
    local cached = ZoneCache[uid]
    if cached and (tick()-cached.t) < 0.5 then return cached.r end  -- â˜… 0.5s cache
    
    -- ForceField
    if char:FindFirstChildOfClass("ForceField") then
        ZoneCache[uid] = {r=true,t=tick()}
        return true
    end
    
    -- Attributes
    for _,tgt in ipairs({player, char}) do
        local ok,attrs = pcall(function() return tgt:GetAttributes() end)
        if ok and attrs then
            for name,val in pairs(attrs) do
                if FastMatch(name:lower(), SAFE_KEYS) then
                    if val==true or (type(val)=="number" and val>0) then
                        ZoneCache[uid] = {r=true,t=tick()}
                        return true
                    end
                end
            end
        end
    end
    
    -- Values
    for _,tgt in ipairs({player, char}) do
        local ok,children = pcall(function() return tgt:GetChildren() end)
        if ok then
            for _,obj in ipairs(children) do
                if obj:IsA("BoolValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") then
                    if FastMatch(obj.Name:lower(), SAFE_KEYS) then
                        local vok,vv = pcall(function() return obj.Value end)
                        if vok and ((obj:IsA("BoolValue") and vv==true) or ((obj:IsA("IntValue") or obj:IsA("NumberValue")) and vv>0)) then
                            ZoneCache[uid] = {r=true,t=tick()}
                            return true
                        end
                    end
                end
            end
        end
    end
    
    -- Tags
    for _,tgt in ipairs({player, char}) do
        local ok,tags = pcall(function() return CS:GetTags(tgt) end)
        if ok then
            for _,tag in ipairs(tags) do
                if FastMatch(tag:lower(), SAFE_KEYS) then
                    ZoneCache[uid] = {r=true,t=tick()}
                    return true
                end
            end
        end
    end
    
    -- â˜… ZONE GEOMETRY CHECK (using cached parts)
    local root = char:FindFirstChild("HumanoidRootPart")
    if root and ZonePartsCache.parts then
        local pos = root.Position
        for _,part in ipairs(ZonePartsCache.parts) do
            if part and part.Parent then
                local cf,sz = part.CFrame, part.Size/2
                local lp = cf:PointToObjectSpace(pos)
                if abs(lp.X)<=sz.X+2 and abs(lp.Y)<=sz.Y+4 and abs(lp.Z)<=sz.Z+2 then
                    ZoneCache[uid] = {r=true,t=tick()}
                    return true
                end
            end
        end
    end
    
    ZoneCache[uid] = {r=false,t=tick()}
    return false
end

-- â˜… ZONE STATE with GRACE PERIOD
local function UpdateZoneState(uid, isSafe, now)
    local prev = ZoneStates[uid] or {state=ZONE_COMBAT, at=now}
    local newState = prev.state
    local graceRemain = 0
    
    if isSafe then
        newState = ZONE_SAFE
    elseif prev.state == ZONE_SAFE then
        newState = ZONE_GRACE
    elseif prev.state == ZONE_GRACE then
        local elapsed = now - prev.at
        if elapsed >= GRACE_TIME then
            newState = ZONE_COMBAT
        else
            graceRemain = GRACE_TIME - elapsed
        end
    else
        newState = ZONE_COMBAT
    end
    
    local changed = newState ~= prev.state
    ZoneStates[uid] = {
        state = newState,
        at = changed and now or prev.at,
        grace = graceRemain
    }
    
    return newState, graceRemain
end

-- â•â•â•â•â•â•â•â•â•â•â• UTILITIES â•â•â•â•â•â•â•â•â•â•â•
local function MyRoot() local c=LP.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function GetDist(root) local mr=MyRoot(); if not mr or not root then return 9999 end; return (mr.Position-root.Position).Magnitude end
local function HPColor(r) r=clamp(r,0,1); if r>0.6 then return VN.AnToan elseif r>0.3 then return VN.CanhBao else return VN.NguyHiem end end

local function ShouldTarget(player, pd)
    if player==LP then return false end
    if Cfg.NhamTatCa then return true end
    
    local key = player.Team and player.Team.Name or "__NO_TEAM__"
    local cfg = Cfg.Team[key] or Cfg.Team["__NO_TEAM__"]
    
    if not cfg then return true end
    if cfg.Mode==0 then return false end
    if cfg.Mode==1 then return true end
    if cfg.Mode==2 then
        -- â˜… Target if: threat OR combat OR grace
        return pd.isThreat or pd.zone==ZONE_COMBAT or pd.zone==ZONE_GRACE
    end
    
    return true
end

-- â•â•â•â•â•â•â•â•â•â•â• PLAYER DATA â•â•â•â•â•â•â•â•â•â•â•
local function GetPD(uid)
    if not PData[uid] then
        PData[uid] = {
            lastUpdate=0, alive=false, target=false,
            hbOn=false, espOn=false, dist=9999,
            zone=ZONE_COMBAT, graceRemain=0, inSafe=false,
            threat=0, isThreat=false,
            weapon=nil, weaponType=nil, weaponScore=0,
            hp=100, maxHp=100, hpRatio=1,
            espCache={},
        }
    end
    return PData[uid]
end

local function UpdatePlayer(player, now)
    local uid = player.UserId
    local pd = GetPD(uid)
    
    -- â˜… Adaptive rate: gáº§n = 0.08s, xa = 0.15s
    local rate = pd.dist < 100 and 0.08 or pd.dist < 250 and 0.12 or 0.18
    if (now - pd.lastUpdate) < rate then return pd, false end
    pd.lastUpdate = now
    
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    pd.alive = char~=nil and hum~=nil and hum.Health>0
    
    if not pd.alive then
        pd.target=false; pd.hbOn=false; pd.espOn=false
        return pd, true
    end
    
    local root = char:FindFirstChild("HumanoidRootPart")
    pd.dist = GetDist(root)
    pd.hp = hum.Health
    pd.maxHp = max(hum.MaxHealth, 1)
    pd.hpRatio = clamp(pd.hp/pd.maxHp, 0, 1)
    
    -- Zone
    local isSafe = CheckSafeZone(player)
    pd.zone, pd.graceRemain = UpdateZoneState(uid, isSafe, now)
    pd.inSafe = isSafe
    
    -- Threat
    local threat = 0
    if pd.zone==ZONE_COMBAT then threat=threat+25
    elseif pd.zone==ZONE_GRACE then threat=threat+15 end
    
    local tool = char:FindFirstChildOfClass("Tool")
    if tool then
        local isW,wsc,wtype = AnalyzeWeapon(tool)
        pd.weapon = tool.Name
        pd.weaponType = wtype
        pd.weaponScore = wsc
        if isW then threat=threat+45 end
    else
        pd.weapon=nil; pd.weaponType=nil; pd.weaponScore=0
    end
    
    pd.threat = threat
    pd.isThreat = threat >= 25
    
    pd.target = ShouldTarget(player, pd)
    
    pd.hbOn = Cfg.HB.On and pd.target and pd.dist<=Cfg.HB.MaxD and not pd.inSafe
    pd.espOn = Cfg.ESP.On and pd.target and pd.dist<=Cfg.ESP.MaxD
    
    return pd, true
end

local function ForceRecalcAll()
    for uid,pd in pairs(PData) do pd.lastUpdate=0; pd.espCache={} end
    WPN_CACHE={}; ZoneCache={}; ZoneStates={}
    ZonePartsCache.cached = false  -- Re-scan zone parts
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ“¦ REAL HITBOX (100% DAMAGE) â•â•â•â•â•â•â•â•â•â•â•
local function DestroyRealHitbox(uid)
    if RealHitboxes[uid] then
        pcall(function() RealHitboxes[uid]:Destroy() end)
        RealHitboxes[uid] = nil
    end
end

local function CreateRealHitbox(player, size)
    local char = player.Character
    if not char then return end
    
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local uid = player.UserId
    DestroyRealHitbox(uid)
    
    local hb = Instance.new("Part")
    hb.Name = "FlowHitbox_v63"
    hb.Size = V3(size, size, size)
    hb.Transparency = 0.92
    hb.Color = C3(255, 50, 50)
    hb.Material = Enum.Material.ForceField
    hb.CanCollide = false
    hb.CanTouch = false
    hb.CanQuery = true  -- â˜… CRITICAL
    hb.Massless = true
    hb.Anchored = false
    hb.CastShadow = false
    hb.Parent = char
    
    local weld = Instance.new("WeldConstraint")
    weld.Part0 = hb
    weld.Part1 = root
    weld.Parent = hb
    
    hb.CFrame = root.CFrame
    RealHitboxes[uid] = hb
end

local function ApplyHitbox(player, pd)
    local uid = player.UserId
    
    if not pd.hbOn or not pd.alive then
        DestroyRealHitbox(uid)
        return
    end
    
    -- â˜… ADAPTIVE SIZE
    local size = Cfg.HB.Size
    if Cfg.HB.Adaptive then
        local distFactor = clamp((pd.dist - 20) / 200, 0.7, 1.5)
        size = floor(size * distFactor)
        size = clamp(size, 8, 45)
    end
    
    local existing = RealHitboxes[uid]
    if existing and existing.Parent then
        if abs(existing.Size.X - size) > 2 then
            existing.Size = V3(size, size, size)
        end
        return
    end
    
    CreateRealHitbox(player, size)
end

-- â•â•â•â•â•â•â•â•â•â•â• HITBOX VIZ â•â•â•â•â•â•â•â•â•â•â•
local function EnsureHBViz(uid)
    if HBViz[uid] and HBViz[uid].Parent then return HBViz[uid] end
    local f = Instance.new("Folder",VR); f.Name="HB_"..uid
    local sb = Instance.new("SelectionBox",f); sb.Name="Box"; sb.LineThickness=0.03
    HBViz[uid] = f; return f
end

local function UpdateHBViz(player, pd)
    local uid = player.UserId
    if not pd.hbOn or not pd.alive then
        local f = HBViz[uid]; if f then local sb=f:FindFirstChild("Box"); if sb then sb.Adornee=nil end end
        return
    end
    local f = EnsureHBViz(uid); local sb = f:FindFirstChild("Box")
    local hb = RealHitboxes[uid]
    if not sb or not hb or not hb.Parent then return end
    
    local col
    if pd.zone==ZONE_SAFE then col=VN.ChuMo
    elseif pd.zone==ZONE_GRACE then col=VN.CanhBao
    elseif pd.isThreat then col=VN.NguyHiem
    else col=VN.Vang end
    
    sb.Adornee = hb
    sb.Color3 = col; sb.SurfaceColor3 = col; sb.SurfaceTransparency = Cfg.HB.Trans
end

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‘ï¸ ESP â•â•â•â•â•â•â•â•â•â•â•
local function EnsureESP(uid)
    if ESPViz[uid] and ESPViz[uid].Parent then return ESPViz[uid] end
    local f = Instance.new("Folder",VR); f.Name="ESP_"..uid
    local hl = Instance.new("Highlight",f); hl.Name="HL"; hl.DepthMode=Enum.HighlightDepthMode.AlwaysOnTop; hl.Enabled=false
    local bg = Instance.new("BillboardGui",f); bg.Name="BG"; bg.AlwaysOnTop=true; bg.Size=UD2(0,160,0,105); bg.StudsOffset=V3(0,3,0); bg.MaxDistance=1500; bg.Enabled=false
    local ct = Instance.new("Frame",bg); ct.Name="CT"; ct.Size=UD2(1,0,1,0); ct.BackgroundTransparency=1
    local ly = Instance.new("UIListLayout",ct); ly.HorizontalAlignment=Enum.HorizontalAlignment.Center; ly.Padding=UDim.new(0,2)
    local function ML(nm,ord,h,sz) local l=Instance.new("TextLabel",ct); l.Name=nm; l.LayoutOrder=ord; l.Size=UD2(1,0,0,h); l.BackgroundTransparency=1; l.Font=Enum.Font.GothamBold; l.TextSize=sz; l.TextStrokeTransparency=0; l.TextStrokeColor3=C3(0,0,0); l.RichText=true; l.Text="" end
    ML("NL",1,15,12); ML("SL",2,13,9); ML("WL",3,13,10); ML("DL",4,13,11); ML("HL2",5,11,9)
    local hpBg = Instance.new("Frame",ct); hpBg.Name="HPBg"; hpBg.LayoutOrder=6; hpBg.Size=UD2(0.65,0,0,5); hpBg.BackgroundColor3=C3(30,10,10); hpBg.BorderSizePixel=0; Instance.new("UICorner",hpBg).CornerRadius=UDim.new(1,0)
    local hpF = Instance.new("Frame",hpBg); hpF.Name="HPF"; hpF.Size=UD2(1,0,1,0); hpF.BackgroundColor3=VN.AnToan; hpF.BorderSizePixel=0; Instance.new("UICorner",hpF).CornerRadius=UDim.new(1,0)
    ESPViz[uid] = f; return f
end

local function UpdateESP(player, pd)
    local uid = player.UserId
    if not pd.espOn or not pd.alive then
        local f = ESPViz[uid]; if f then
            local hl=f:FindFirstChild("HL"); if hl then hl.Enabled=false end
            local bg=f:FindFirstChild("BG"); if bg then bg.Enabled=false end
        end; return
    end
    local f = EnsureESP(uid); local char = player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    local cache = pd.espCache
    local tool = char:FindFirstChildOfClass("Tool")
    local toolName = tool and tool.Name or ""
    if cache.hp==floor(pd.hp) and cache.zone==pd.zone and cache.weapon==toolName and abs((cache.dist or 0)-pd.dist)<20 then return end
    cache.hp=floor(pd.hp); cache.zone=pd.zone; cache.weapon=toolName; cache.dist=pd.dist
    
    local dist = pd.dist
    local fade = Cfg.ESP.Fade and clamp((dist-Cfg.ESP.NearD)/max(Cfg.ESP.FarD-Cfg.ESP.NearD,1),0,1) or 0
    local hpC = HPColor(pd.hpRatio)
    local baseCol
    if pd.zone==ZONE_SAFE then baseCol=VN.ChuMo
    elseif pd.zone==ZONE_GRACE then baseCol=VN.CanhBao
    elseif pd.isThreat then baseCol=VN.NguyHiem
    else baseCol=VN.Vang end
    local tf = max(fade*0.5,0.08)
    
    local hl = f:FindFirstChild("HL")
    if hl and Cfg.ESP.HL then
        hl.Enabled=true; hl.Adornee=char; hl.FillColor=baseCol
        hl.OutlineColor=pd.isThreat and VN.NguyHiem or VN.Vang
        hl.FillTransparency=max(0.15,fade*0.6); hl.OutlineTransparency=fade*0.5
    elseif hl then hl.Enabled=false end
    
    local bg = f:FindFirstChild("BG"); if bg then bg.Adornee=root; bg.Enabled=true end
    local ct = bg and bg:FindFirstChild("CT"); if not ct then return end
    local function SL(nm,txt,col) local l=ct:FindFirstChild(nm); if l then l.Text=txt; if col then l.TextColor3=col end; l.TextTransparency=tf; l.Visible=txt~="" end end
    
    if Cfg.ESP.Name then
        local tag = pd.isThreat and string.format(' <font color="#FF5050">[%d]</font>',floor(pd.threat)) or ""
        SL("NL",string.format("<b>%s</b>%s",player.Name,tag),baseCol)
    else SL("NL","") end
    
    if Cfg.ESP.Status then
        local status = ""
        if pd.zone==ZONE_SAFE then status='<font color="#888">ğŸ›¡ï¸ AN TOÃ€N</font>'
        elseif pd.zone==ZONE_GRACE then status=string.format('<font color="#FF8800">â±ï¸ GRACE %.0fs</font>',pd.graceRemain)
        elseif pd.zone==ZONE_COMBAT then status='<font color="#AA66FF">âš”ï¸ CHIáº¾N Äáº¤U</font>' end
        SL("SL",status)
    else SL("SL","") end
    
    if Cfg.ESP.Wpn and pd.weapon then
        local wIcon = pd.weaponType=="sniper" and "ğŸ”­" or pd.weaponType=="shotgun" and "ğŸ’¥" or pd.weaponType=="melee" and "ğŸ—¡ï¸" or pd.weaponType=="launcher" and "ğŸš€" or pd.weaponType=="smg" and "ğŸ”«" or pd.weaponType=="lmg" and "âš™ï¸" or "ğŸ”«"
        local wColor = pd.weaponScore>=30 and "#FF4400" or pd.weaponScore>=15 and "#FF8800" or "#888"
        SL("WL",string.format('<font color="%s">%s %s</font>',wColor,wIcon,pd.weapon))
    else SL("WL","") end
    
    if Cfg.ESP.Dist then SL("DL",string.format("%.0f m",dist),VN.AnToan:Lerp(VN.NguyHiem,clamp(dist/Cfg.ESP.MaxD,0,1)))
    else SL("DL","") end
    
    if Cfg.ESP.HP then
        local hpHex = string.format("#%02X%02X%02X",floor(hpC.R*255),floor(hpC.G*255),floor(hpC.B*255))
        SL("HL2",string.format('<font color="%s">%.0f/%.0f</font>',hpHex,pd.hp,pd.maxHp))
    else SL("HL2","") end
    
    local hpBg2 = ct:FindFirstChild("HPBg"); local hpFill = hpBg2 and hpBg2:FindFirstChild("HPF")
    if hpBg2 and Cfg.ESP.HP then hpBg2.Visible=true; if hpFill then hpFill.Size=UD2(pd.hpRatio,0,1,0); hpFill.BackgroundColor3=hpC end
    elseif hpBg2 then hpBg2.Visible=false end
end

-- â•â•â•â•â•â•â•â•â•â•â• CLEANUP â•â•â•â•â•â•â•â•â•â•â•
local function FullCleanup(player)
    local uid = player.UserId
    DestroyRealHitbox(uid)
    PData[uid]=nil; ZoneStates[uid]=nil; ZoneCache[uid]=nil
end

local function HideVisuals(uid)
    local hb = HBViz[uid]; if hb then local sb=hb:FindFirstChild("Box"); if sb then sb.Adornee=nil end end
    local esp = ESPViz[uid]; if esp then local hl=esp:FindFirstChild("HL"); if hl then hl.Enabled=false end; local bg=esp:FindFirstChild("BG"); if bg then bg.Enabled=false end end
end

local function HookPlayer(player)
    table.insert(Conns, player.CharacterAdded:Connect(function()
        local uid = player.UserId
        DestroyRealHitbox(uid); HideVisuals(uid)
        local pd = GetPD(uid); pd.lastUpdate=0; pd.espCache={}
        ZonePartsCache.cached = false  -- Re-scan zones on respawn
    end))
    table.insert(Conns, player.CharacterRemoving:Connect(function() FullCleanup(player) end))
end

local function SyncTeams()
    for _,t in ipairs(Teams:GetChildren()) do
        if t:IsA("Team") and not Cfg.Team[t.Name] then Cfg.Team[t.Name]={Mode=0,Color=t.TeamColor.Color} end
    end
    Cfg.Team["__NO_TEAM__"] = Cfg.Team["__NO_TEAM__"] or {Mode=0, Color=Color3.new(1,1,1)}
end
SyncTeams()
table.insert(Conns, Teams.ChildAdded:Connect(SyncTeams))
for _,p in ipairs(Players:GetPlayers()) do HookPlayer(p) end
table.insert(Conns, Players.PlayerAdded:Connect(HookPlayer))
table.insert(Conns, Players.PlayerRemoving:Connect(function(p)
    FullCleanup(p); local uid=p.UserId
    if HBViz[uid] then pcall(function() HBViz[uid]:Destroy() end); HBViz[uid]=nil end
    if ESPViz[uid] then pcall(function() ESPViz[uid]:Destroy() end); ESPViz[uid]=nil end
end))

-- Cache zone parts on start
CacheZoneParts()

-- â•â•â•â•â•â•â•â•â•â•â• ğŸ‡»ğŸ‡³ UI VIá»†T NAM ğŸ‡»ğŸ‡³ â•â•â•â•â•â•â•â•â•â•â•
local function BuildUI()
    local Gui = Instance.new("ScreenGui",CoreGui); Gui.Name="Flow_VN_v63"; Gui.ResetOnSpawn=false; Gui.ZIndexBehavior=Enum.ZIndexBehavior.Sibling; Gui.DisplayOrder=100
    
    local Main = Instance.new("Frame",Gui); Main.Name="Main"; Main.Size=UD2(0,345,0,470); Main.Position=UD2(0.5,-172,0.5,-235)
    Main.BackgroundColor3=VN.Nen; Main.BorderSizePixel=0; Main.Active=true; Main.Draggable=true; Main.ClipsDescendants=true; Main.Visible=false
    Instance.new("UICorner",Main).CornerRadius=UDim.new(0,14); Instance.new("UIStroke",Main).Color=VN.Do
    Instance.new("UIGradient",Main).Color=ColorSequence.new{ColorSequenceKeypoint.new(0,C3(18,9,9)),ColorSequenceKeypoint.new(1,C3(10,5,5))}
    
    -- Header
    local Hdr = Instance.new("Frame",Main); Hdr.Size=UD2(1,0,0,46); Hdr.BackgroundColor3=VN.Do; Hdr.BorderSizePixel=0
    Instance.new("UICorner",Hdr).CornerRadius=UDim.new(0,14)
    local HFix = Instance.new("Frame",Hdr); HFix.Size=UD2(1,0,0,14); HFix.Position=UD2(0,0,1,-14); HFix.BackgroundColor3=VN.Do; HFix.BorderSizePixel=0
    Instance.new("UIGradient",Hdr).Color=ColorSequence.new{ColorSequenceKeypoint.new(0,VN.Do),ColorSequenceKeypoint.new(0.5,VN.DoSang),ColorSequenceKeypoint.new(1,VN.Do)}
    local FI = Instance.new("TextLabel",Hdr); FI.Size=UD2(0,22,0,22); FI.Position=UD2(0,9,0.5,-11); FI.BackgroundTransparency=1; FI.Text="ğŸ‡»ğŸ‡³"; FI.TextSize=16
    local TL = Instance.new("TextLabel",Hdr); TL.Size=UD2(1,-85,0,20); TL.Position=UD2(0,35,0,6); TL.BackgroundTransparency=1; TL.Text="âš¡ FLOW v6.3"; TL.Font=Enum.Font.GothamBlack; TL.TextSize=15; TL.TextColor3=VN.Vang; TL.TextXAlignment=Enum.TextXAlignment.Left
    local ST = Instance.new("TextLabel",Hdr); ST.Size=UD2(0,120,0,11); ST.Position=UD2(0,35,0,26); ST.BackgroundTransparency=1; ST.Text="ğŸ‰ BALANCED"; ST.Font=Enum.Font.GothamMedium; ST.TextSize=8; ST.TextColor3=VN.VangSang; ST.TextXAlignment=Enum.TextXAlignment.Left
    local CB = Instance.new("TextButton",Hdr); CB.Size=UD2(0,24,0,24); CB.Position=UD2(1,-32,0.5,-12); CB.Text="âœ•"; CB.TextColor3=VN.Vang; CB.Font=Enum.Font.GothamBold; CB.TextSize=12; CB.BackgroundColor3=VN.DoTham; CB.BorderSizePixel=0; CB.AutoButtonColor=false
    Instance.new("UICorner",CB).CornerRadius=UDim.new(0,6)
    CB.MouseButton1Click:Connect(function() Main.Visible=false end)
    
    -- Tab Bar
    local TB = Instance.new("Frame",Main); TB.Size=UD2(1,-10,0,32); TB.Position=UD2(0,5,0,50); TB.BackgroundColor3=VN.NenNhat; TB.BorderSizePixel=0
    Instance.new("UICorner",TB).CornerRadius=UDim.new(0,8); Instance.new("UIStroke",TB).Color=VN.Vien
    local tbLy = Instance.new("UIListLayout",TB); tbLy.FillDirection=Enum.FillDirection.Horizontal; tbLy.HorizontalAlignment=Enum.HorizontalAlignment.Center; tbLy.VerticalAlignment=Enum.VerticalAlignment.Center; tbLy.Padding=UDim.new(0,3)
    
    local Content = Instance.new("Frame",Main); Content.Size=UD2(1,-10,1,-122); Content.Position=UD2(0,5,0,86); Content.BackgroundTransparency=1; Content.ClipsDescendants=true
    
    local SBar = Instance.new("Frame",Main); SBar.Size=UD2(1,-10,0,24); SBar.Position=UD2(0,5,1,-30); SBar.BackgroundColor3=VN.NenNhat; SBar.BorderSizePixel=0
    Instance.new("UICorner",SBar).CornerRadius=UDim.new(0,6); Instance.new("UIStroke",SBar).Color=VN.Vien
    local SLbl = Instance.new("TextLabel",SBar); SLbl.Size=UD2(1,-8,1,0); SLbl.Position=UD2(0,4,0,0); SLbl.BackgroundTransparency=1; SLbl.Text="ğŸ‡»ğŸ‡³ FLOW v6.3 â€” Sáºµn sÃ ng!"; SLbl.Font=Enum.Font.GothamMedium; SLbl.TextSize=9; SLbl.TextColor3=VN.ChuMo; SLbl.TextXAlignment=Enum.TextXAlignment.Left
    
    local tabs = {}
    local function MkScroll()
        local s = Instance.new("ScrollingFrame",Content); s.Size=UD2(1,0,1,0); s.BackgroundTransparency=1; s.AutomaticCanvasSize=Enum.AutomaticSize.Y
        s.ScrollBarThickness=3; s.ScrollBarImageColor3=VN.Do; s.BorderSizePixel=0; s.Visible=false; s.CanvasSize=UD2(0,0,0,0)
        local ly = Instance.new("UIListLayout",s); ly.Padding=UDim.new(0,4); ly.SortOrder=Enum.SortOrder.LayoutOrder
        Instance.new("UIPadding",s).PaddingTop=UDim.new(0,3)
        return s
    end
    local function MkTab(nm,ic)
        local btn = Instance.new("TextButton",TB); btn.Size=UD2(0,98,0,26); btn.Text=ic.." "..nm; btn.Font=Enum.Font.GothamBold; btn.TextSize=10; btn.TextColor3=VN.ChuToi
        btn.BackgroundColor3=VN.Nen; btn.BackgroundTransparency=0.5; btn.BorderSizePixel=0; btn.AutoButtonColor=false
        Instance.new("UICorner",btn).CornerRadius=UDim.new(0,6)
        local ind = Instance.new("Frame",btn); ind.Size=UD2(0.35,0,0,2.5); ind.Position=UD2(0.325,0,1,-3); ind.BackgroundColor3=VN.Vang; ind.BorderSizePixel=0; ind.Visible=false
        Instance.new("UICorner",ind).CornerRadius=UDim.new(1,0)
        local scr = MkScroll(); tabs[nm]={btn=btn,ind=ind,scroll=scr}
        btn.MouseButton1Click:Connect(function()
            for n,d in pairs(tabs) do local a=(n==nm); d.scroll.Visible=a; d.ind.Visible=a
                Tw(d.btn,{TextColor3=a and VN.Vang or VN.ChuToi, BackgroundColor3=a and C3(55,22,20) or VN.Nen, BackgroundTransparency=a and 0.1 or 0.5},0.16)
            end
        end)
        return scr
    end
    
    local function Card(p,h) local f=Instance.new("Frame",p); f.Size=UD2(1,-4,0,h or 36); f.BackgroundColor3=VN.NenNhat; f.BackgroundTransparency=0.15; f.BorderSizePixel=0; Instance.new("UICorner",f).CornerRadius=UDim.new(0,8); return f end
    local function Section(p,t) local f=Card(p,22); f.BackgroundColor3=C3(55,20,16); local l=Instance.new("TextLabel",f); l.Size=UD2(1,-10,1,0); l.Position=UD2(0,5,0,0); l.BackgroundTransparency=1; l.Text=t; l.Font=Enum.Font.GothamBold; l.TextSize=9; l.TextColor3=VN.Vang; l.TextXAlignment=Enum.TextXAlignment.Left end
    local function Toggle(p,lbl,init,cb,col)
        col=col or VN.Do; local f=Card(p,36)
        local txt=Instance.new("TextLabel",f); txt.Size=UD2(1,-55,1,0); txt.Position=UD2(0,8,0,0); txt.BackgroundTransparency=1; txt.Text=lbl; txt.Font=Enum.Font.Gotham; txt.TextSize=10; txt.TextColor3=init and VN.Chu or VN.ChuMo; txt.TextXAlignment=Enum.TextXAlignment.Left
        local trk=Instance.new("Frame",f); trk.Size=UD2(0,38,0,18); trk.Position=UD2(1,-46,0.5,-9); trk.BackgroundColor3=init and col or C3(50,35,35); trk.BorderSizePixel=0; Instance.new("UICorner",trk).CornerRadius=UDim.new(1,0)
        local thb=Instance.new("Frame",trk); thb.Size=UD2(0,12,0,12); thb.Position=init and UD2(1,-15,0.5,-6) or UD2(0,3,0.5,-6); thb.BackgroundColor3=init and Color3.new(1,1,1) or C3(150,130,130); thb.BorderSizePixel=0; Instance.new("UICorner",thb).CornerRadius=UDim.new(1,0)
        local on=init; local btn=Instance.new("TextButton",f); btn.Size=UD2(1,0,1,0); btn.BackgroundTransparency=1; btn.Text=""; btn.ZIndex=5
        btn.MouseButton1Click:Connect(function() on=not on; TwSpring(trk,{BackgroundColor3=on and col or C3(50,35,35)},0.16); TwSpring(thb,{Position=on and UD2(1,-15,0.5,-6) or UD2(0,3,0.5,-6),BackgroundColor3=on and Color3.new(1,1,1) or C3(150,130,130)},0.16); Tw(txt,{TextColor3=on and VN.Chu or VN.ChuMo},0.12); cb(on) end)
    end
    local function Slider(p,lbl,mn,mx,def,dp,cb)
        local f=Card(p,44)
        local txt=Instance.new("TextLabel",f); txt.Size=UD2(0.55,0,0,14); txt.Position=UD2(0,8,0,4); txt.BackgroundTransparency=1; txt.Text=lbl; txt.Font=Enum.Font.Gotham; txt.TextSize=9; txt.TextColor3=VN.ChuMo; txt.TextXAlignment=Enum.TextXAlignment.Left
        local vt=Instance.new("TextLabel",f); vt.Size=UD2(0.38,0,0,14); vt.Position=UD2(0.6,0,0,4); vt.BackgroundTransparency=1; vt.Text=tostring(def); vt.Font=Enum.Font.GothamBold; vt.TextSize=10; vt.TextColor3=VN.Vang; vt.TextXAlignment=Enum.TextXAlignment.Right
        local trk=Instance.new("Frame",f); trk.Size=UD2(1,-16,0,6); trk.Position=UD2(0,8,0,28); trk.BackgroundColor3=C3(40,18,18); trk.BorderSizePixel=0; Instance.new("UICorner",trk).CornerRadius=UDim.new(1,0)
        local fill=Instance.new("Frame",trk); fill.Size=UD2((def-mn)/max(mx-mn,1),0,1,0); fill.BackgroundColor3=VN.Do; fill.BorderSizePixel=0; Instance.new("UICorner",fill).CornerRadius=UDim.new(1,0)
        Instance.new("UIGradient",fill).Color=ColorSequence.new{ColorSequenceKeypoint.new(0,VN.Do),ColorSequenceKeypoint.new(0.6,VN.DoSang),ColorSequenceKeypoint.new(1,VN.Vang)}
        local thb=Instance.new("TextButton",trk); thb.Size=UD2(0,12,0,12); thb.Position=UD2((def-mn)/max(mx-mn,1),-6,0.5,-6); thb.BackgroundColor3=VN.Vang; thb.Text=""; thb.BorderSizePixel=0; thb.ZIndex=5; Instance.new("UICorner",thb).CornerRadius=UDim.new(1,0)
        local prec=10^dp; local drag=false
        local function upd(ix) local tw=trk.AbsoluteSize.X; if tw<=0 then return end; local rel=clamp((ix-trk.AbsolutePosition.X)/tw,0,1); local v=floor((mn+(mx-mn)*rel)*prec+0.5)/prec; Tw(fill,{Size=UD2(rel,0,1,0)},0.05); Tw(thb,{Position=UD2(rel,-6,0.5,-6)},0.05); vt.Text=tostring(v); cb(v) end
        thb.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then drag=true end end)
        trk.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then drag=true; upd(i.Position.X) end end)
        UIS.InputChanged:Connect(function(i) if drag and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then upd(i.Position.X) end end)
        UIS.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then drag=false end end)
    end
    local function InfoCard(p,t,c) local f=Card(p,42); f.BackgroundColor3=C3(12,18,12); local l=Instance.new("TextLabel",f); l.Size=UD2(1,-10,1,-4); l.Position=UD2(0,5,0,2); l.BackgroundTransparency=1; l.Text=t; l.Font=Enum.Font.Gotham; l.TextSize=8; l.TextColor3=c or VN.AnToan; l.TextXAlignment=Enum.TextXAlignment.Left; l.TextWrapped=true; l.RichText=true end
    
    -- Create Tabs
    local tT = MkTab("Má»¤C TIÃŠU","ğŸ¯"); local tH = MkTab("HITBOX","ğŸ“¦"); local tE = MkTab("ESP","ğŸ‘")
    tabs["Má»¤C TIÃŠU"].scroll.Visible=true; tabs["Má»¤C TIÃŠU"].ind.Visible=true; tabs["Má»¤C TIÃŠU"].btn.TextColor3=VN.Vang; tabs["Má»¤C TIÃŠU"].btn.BackgroundColor3=C3(55,22,20); tabs["Má»¤C TIÃŠU"].btn.BackgroundTransparency=0.1
    
    -- TAB: Má»¤C TIÃŠU
    Section(tT,"ğŸ¯ CHáº¾ Äá»˜ NHáº®M")
    Toggle(tT,"âš¡ Nháº¯m Táº¤T Cáº¢",Cfg.NhamTatCa,function(v) Cfg.NhamTatCa=v; ForceRecalcAll() end,VN.NguyHiem)
    Section(tT,"ğŸ´ TEAM â€” Táº®T â†’ Táº¤T Cáº¢ â†’ ÄE Dá»ŒA")
    InfoCard(tT,'<font color="#FF5050">ğŸ”´ Táº®T</font> <font color="#50FF50">ğŸŸ¢ Táº¤T Cáº¢</font> <font color="#FFAA00">ğŸŸ  ÄE Dá»ŒA</font> (vÅ© khÃ­/zone)',C3(180,220,160))
    local mL={[0]="Táº®T",[1]="Táº¤T Cáº¢",[2]="ÄE Dá»ŒA"}; local mC={[0]=C3(70,50,50),[1]=VN.AnToan,[2]=VN.CanhBao}
    for tn,td in pairs(Cfg.Team) do
        local dn=tn=="__NO_TEAM__" and "ğŸš« KhÃ´ng Team" or tn; local f=Card(tT,34)
        local dot=Instance.new("Frame",f); dot.Size=UD2(0,8,0,8); dot.Position=UD2(0,8,0.5,-4); dot.BackgroundColor3=td.Color; dot.BorderSizePixel=0; Instance.new("UICorner",dot).CornerRadius=UDim.new(1,0)
        local nl=Instance.new("TextLabel",f); nl.Size=UD2(0.45,0,1,0); nl.Position=UD2(0,20,0,0); nl.BackgroundTransparency=1; nl.Text=dn; nl.Font=Enum.Font.Gotham; nl.TextSize=9; nl.TextColor3=VN.Chu; nl.TextXAlignment=Enum.TextXAlignment.Left
        local mb=Instance.new("TextButton",f); mb.Size=UD2(0,68,0,20); mb.Position=UD2(1,-76,0.5,-10); mb.Text=mL[td.Mode]; mb.TextColor3=Color3.new(1,1,1); mb.Font=Enum.Font.GothamBold; mb.TextSize=8; mb.BackgroundColor3=mC[td.Mode]; mb.BorderSizePixel=0; mb.AutoButtonColor=false; Instance.new("UICorner",mb).CornerRadius=UDim.new(0,5)
        mb.MouseButton1Click:Connect(function() td.Mode=(td.Mode+1)%3; mb.Text=mL[td.Mode]; TwSpring(mb,{BackgroundColor3=mC[td.Mode]},0.16); ForceRecalcAll() end)
    end
    
    -- TAB: HITBOX
    Section(tH,"ğŸ“¦ REAL HITBOX")
    Toggle(tH,"ğŸ”¥ Báº­t Hitbox",Cfg.HB.On,function(v) Cfg.HB.On=v; ForceRecalcAll() end,VN.Do)
    Toggle(tH,"ğŸ§± Kiá»ƒm tra tÆ°á»ng",Cfg.HB.Wall,function(v) Cfg.HB.Wall=v; ForceRecalcAll() end)
    Toggle(tH,"ğŸ“ Adaptive Size",Cfg.HB.Adaptive,function(v) Cfg.HB.Adaptive=v end,VN.DacBiet)
    Section(tH,"âš™ï¸ CÃ€I Äáº¶T")
    Slider(tH,"KÃ­ch thÆ°á»›c",5,40,Cfg.HB.Size,0,function(v) Cfg.HB.Size=v end)
    Slider(tH,"Trong suá»‘t",0,1,Cfg.HB.Trans,2,function(v) Cfg.HB.Trans=v end)
    Slider(tH,"KC tá»‘i Ä‘a",50,400,Cfg.HB.MaxD,0,function(v) Cfg.HB.MaxD=v; ForceRecalcAll() end)
    InfoCard(tH,'â˜… Real Part + Weld = 100% damage\nâ˜… Adaptive: xa=to, gáº§n=nhá»\nğŸŸ¡ BÃ¬nh thÆ°á»ng ğŸŸ  Grace ğŸ”´ Äe dá»a',C3(180,200,160))
    
    -- TAB: ESP
    Section(tE,"ğŸ‘ ESP")
    Toggle(tE,"ğŸ”¥ Báº­t ESP",Cfg.ESP.On,function(v) Cfg.ESP.On=v; ForceRecalcAll() end,VN.Do)
    Toggle(tE,"ğŸŒ«ï¸ Má» theo KC",Cfg.ESP.Fade,function(v) Cfg.ESP.Fade=v end)
    Section(tE,"ğŸ“Š HIá»‚N THá»Š")
    Toggle(tE,"âœ¨ Highlight",Cfg.ESP.HL,function(v) Cfg.ESP.HL=v end,VN.Vang)
    Toggle(tE,"ğŸ“› TÃªn + Threat",Cfg.ESP.Name,function(v) Cfg.ESP.Name=v end,VN.AnToan)
    Toggle(tE,"ğŸ”« VÅ© khÃ­",Cfg.ESP.Wpn,function(v) Cfg.ESP.Wpn=v end,VN.CanhBao)
    Toggle(tE,"ğŸ“ Khoáº£ng cÃ¡ch",Cfg.ESP.Dist,function(v) Cfg.ESP.Dist=v end)
    Toggle(tE,"â¤ï¸ HP",Cfg.ESP.HP,function(v) Cfg.ESP.HP=v end,VN.NguyHiem)
    Toggle(tE,"ğŸ—ºï¸ Zone + Grace",Cfg.ESP.Status,function(v) Cfg.ESP.Status=v end,VN.CanhBao)
    Slider(tE,"KC tá»‘i Ä‘a",100,1500,Cfg.ESP.MaxD,0,function(v) Cfg.ESP.MaxD=v; ForceRecalcAll() end)
    
    -- Float Button
    local Fl=Instance.new("TextButton",Gui); Fl.Size=UD2(0,42,0,42); Fl.Position=UD2(0,8,0.35,0); Fl.BackgroundColor3=VN.Do; Fl.Text="â˜…"; Fl.TextColor3=VN.Vang; Fl.Font=Enum.Font.GothamBlack; Fl.TextSize=18; Fl.BorderSizePixel=0; Fl.ZIndex=50; Fl.AutoButtonColor=false
    Instance.new("UICorner",Fl).CornerRadius=UDim.new(1,0); Instance.new("UIStroke",Fl).Color=VN.Vang
    local fg=Instance.new("UIGradient",Fl); fg.Color=ColorSequence.new{ColorSequenceKeypoint.new(0,VN.Do),ColorSequenceKeypoint.new(0.5,VN.DoSang),ColorSequenceKeypoint.new(1,VN.Do)}; fg.Rotation=45
    local fd,fds,fps=false,nil,nil
    Fl.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then fd=true; fds=i.Position; fps=Fl.Position end end)
    Fl.InputChanged:Connect(function(i) if fd and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then local d=i.Position-fds; Fl.Position=UD2(fps.X.Scale,fps.X.Offset+d.X,fps.Y.Scale,fps.Y.Offset+d.Y) end end)
    Fl.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then if fds then local d=i.Position-fds; if abs(d.X)<10 and abs(d.Y)<10 then Main.Visible=not Main.Visible end end; fd=false end end)
    task.spawn(function() local big=true; while Fl.Parent do if big then TwSpring(Fl,{TextSize=22,Rotation=5},0.5) else TwSpring(Fl,{TextSize=18,Rotation=-5},0.5) end; big=not big; task.wait(0.6) end end)
    task.spawn(function() local rot=0; while Fl.Parent do rot=(rot+3)%360; fg.Rotation=rot; task.wait(0.04) end end)
    table.insert(Conns,UIS.InputBegan:Connect(function(i,gp) if gp then return end; if i.KeyCode==Enum.KeyCode.RightControl or i.KeyCode==Enum.KeyCode.F6 then Main.Visible=not Main.Visible end end))
    
    return SLbl
end
local SLbl = BuildUI()

-- â•â•â•â•â•â•â•â•â•â•â• MAIN LOOP (BALANCED: 10 FPS, 5 players) â•â•â•â•â•â•â•â•â•â•â•
local fc,fps,lft,lup,pIdx = 0,60,tick(),0,1

local heartbeat = RS.Heartbeat:Connect(function()
    local now = tick()
    local dt = now-lft; lft = now
    fps = fps*0.9 + (1/max(dt,0.001))*0.1
    
    -- â˜… 10 FPS update (0.1s)
    if (now-lup) < Cfg.Perf.UpdateRate then return end
    lup = now
    
    local allP = Players:GetPlayers()
    local op = {}
    for _,p in ipairs(allP) do if p~=LP then table.insert(op,p) end end
    
    -- â˜… SIMPLE DISTANCE SORT (optimized)
    local mr = MyRoot()
    if mr and #op > 1 then
        table.sort(op, function(a,b)
            local cA,cB = a.Character, b.Character
            if not cA then return false end
            if not cB then return true end
            local rA = cA:FindFirstChild("HumanoidRootPart")
            local rB = cB:FindFirstChild("HumanoidRootPart")
            if not rA then return false end
            if not rB then return true end
            return (rA.Position-mr.Position).Magnitude < (rB.Position-mr.Position).Magnitude
        end)
    end
    
    -- â˜… Process 5 players/tick
    local budget = min(#op, Cfg.Perf.Budget)
    local tc = 0
    
    for i=1,budget do
        local p = op[i]
        if not p then continue end
        
        local pd,upd = UpdatePlayer(p, now)
        if not pd.alive then
            DestroyRealHitbox(p.UserId)
            HideVisuals(p.UserId)
            continue
        end
        
        if upd then
            ApplyHitbox(p, pd)
            UpdateHBViz(p, pd)
            UpdateESP(p, pd)
        end
        
        if pd.target then tc=tc+1 end
    end
    
    fc = fc+1
    if fc%12==0 and SLbl and SLbl.Parent then
        local ft={}
        if Cfg.HB.On then table.insert(ft,"HB") end
        if Cfg.ESP.On then table.insert(ft,"ESP") end
        if Cfg.HB.Adaptive then table.insert(ft,"ADT") end
        local fs = #ft>0 and table.concat(ft,"Â·") or "Táº®T"
        SLbl.Text = string.format("ğŸ‡»ğŸ‡³ %s | ğŸ¯ %d | âš¡ %.0f",fs,tc,fps)
        SLbl.TextColor3 = tc>0 and VN.Vang or VN.ChuMo
    end
end)
table.insert(Conns, heartbeat)

-- â•â•â•â•â•â•â•â•â•â•â• KILL SWITCH â•â•â•â•â•â•â•â•â•â•â•
_G._FlowKill = function()
    for _,c in ipairs(Conns) do pcall(function() c:Disconnect() end) end; Conns={}
    for _,p in ipairs(Players:GetPlayers()) do if p~=LP then FullCleanup(p) end end
    if VR and VR.Parent then VR:Destroy() end
    pcall(function() CoreGui:FindFirstChild("Flow_VN_v63"):Destroy() end)
    WPN_CACHE={}; ZoneCache={}; ZoneStates={}; ZonePartsCache={}
    print("ğŸ‡»ğŸ‡³ [FLOW v6.3] âœ… ÄÃ£ dá»n dáº¹p!")
end

print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("ğŸ‡»ğŸ‡³ FLOW v6.3 â€” BALANCED EDITION ğŸ‰")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("âœ… 90% Features + Smooth Performance")
print("âœ… Real Hitbox: 100% damage tá»« má»i gÃ³c")
print("âœ… Adaptive Size: xa=to, gáº§n=nhá»")
print("âœ… Grace Period: 6s countdown")
print("âœ… Zone Geometry: cached scan")
print("âœ… Weapon: threshold 12 (detect gáº§n háº¿t)")
print("âœ… Distance Sort: Æ°u tiÃªn gáº§n")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
print("â˜… Nháº¥n â˜… Ä‘á»ƒ má»Ÿ | Hotkey: RightCtrl / F6")
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
